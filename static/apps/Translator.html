<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traductor Cient√≠fico Privado - Bioestad√≠stica Edu</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --bg: #050505; --panel: #111; --accent: #22c55e; --text: #e2e8f0; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { max-width: 900px; width: 100%; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: -1px; margin-bottom: 10px; }
        .status-tag { font-size: 0.7rem; background: #1e293b; padding: 4px 12px; border-radius: 20px; color: var(--accent); border: 1px solid var(--accent); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .box { background: var(--panel); border: 1px solid #222; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
        label { font-size: 0.75rem; color: #666; text-transform: uppercase; margin-bottom: 10px; font-weight: bold; }
        
        textarea { background: transparent; border: none; color: white; resize: none; height: 300px; font-size: 1rem; line-height: 1.6; outline: none; }
        #output { color: #cbd5e1; overflow-y: auto; border-left: 1px solid #222; padding-left: 15px; }

        .controls { margin-top: 20px; display: flex; gap: 15px; align-items: center; background: #111; padding: 15px; border-radius: 12px; border: 1px solid #222; }
        .btn { background: var(--accent); color: black; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:disabled { background: #1e293b; color: #475569; cursor: wait; }
        
        .progress-container { width: 100%; background: #222; height: 4px; border-radius: 2px; margin-top: 20px; display: none; }
        #progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        #status-msg { font-size: 0.8rem; color: #888; margin-top: 10px; text-align: center; }

        .pdf-zone { border: 1px dashed #333; padding: 15px; border-radius: 8px; text-align: center; font-size: 0.8rem; cursor: pointer; }
        footer { margin-top: auto; padding: 40px 0; text-align: center; font-size: 0.8rem; color: #444; border-top: 1px solid #111; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Bio-Translator <span style="color:var(--accent)">AI</span></h1>
        <span class="status-tag" id="model-status">Cargando motor de IA...</span>
    </header>

    <div class="pdf-zone" onclick="document.getElementById('pdfInput').click()">
        üìÑ Subir PDF Cient√≠fico para extraer texto
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none">
    </div>

    <div class="grid">
        <div class="box">
            <label>Ingl√©s (Original)</label>
            <textarea id="input-text" placeholder="Pega aqu√≠ el abstract o texto cient√≠fico..."></textarea>
        </div>
        <div class="box">
            <label>Espa√±ol (Traducci√≥n IA)</label>
            <div id="output">La traducci√≥n aparecer√° aqu√≠ conforme se procese...</div>
        </div>
    </div>

    <div class="progress-container" id="progress-container">
        <div id="progress-bar"></div>
    </div>
    <div id="status-msg">Iniciando...</div>

    <div class="controls">
        <select id="lang-select" style="background:#222; color:white; border:1px solid #333; padding:10px; border-radius:8px;">
            <option value="spa_Latn">A Espa√±ol</option>
            <option value="eng_Latn">A Ingl√©s</option>
        </select>
        <button class="btn" id="translate-btn" disabled>TRADUCIR AHORA</button>
    </div>
</div>

<footer>
    Autor: <strong>Maicel Monz√≥n P√©rez</strong> | Bioestad√≠stica Edu<br>
    Tecnolog√≠a: NLLB-200 Neural Machine Translation (Local Execution)
</footer>

<script type="module">
    // Importamos Transformers.js desde un CDN de m√≥dulos
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

    const inputArea = document.getElementById('input-text');
    const outputArea = document.getElementById('output');
    const btn = document.getElementById('translate-btn');
    const statusTag = document.getElementById('model-status');
    const statusMsg = document.getElementById('status-msg');
    const progressBar = document.getElementById('progress-bar');
    const progressContainer = document.getElementById('progress-container');

    let translator;

    // Inicializar el modelo
    async function init() {
        try {
            progressContainer.style.display = 'block';
            translator = await pipeline('translation', 'Xenova/nllb-200-distilled-600M', {
                progress_callback: (p) => {
                    if (p.status === 'downloading') {
                        const progress = p.progress.toFixed(2);
                        statusMsg.innerText = `Descargando IA profesional (${progress}%)...`;
                        progressBar.style.width = `${progress}%`;
                    }
                    if (p.status === 'ready') {
                        statusMsg.innerText = "IA lista para trabajar offline.";
                        statusTag.innerText = "MODELO CARGADO";
                        btn.disabled = false;
                        progressContainer.style.display = 'none';
                    }
                }
            });
        } catch (e) {
            statusMsg.innerText = "Error cargando la IA. Revisa tu conexi√≥n.";
            console.error(e);
        }
    }

    // Traducci√≥n
    btn.onclick = async () => {
        const text = inputArea.value;
        if (!text) return;

        btn.disabled = true;
        btn.innerText = "Traduciendo...";
        outputArea.innerText = "Procesando...";

        // NLLB usa c√≥digos de lenguaje espec√≠ficos (spa_Latn para espa√±ol)
        const targetLang = document.getElementById('lang-select').value;

        try {
            // Dividimos por p√°rrafos para no saturar la memoria
            const paragraphs = text.split('\n').filter(p => p.trim() !== '');
            let fullTranslation = "";

            for (let i = 0; i < paragraphs.length; i++) {
                statusMsg.innerText = `Traduciendo p√°rrafo ${i+1} de ${paragraphs.length}...`;
                const result = await translator(paragraphs[i], {
                    src_lang: targetLang === 'spa_Latn' ? 'eng_Latn' : 'spa_Latn',
                    tgt_lang: targetLang,
                });
                fullTranslation += result[0].translation_text + "\n\n";
                outputArea.innerText = fullTranslation;
            }
            statusMsg.innerText = "Traducci√≥n completada con √©xito.";
        } catch (e) {
            statusMsg.innerText = "Error durante la traducci√≥n.";
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "TRADUCIR AHORA";
        }
    };

    // Manejo de PDF
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    document.getElementById('pdfInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        statusMsg.innerText = "Extrayendo texto del PDF...";
        const reader = new FileReader();
        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ") + "\n";
            }
            inputArea.value = fullText;
            statusMsg.innerText = "Texto del PDF extra√≠do. Listo para traducir.";
        };
        reader.readAsArrayBuffer(file);
    };

    init();
</script>

</body>
</html>