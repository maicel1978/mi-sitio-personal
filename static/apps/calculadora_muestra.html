<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SampleSize Pro v4 â€” Calculadora Muestral Regulatoria</title>
    <style>
        :root {
            --primary: #1a365d; --primary-light: #2c5282; --accent: #2b6cb0;
            --success: #276749; --success-bg: #f0fff4; --success-border: #9ae6b4;
            --warning-bg: #fffaf0; --warning-border: #fbd38d;
            --danger: #c53030; --danger-bg: #fff5f5; --danger-border: #feb2b2;
            --info-bg: #ebf8ff; --info-border: #90cdf4;
            --bg: #f7fafc; --text: #2d3748; --text-light: #718096; --border: #e2e8f0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: var(--text); line-height: 1.6; }
        .container { max-width: 960px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 26px 38px; position: relative; }
        .header h1 { font-size: 1.5rem; font-weight: 800; }
        .header .sub { font-size: 0.8rem; opacity: 0.85; margin-top: 2px; }
        .header .badge { position: absolute; top: 14px; right: 20px; background: rgba(255,255,255,0.15); padding: 3px 10px; border-radius: 20px; font-size: 0.66rem; }
        .body-c { padding: 26px 38px 38px; }
        .note { background: var(--info-bg); border: 1px solid var(--info-border); border-radius: 9px; padding: 13px 16px; margin-bottom: 22px; font-size: 0.76rem; color: #2a4365; }
        .note strong { color: var(--primary); }
        .sec { margin-bottom: 22px; }
        .sec-t { font-size: 0.72rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1.2px; color: var(--accent); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #edf2f7; display: flex; align-items: center; gap: 6px; }
        .sec-t .st { background: var(--accent); color: white; width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.66rem; font-weight: 700; }
        .g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 13px; }
        .g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 13px; }
        .sf { grid-column: 1 / -1; }
        .f label { display: block; font-weight: 700; font-size: 0.74rem; margin-bottom: 3px; color: #4a5568; }
        .f label .u { font-weight: 400; color: var(--text-light); font-size: 0.68rem; }
        .f input, .f select { width: 100%; padding: 9px 11px; border: 2px solid var(--border); border-radius: 7px; font-size: 0.9rem; transition: all 0.2s; background: white; }
        .f input:focus, .f select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(43,108,176,0.15); }
        .f input.err { border-color: var(--danger); }
        .f .ht { font-size: 0.66rem; color: var(--text-light); margin-top: 2px; }
        .f .em { font-size: 0.68rem; color: var(--danger); margin-top: 2px; display: none; font-weight: 600; }
        .f .em.v { display: block; }
        .tip { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; background: var(--border); color: var(--text-light); font-size: 0.56rem; font-weight: 800; cursor: help; position: relative; margin-left: 3px; vertical-align: middle; }
        .tip:hover::after { content: attr(data-t); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: #1a202c; color: white; padding: 6px 10px; border-radius: 6px; font-size: 0.64rem; font-weight: 400; white-space: normal; max-width: 240px; z-index: 100; line-height: 1.3; min-width: 160px; text-align: left; }
        .adv-btn { background: none; border: 1px dashed var(--border); padding: 7px 13px; border-radius: 6px; cursor: pointer; font-size: 0.74rem; color: var(--accent); font-weight: 600; width: 100%; margin-bottom: 13px; transition: all 0.2s; }
        .adv-btn:hover { background: var(--info-bg); }
        .adv-p { display: none; background: #fafbfc; border: 1px solid var(--border); border-radius: 9px; padding: 15px; margin-bottom: 13px; }
        .adv-p.open { display: block; }
        .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; width: 100%; padding: 14px; border: none; border-radius: 9px; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(26,54,93,0.3); }
        #res { display: none; margin-top: 26px; }
        .rh { background: var(--success-bg); border: 1px solid var(--success-border); border-radius: 11px; padding: 20px; margin-bottom: 20px; }
        .rg { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 13px; margin-bottom: 13px; }
        .rc { text-align: center; padding: 13px; border-radius: 8px; background: white; border: 1px solid var(--border); }
        .rc .rl { font-size: 0.66rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 3px; }
        .rc .rv { font-size: 1.6rem; font-weight: 800; color: var(--primary); }
        .rc.cf { border-color: var(--success-border); }
        .rc.cf .rv { color: var(--success); font-size: 2rem; }
        .eb { background: white; border-radius: 8px; padding: 10px 13px; border: 1px solid var(--border); font-size: 0.76rem; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .eb .el { color: var(--text-light); font-weight: 600; }
        .eb .ev { font-weight: 800; color: var(--primary); }
        .eb .ei { color: var(--accent); font-style: italic; }
        .wb { padding: 10px 13px; border-radius: 8px; margin-top: 12px; font-size: 0.76rem; display: none; }
        .wb.warn { background: var(--warning-bg); border: 1px solid var(--warning-border); color: #7b341e; }
        .wb.info { background: var(--info-bg); border: 1px solid var(--info-border); color: #2a4365; }
        .wb.danger { background: var(--danger-bg); border: 1px solid var(--danger-border); color: #742a2a; }
        .wb.v { display: block; }
        .pc { border: 1px solid var(--border); border-radius: 11px; overflow: hidden; }
        .ph { background: #f7fafc; padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .ph h3 { font-size: 0.76rem; color: var(--primary); font-weight: 700; }
        .bs { padding: 5px 11px; border-radius: 5px; font-size: 0.68rem; font-weight: 600; cursor: pointer; border: 1px solid; background: var(--info-bg); color: var(--accent); border-color: var(--info-border); transition: all 0.2s; }
        .bs:hover { background: #d4e8f7; }
        .pb { padding: 22px; font-family: 'Georgia', 'Times New Roman', serif; font-size: 0.88rem; line-height: 1.85; color: #1a202c; white-space: pre-wrap; }
        .rs { background: #f8f9fa; padding: 15px 22px; border-top: 1px solid var(--border); }
        .rs h4 { font-size: 0.71rem; text-transform: uppercase; color: var(--text-light); margin-bottom: 7px; letter-spacing: 1px; }
        .rs p { font-size: 0.74rem; line-height: 1.6; color: #4a5568; margin-bottom: 3px; padding-left: 18px; text-indent: -18px; }
        .as { margin-top: 16px; border: 1px solid var(--border); border-radius: 11px; overflow: hidden; }
        .ah { background: #f7fafc; padding: 8px 16px; border-bottom: 1px solid var(--border); font-size: 0.71rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; }
        .ab { padding: 13px 16px; font-family: 'Consolas', monospace; font-size: 0.68rem; line-height: 1.7; color: #4a5568; background: #fdfdfe; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .ge { background: var(--danger-bg); border: 2px solid var(--danger-border); color: #742a2a; padding: 14px 16px; border-radius: 9px; margin-top: 12px; font-size: 0.82rem; font-weight: 600; display: none; }
        .ge.v { display: block; }
        .ni-box { background: #fefcbf; border: 1px solid #ecc94b; border-radius: 7px; padding: 9px 13px; font-size: 0.71rem; color: #744210; margin-top: 7px; display: none; }
        .ni-box.v { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fi { animation: fadeIn 0.4s ease-out; }
        @media (max-width: 700px) {
            .g2, .g3, .rg { grid-template-columns: 1fr; }
            .sf { grid-column: span 1; }
            .body-c { padding: 16px; }
            .header { padding: 16px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="badge">v4.0 â€” Regulatory Grade</div>
        <h1>SampleSize Pro</h1>
        <div class="sub">Calculadora Muestral con Desarrollo MatemÃ¡tico para Protocolos de Ensayos ClÃ­nicos</div>
    </div>
    <div class="body-c">
        <div class="note">
            <strong>Base metodolÃ³gica:</strong>
            <strong>Fleiss, Tytun &amp; Ury (1980)</strong> para proporciones;
            <strong>Snedecor &amp; Cochran (1989)</strong> / <strong>Welch (1947)</strong> para medias;
            <strong>Schoenfeld (1983)</strong> / <strong>Freedman (1982)</strong> para supervivencia;
            <strong>Whitehead (1993)</strong> para ordinales.
            Correcciones: <strong>Cochran (1977)</strong>, <strong>Lachin (1981)</strong>.
            Conforme a <strong>ICH E9</strong> e <strong>ICH E10</strong>.
        </div>

        <!-- STEP 1 -->
        <div class="sec">
            <div class="sec-t"><span class="st">1</span> DISEÃ‘O</div>
            <div class="g2">
                <div class="f"><label>Desenlace principal</label>
                    <select id="mode" onchange="updateUI()">
                        <option value="prop">Proporciones (dicotÃ³mica)</option>
                        <option value="mean">Medias (continua)</option>
                        <option value="surv">Supervivencia / Tiempo al evento</option>
                        <option value="ordinal">Ordinal (Whitehead)</option>
                    </select>
                </div>
                <div class="f"><label>Objetivo <span class="tip" data-t="Bilateral: diferencia en cualquier direcciÃ³n. Unilateral: superioridad en una direcciÃ³n. No inferioridad: demostrar que no es inaceptablemente peor.">?</span></label>
                    <select id="hyp" onchange="updateHypUI()">
                        <option value="sb">Superioridad â€” Bilateral</option>
                        <option value="su">Superioridad â€” Unilateral</option>
                        <option value="ni">No inferioridad</option>
                    </select>
                </div>
                <div class="f"><label>RazÃ³n de asignaciÃ³n (k = nâ‚‚/nâ‚) <span class="tip" data-t="1 = iguales. 2 = doble en experimental.">?</span></label>
                    <select id="k">
                        <option value="1" selected>1:1</option>
                        <option value="1.5">1.5:1</option>
                        <option value="2">2:1</option>
                        <option value="3">3:1</option>
                    </select>
                </div>
                <div class="f" id="ni-f" style="display:none;">
                    <label>Margen no inferioridad (Î”) <span class="tip" data-t="Debe justificarse clÃ­nicamente segÃºn ICH E10.">?</span></label>
                    <input type="number" id="ni-m" value="10" step="any" min="0.001">
                    <div class="ht" id="ni-h">En unidades del desenlace</div>
                    <div class="em" id="ni-e"></div>
                    <div class="ni-box" id="ni-box">DiseÃ±o NI: contraste siempre unilateral. Margen Î” debe estar justificado (ICH E10, EMA/CPMP/EWP/2158/99).</div>
                </div>
            </div>
        </div>

        <!-- STEP 2 -->
        <div class="sec">
            <div class="sec-t"><span class="st">2</span> PARÃMETROS CLÃNICOS</div>
            <div id="pf">
                <div class="g2">
                    <div class="f"><label>ProporciÃ³n Control (pâ‚) <span class="u">%</span></label><input type="number" id="p1" value="20" step="0.1"><div class="ht">Tasa evento en control</div><div class="em" id="p1e"></div></div>
                    <div class="f"><label>ProporciÃ³n Experimental (pâ‚‚) <span class="u">%</span></label><input type="number" id="p2" value="40" step="0.1"><div class="ht">Tasa evento en experimental</div><div class="em" id="p2e"></div></div>
                </div>
            </div>
            <div id="mf" style="display:none;">
                <div class="g2">
                    <div class="f"><label>Media Control (Î¼â‚)</label><input type="number" id="m1" value="100" step="any"><div class="em" id="m1e"></div></div>
                    <div class="f"><label>Media Experimental (Î¼â‚‚)</label><input type="number" id="m2" value="90" step="any"><div class="em" id="m2e"></div></div>
                    <div class="f"><label>DE Control (Ïƒâ‚) <span class="tip" data-t="De estudios previos o piloto.">?</span></label><input type="number" id="sd1" value="15" step="any"><div class="em" id="sd1e"></div></div>
                    <div class="f"><label>DE Experimental (Ïƒâ‚‚) <span class="tip" data-t="Igual a Ïƒâ‚ si asume homocedasticidad.">?</span></label><input type="number" id="sd2" value="15" step="any"><div class="ht">Igual a Ïƒâ‚ si varianzas iguales</div><div class="em" id="sd2e"></div></div>
                </div>
            </div>
            <div id="sf2" style="display:none;">
                <div class="g2">
                    <div class="f"><label>Supervivencia Control (Sâ‚) <span class="u">%</span></label><input type="number" id="s1" value="50" step="0.1"><div class="ht">Al final del periodo</div><div class="em" id="s1e"></div></div>
                    <div class="f"><label>Supervivencia Experimental (Sâ‚‚) <span class="u">%</span></label><input type="number" id="s2" value="65" step="0.1"><div class="em" id="s2e"></div></div>
                    <div class="f"><label>Reclutamiento <span class="u">meses</span></label><input type="number" id="ta" value="24" min="1"><div class="em" id="tae"></div></div>
                    <div class="f"><label>Seguimiento adicional <span class="u">meses</span></label><input type="number" id="tf" value="12" min="0"><div class="em" id="tfe"></div></div>
                </div>
            </div>
            <div id="of" style="display:none;">
                <div class="g2">
                    <div class="f sf"><label>Proporciones por categorÃ­a â€” Control <span class="u">%, separadas por comas</span> <span class="tip" data-t="Ej: 15,25,35,25 para 4 categorÃ­as. Deben sumar 100.">?</span></label><input type="text" id="oc" value="15, 25, 35, 25"><div class="ht">Deben sumar 100</div><div class="em" id="oce"></div></div>
                    <div class="f"><label>Odds Ratio esperado (OR)</label><input type="number" id="oor" value="1.5" step="0.01"><div class="em" id="oore"></div></div>
                </div>
            </div>
        </div>

        <!-- STEP 3 -->
        <div class="sec">
            <div class="sec-t"><span class="st">3</span> ERROR TIPO I Y POTENCIA</div>
            <div class="g3">
                <div class="f"><label>SignificaciÃ³n (Î±)</label>
                    <select id="al"><option value="0.10">0.10</option><option value="0.05" selected>0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option></select>
                </div>
                <div class="f"><label>Potencia (1âˆ’Î²) <span class="tip" data-t="80% mÃ­nimo aceptable. 90% para registro.">?</span></label>
                    <select id="pw"><option value="0.80" selected>80%</option><option value="0.85">85%</option><option value="0.90">90%</option><option value="0.95">95%</option></select>
                </div>
                <div class="f"><label>PÃ©rdida esperada <span class="u">%</span></label><input type="number" id="loss" value="10" min="0" max="49"><div class="em" id="losse"></div></div>
            </div>
        </div>

        <button class="adv-btn" onclick="togAdv()" id="ab">â–¸ Opciones avanzadas</button>
        <div class="adv-p" id="ap">
            <div class="g2">
                <div class="f"><label>CorrecciÃ³n continuidad <span class="tip" data-t="Fleiss 1980. Solo proporciones.">?</span></label><select id="cc"><option value="0" selected>No</option><option value="1">SÃ­ (Fleiss 1980)</option></select></div>
                <div class="f"><label>PoblaciÃ³n finita (N) <span class="tip" data-t="0 = infinita.">?</span></label><input type="number" id="fp" value="0" min="0"><div class="ht">0 = no corregir</div></div>
            </div>
        </div>

        <button class="btn" onclick="calc()">CALCULAR TAMAÃ‘O MUESTRAL</button>

        <div class="ge" id="ge"></div>
        <div class="wb warn" id="w1"></div>
        <div class="wb warn" id="w2"></div>
        <div class="wb info" id="w3"></div>
        <div class="wb info" id="w4"></div>
        <div class="wb warn" id="w5"></div>
        <div class="wb danger" id="w6"></div>

        <div id="res" class="fi">
            <div class="rh">
                <div class="rg">
                    <div class="rc"><div class="rl">n por grupo (teÃ³rico)</div><div class="rv" id="rv1">â€”</div></div>
                    <div class="rc"><div class="rl">n por grupo (ajustado)</div><div class="rv" id="rv2">â€”</div></div>
                    <div class="rc cf"><div class="rl">TOTAL A RECLUTAR</div><div class="rv" id="rv3">â€”</div></div>
                </div>
                <div class="eb"><span class="el">Efecto:</span><span class="ev" id="ev">â€”</span><span class="ei" id="ei"></span></div>
            </div>
            <div class="pc">
                <div class="ph"><h3>ğŸ“„ Texto para Protocolo</h3><div><button class="bs" onclick="copyP()">ğŸ“‹ Copiar</button></div></div>
                <div class="pb" id="pt"></div>
                <div class="rs" id="rf"></div>
            </div>
            <div class="as"><div class="ah">Traza de AuditorÃ­a</div><div class="ab" id="al2"></div></div>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLESIZEPRO v4.0 â€” REGULATORY-GRADE ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ZT={'0.10':{o:1.28155,t:1.64485},'0.05':{o:1.64485,t:1.95996},'0.025':{o:1.95996,t:2.24140},'0.01':{o:2.32635,t:2.57583}};
const ZB={'0.80':0.84162,'0.85':1.03643,'0.90':1.28155,'0.95':1.64485};

function sn(v){const n=parseFloat(v);return(isNaN(n)||!isFinite(n))?null:n;}
function F(n,d){if(n===null||n===undefined||isNaN(n)||!isFinite(n))return'[ERROR]';return d===undefined?Math.ceil(n).toString():Number(n).toFixed(d);}
function FC(n){return F(n,0);}

function updateUI(){
    const m=document.getElementById('mode').value;
    document.getElementById('pf').style.display=m==='prop'?'block':'none';
    document.getElementById('mf').style.display=m==='mean'?'block':'none';
    document.getElementById('sf2').style.display=m==='surv'?'block':'none';
    document.getElementById('of').style.display=m==='ordinal'?'block':'none';
    updateHypUI();
}
function updateHypUI(){
    const h=document.getElementById('hyp').value,m=document.getElementById('mode').value;
    const ni=h==='ni';
    document.getElementById('ni-f').style.display=ni?'block':'none';
    document.getElementById('ni-box').classList.toggle('v',ni);
    if(ni&&m==='prop')document.getElementById('ni-h').textContent='En puntos porcentuales (ej: 10 = 10%)';
    else if(ni&&m==='surv')document.getElementById('ni-h').textContent='HR mÃ¡ximo aceptable (ej: 1.3)';
    else document.getElementById('ni-h').textContent='En unidades del desenlace';
}
function togAdv(){const p=document.getElementById('ap'),b=document.getElementById('ab');p.classList.toggle('open');b.textContent=p.classList.contains('open')?'â–¾ Opciones avanzadas':'â–¸ Opciones avanzadas';}

function clr(){
    document.querySelectorAll('.err').forEach(e=>e.classList.remove('err'));
    document.querySelectorAll('.em').forEach(e=>{e.classList.remove('v');e.textContent='';});
    document.querySelectorAll('.wb').forEach(e=>{e.classList.remove('v');e.innerHTML='';});
    const g=document.getElementById('ge');g.classList.remove('v');g.textContent='';
}
function sfe(iid,eid,msg){const i=document.getElementById(iid),e=document.getElementById(eid);if(i)i.classList.add('err');if(e){e.textContent=msg;e.classList.add('v');}}
function sge(msg){const g=document.getElementById('ge');g.textContent='âŒ '+msg;g.classList.add('v');}
function sw(id,msg){const e=document.getElementById(id);if(e){e.innerHTML=msg;e.classList.add('v');}}

function parseOrd(){
    const r=document.getElementById('oc').value;
    if(!r||!r.trim())return{ok:false,msg:'Ingrese proporciones separadas por comas'};
    const p=r.split(',').map(s=>s.trim()).filter(s=>s.length>0);
    if(p.length<2)return{ok:false,msg:'MÃ­nimo 2 categorÃ­as'};
    const n=p.map(Number);
    if(n.some(isNaN))return{ok:false,msg:'Solo valores numÃ©ricos'};
    if(n.some(v=>v<=0))return{ok:false,msg:'Todas > 0'};
    const s=n.reduce((a,b)=>a+b,0);
    if(Math.abs(s-100)>0.5)return{ok:false,msg:'Deben sumar 100 (suman '+F(s,1)+')'};
    return{ok:true,probs:n.map(v=>v/100)};
}

function validate(){
    clr();let ok=true;
    const m=document.getElementById('mode').value,h=document.getElementById('hyp').value,l=sn(document.getElementById('loss').value);
    if(l===null||l<0||l>=50){sfe('loss','losse','Entre 0 y 49');ok=false;}
    if(m==='prop'){
        const p1=sn(document.getElementById('p1').value),p2=sn(document.getElementById('p2').value);
        if(p1===null||p1<=0||p1>=100){sfe('p1','p1e','Entre 0.1 y 99.9');ok=false;}
        if(p2===null||p2<=0||p2>=100){sfe('p2','p2e','Entre 0.1 y 99.9');ok=false;}
        if(p1!==null&&p2!==null&&Math.abs(p1-p2)<0.01&&h!=='ni'){sfe('p2','p2e','Proporciones deben diferir');ok=false;}
    }
    if(m==='mean'){
        const m1=sn(document.getElementById('m1').value),m2=sn(document.getElementById('m2').value),s1=sn(document.getElementById('sd1').value),s2=sn(document.getElementById('sd2').value);
        if(m1===null){sfe('m1','m1e','Requerido');ok=false;}
        if(m2===null){sfe('m2','m2e','Requerido');ok=false;}
        if(s1===null||s1<=0){sfe('sd1','sd1e','Debe ser > 0');ok=false;}
        if(s2===null||s2<=0){sfe('sd2','sd2e','Debe ser > 0');ok=false;}
        if(m1!==null&&m2!==null&&Math.abs(m1-m2)<1e-12&&h!=='ni'){sfe('m2','m2e','Medias deben diferir');ok=false;}
    }
    if(m==='surv'){
        const s1=sn(document.getElementById('s1').value),s2=sn(document.getElementById('s2').value);
        if(s1===null||s1<=0||s1>=100){sfe('s1','s1e','Entre 0.1 y 99.9');ok=false;}
        if(s2===null||s2<=0||s2>=100){sfe('s2','s2e','Entre 0.1 y 99.9');ok=false;}
        if(s1!==null&&s2!==null&&Math.abs(s1-s2)<0.01&&h!=='ni'){sfe('s2','s2e','Deben diferir');ok=false;}
        const ta=sn(document.getElementById('ta').value),tf=sn(document.getElementById('tf').value);
        if(ta===null||ta<1){sfe('ta','tae','â‰¥ 1');ok=false;}
        if(tf===null||tf<0){sfe('tf','tfe','â‰¥ 0');ok=false;}
    }
    if(m==='ordinal'){
        const o=sn(document.getElementById('oor').value);
        if(o===null||o<=0||Math.abs(o-1)<0.001){sfe('oor','oore','> 0 y â‰  1');ok=false;}
        const p=parseOrd();if(!p.ok){sfe('oc','oce',p.msg);ok=false;}
    }
    if(h==='ni'){const v=sn(document.getElementById('ni-m').value);if(v===null||v<=0){sfe('ni-m','ni-e','> 0');ok=false;}}
    return ok;
}

// â•â•â•â•â•â•â• STATISTICAL FORMULAS â•â•â•â•â•â•â•

function calcProp(p1,p2,za,zb,k,cc){
    const q1=1-p1,q2=1-p2,d=Math.abs(p1-p2);
    if(d<1e-15)return null;
    const pb=(p1+k*p2)/(1+k),qb=1-pb;
    const A=za*Math.sqrt((1+1/k)*pb*qb);
    const B=zb*Math.sqrt(p1*q1+p2*q2/k);
    let n1=Math.pow(A+B,2)/Math.pow(d,2);
    const n1_nocc=n1;
    if(cc&&n1>0){n1=(n1/4)*Math.pow(1+Math.sqrt(1+2*(1+1/k)/(n1*d)),2);}
    n1=Math.ceil(n1);
    if(!isFinite(n1)||n1<=0)return null;
    const n2=Math.ceil(n1*k);
    return{n1,n2,total:n1+n2,pb,qb,A,B,num:Math.pow(A+B,2),den:Math.pow(d,2),n1_nocc:Math.ceil(n1_nocc),d,q1,q2};
}

function calcMean(delta,sd1,sd2,za,zb,k){
    if(Math.abs(delta)<1e-15)return null;
    const het=Math.abs(sd1-sd2)>1e-10;
    let n1,varTerm;
    if(het){
        varTerm=Math.pow(sd1,2)+Math.pow(sd2,2)/k;
        n1=Math.pow(za+zb,2)*varTerm/Math.pow(delta,2);
    }else{
        varTerm=(1+1/k)*Math.pow(sd1,2);
        n1=Math.pow(za+zb,2)*varTerm/Math.pow(delta,2);
    }
    const n1raw=n1;
    n1=Math.ceil(n1);
    if(!isFinite(n1)||n1<=0)return null;
    const n2=Math.ceil(n1*k);
    return{n1,n2,total:n1+n2,het,varTerm,zSum:za+zb,zSumSq:Math.pow(za+zb,2),num:Math.pow(za+zb,2)*varTerm,den:Math.pow(delta,2),n1exact:n1raw};
}

function calcSurv(s1,s2,za,zb,k,tA,tF){
    if(s1<=0||s1>=1||s2<=0||s2>=1)return null;
    if(Math.abs(s1-s2)<1e-10)return null;
    const HR=Math.log(s2)/Math.log(s1);
    if(!isFinite(HR)||HR<=0||Math.abs(Math.log(HR))<1e-12)return null;
    const lnHR=Math.log(HR);
    const E=Math.pow(za+zb,2)*Math.pow(1+k,2)/(k*Math.pow(lnHR,2));
    const tT=tA+tF;
    const l1=-Math.log(s1)/tT, l2=-Math.log(s2)/tT;
    let pe1,pe2;
    if(l1>1e-10&&tA>0)pe1=1-(1/(l1*tA))*(Math.exp(-l1*tF)-Math.exp(-l1*tT));
    else pe1=1-s1;
    if(l2>1e-10&&tA>0)pe2=1-(1/(l2*tA))*(Math.exp(-l2*tF)-Math.exp(-l2*tT));
    else pe2=1-s2;
    pe1=Math.max(0.01,Math.min(0.99,pe1));
    pe2=Math.max(0.01,Math.min(0.99,pe2));
    const pAvg=(pe1+k*pe2)/(1+k);
    const N_total=E/pAvg;
    const n1=Math.ceil(N_total/(1+k));
    const n2=Math.ceil(n1*k);
    if(!isFinite(n1)||n1<=0)return null;
    return{n1,n2,total:n1+n2,E:Math.ceil(E),Eraw:E,HR,lnHR,pe1,pe2,pAvg,l1,l2,tT,zSum:za+zb,zSumSq:Math.pow(za+zb,2)};
}

function calcOrd(probs,OR,za,zb,k){
    if(!probs||probs.length<2||OR<=0||Math.abs(OR-1)<1e-10)return null;
    const lnOR=Math.log(OR);
    let cumS=0,info=0;
    const cumProbs=[];
    for(let j=0;j<probs.length-1;j++){cumS+=probs[j];cumProbs.push(cumS);info+=probs[j]*cumS*(1-cumS);}
    // Whitehead (1993) â€” information per subject under H0
    // For unequal allocation: total info = n1*k/(1+k) * info_per_subject (harmonic)
    // n_total = (Za+Zb)^2 / (lnOR^2 * info_per_subject) * (1+k)^2 / (k)  
    if(info<1e-15)return null;
    const N_total=Math.pow(za+zb,2)*Math.pow(1+k,2)/(k*Math.pow(lnOR,2)*info);
    const n1=Math.ceil(N_total/(1+k));
    const n2=Math.ceil(n1*k);
    if(!isFinite(n1)||n1<=0)return null;
    return{n1,n2,total:n1+n2,info,cumProbs,lnOR,zSum:za+zb};
}

function cohH(p1,p2){return Math.abs(2*Math.asin(Math.sqrt(p1))-2*Math.asin(Math.sqrt(p2)));}
function cohD(d,s1,s2){const p=Math.sqrt((s1*s1+s2*s2)/2);return p>0?Math.abs(d)/p:0;}
function intES(d){if(d<0.2)return'trivial (<0.2)';if(d<0.5)return'pequeÃ±o (0.2â€“0.5)';if(d<0.8)return'mediano (0.5â€“0.8)';return'grande (â‰¥0.8)';}
function finC(n,N){if(!N||N<=0)return n;return Math.max(2,Math.ceil(n/(1+(n-1)/N)));}
function lAdj(n,r){if(!r||r<=0||r>=1)return n;return Math.ceil(n/(1-r));}

// â•â•â•â•â•â•â• MAIN CALCULATION â•â•â•â•â•â•â•
function calc(){
    if(!validate())return;
    const mode=document.getElementById('mode').value;
    const hyp=document.getElementById('hyp').value;
    const aV=document.getElementById('al').value;
    const pV=document.getElementById('pw').value;
    const lP=sn(document.getElementById('loss').value)/100;
    const k=sn(document.getElementById('k').value);
    const cc=document.getElementById('cc').value==='1';
    const fp=sn(document.getElementById('fp').value)||0;
    const isNI=hyp==='ni',isBi=hyp==='sb';
    const tails=isBi?2:1;
    const zE=ZT[aV];
    if(!zE){sge('Valor Î± no reconocido');return;}
    const za=tails===2?zE.t:zE.o;
    const zb=ZB[pV];
    if(zb===undefined){sge('Potencia no reconocida');return;}
    const aN=sn(aV),pN=sn(pV);
    const confP=F((1-aN)*100,0),powP=F(pN*100,0);
    const tW=tails===2?'bilateral':'unilateral';
    const zaL=tails===2?'Î±/2':'Î±';

    const A=[];
    A.push('CÃ¡lculo: '+new Date().toLocaleString('es-ES'));
    A.push('Motor: SampleSize Pro v4.0');
    A.push('Modo: '+mode+' | HipÃ³tesis: '+hyp+' ('+tW+')');
    A.push('Î±='+aN+' â†’ Z'+zaL+'='+F(za,5)+' | 1âˆ’Î²='+pN+' â†’ ZÎ²='+F(zb,5));
    A.push('k='+k+' | PÃ©rdida='+F(lP*100,0)+'%');

    let R=null,esV='',esI='',devMath='',hypBlock='',paramsDef='';
    const refs=[];

    // â”€â”€â”€ PROPORTIONS â”€â”€â”€
    if(mode==='prop'){
        const p1=sn(document.getElementById('p1').value)/100;
        const p2=sn(document.getElementById('p2').value)/100;
        let d_calc,p1c,p2c;
        if(isNI){const niD=sn(document.getElementById('ni-m').value)/100;d_calc=niD;p1c=p1;p2c=p1+niD;}
        else{d_calc=Math.abs(p1-p2);p1c=p1;p2c=p2;}

        R=calcProp(p1c,p2c,za,zb,k,cc);
        if(!R){sge('CÃ¡lculo fallido: verifique que Î´ > 0.');return;}

        const h=cohH(p1,p2);
        esV='h = '+F(h,3);esI=intES(h);

        // â”€â”€ PARAMETER TABLE â”€â”€
        paramsDef=`Tabla de parÃ¡metros:

  SÃ­mbolo   DefiniciÃ³n                                    Valor
  â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€
  pâ‚        ProporciÃ³n esperada en grupo control          ${F(p1,4)} (${F(p1*100,1)}%)
  pâ‚‚        ProporciÃ³n esperada en grupo experimental     ${F(p2,4)} (${F(p2*100,1)}%)
  Î´         Diferencia absoluta |pâ‚ âˆ’ pâ‚‚|                ${F(d_calc,4)} (${F(d_calc*100,1)} pp)
  pÌ„         ProporciÃ³n media ponderada bajo Hâ‚€            ${F(R.pb,4)}
  Î±         Error tipo I (${tW})                     ${aN}
  Z${zaL}      Valor crÃ­tico normal                          ${F(za,4)}
  1âˆ’Î²       Potencia estadÃ­stica                          ${pN} (${powP}%)
  ZÎ²        Valor crÃ­tico para Î²                          ${F(zb,4)}
  k         RazÃ³n de asignaciÃ³n (nâ‚‚/nâ‚)                  ${k}`;

        // â”€â”€ FULL ARITHMETIC DEVELOPMENT â”€â”€
        const sqAinner=(1+1/k)*R.pb*(1-R.pb);
        const sqA=Math.sqrt(sqAinner);
        const sqBinner=p1c*(1-p1c)+p2c*(1-p2c)/k;
        const sqB=Math.sqrt(sqBinner);
        const termA=za*sqA;
        const termB=zb*sqB;
        const sumAB=termA+termB;
        const num=sumAB*sumAB;
        const den=d_calc*d_calc;
        const n1exact=num/den;

        devMath=`FÃ³rmula empleada (Fleiss, Tytun y Ury, 1980):

              â¡                                                    â¤Â²
              â¢  Z${zaL} Ã— âˆš[(1+1/k) Ã— pÌ„ Ã— (1âˆ’pÌ„)]  +  ZÎ² Ã— âˆš[pâ‚(1âˆ’pâ‚) + pâ‚‚(1âˆ’pâ‚‚)/k]  â¥
  nâ‚  =      â¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â¥
              â£                              Î´Â²                              â¦

Desarrollo aritmÃ©tico:

  1) ProporciÃ³n media ponderada bajo Hâ‚€:
     pÌ„ = (pâ‚ + k Ã— pâ‚‚) / (1 + k)
     pÌ„ = (${F(p1c,4)} + ${k} Ã— ${F(p2c,4)}) / (1 + ${k})
     pÌ„ = ${F(p1c + k * p2c, 4)} / ${F(1 + k, 1)}
     pÌ„ = ${F(R.pb,6)}

  2) TÃ©rmino A â€” componente bajo Hâ‚€:
     A = Z${zaL} Ã— âˆš[(1 + 1/k) Ã— pÌ„ Ã— (1 âˆ’ pÌ„)]
     A = ${F(za,4)} Ã— âˆš[(1 + 1/${k}) Ã— ${F(R.pb,4)} Ã— ${F(1-R.pb,4)}]
     A = ${F(za,4)} Ã— âˆš[${F(1+1/k,4)} Ã— ${F(R.pb*(1-R.pb),6)}]
     A = ${F(za,4)} Ã— âˆš${F(sqAinner,6)}
     A = ${F(za,4)} Ã— ${F(sqA,6)}
     A = ${F(termA,6)}

  3) TÃ©rmino B â€” componente bajo Hâ‚:
     B = ZÎ² Ã— âˆš[pâ‚(1âˆ’pâ‚) + pâ‚‚(1âˆ’pâ‚‚)/k]
     B = ${F(zb,4)} Ã— âˆš[${F(p1c,4)} Ã— ${F(1-p1c,4)} + ${F(p2c,4)} Ã— ${F(1-p2c,4)} / ${k}]
     B = ${F(zb,4)} Ã— âˆš[${F(p1c*(1-p1c),6)} + ${F(p2c*(1-p2c)/k,6)}]
     B = ${F(zb,4)} Ã— âˆš${F(sqBinner,6)}
     B = ${F(zb,4)} Ã— ${F(sqB,6)}
     B = ${F(termB,6)}

  4) Numerador:
     (A + B)Â² = (${F(termA,6)} + ${F(termB,6)})Â²
              = (${F(sumAB,6)})Â²
              = ${F(num,4)}

  5) Denominador:
     Î´Â² = (${F(d_calc,4)})Â² = ${F(den,6)}

  6) Resultado:
     nâ‚ = ${F(num,4)} / ${F(den,6)} = ${F(n1exact,4)}
     nâ‚ = âŒˆ${F(n1exact,4)}âŒ‰ = ${R.n1_nocc} sujetos (grupo control)`;

        if(cc){
            devMath+=`

  7) CorrecciÃ³n de continuidad (Fleiss, 1980):
     nâ‚_cc = (nâ‚/4) Ã— [1 + âˆš(1 + 2(1+1/k)/(nâ‚ Ã— Î´))]Â²
     nâ‚_cc = (${R.n1_nocc}/4) Ã— [1 + âˆš(1 + 2Ã—${F(1+1/k,2)}/(${R.n1_nocc} Ã— ${F(d_calc,4)}))]Â²
     nâ‚_cc = ${F(R.n1_nocc/4,2)} Ã— [1 + âˆš(1 + ${F(2*(1+1/k)/(R.n1_nocc*d_calc),6)})]Â²
     nâ‚_cc = ${R.n1} sujetos (grupo control)`;
        }

        if(Math.abs(k-1)<0.01){
            devMath+=`
     nâ‚‚ = nâ‚ = ${R.n1} sujetos (grupo experimental)
     Total teÃ³rico = ${R.n1} + ${R.n2} = ${R.total} sujetos`;
        }else{
            devMath+=`
     nâ‚‚ = âŒˆnâ‚ Ã— kâŒ‰ = âŒˆ${R.n1} Ã— ${k}âŒ‰ = ${R.n2} sujetos (grupo experimental)
     Total teÃ³rico = ${R.n1} + ${R.n2} = ${R.total} sujetos`;
        }

        refs.push('Fleiss JL, Tytun A, Ury HK. A simple approximation for calculating sample sizes for comparing independent proportions. Biometrics. 1980;36(2):343-346.');
        if(cc)sw('w3','â„¹ï¸ <strong>CorrecciÃ³n de continuidad aplicada</strong> (Fleiss, 1980).');

        if(isNI)hypBlock=`Hâ‚€: pâ‚‚ âˆ’ pâ‚ â‰¥ Î”    (el tratamiento experimental es inferior al control por un margen â‰¥ Î” = ${F(d_calc*100,1)} puntos porcentuales)
Hâ‚: pâ‚‚ âˆ’ pâ‚ < Î”    (el tratamiento experimental no es inferior al control dentro del margen preespecificado)`;
        else if(isBi)hypBlock=`Hâ‚€: pâ‚ = pâ‚‚    (no existe diferencia entre las proporciones de ambos grupos)
Hâ‚: pâ‚ â‰  pâ‚‚    (existe una diferencia estadÃ­sticamente significativa entre los grupos)`;
        else hypBlock=`Hâ‚€: pâ‚‚ â‰¤ pâ‚    (el tratamiento experimental no es superior al control)
Hâ‚: pâ‚‚ > pâ‚    (el tratamiento experimental presenta una proporciÃ³n significativamente ${p2>p1?'mayor':'menor'})`;
    }

    // â”€â”€â”€ MEANS â”€â”€â”€
    else if(mode==='mean'){
        const m1=sn(document.getElementById('m1').value),m2=sn(document.getElementById('m2').value);
        const sd1=sn(document.getElementById('sd1').value),sd2=sn(document.getElementById('sd2').value);
        let delta;
        if(isNI)delta=sn(document.getElementById('ni-m').value);
        else delta=Math.abs(m1-m2);

        R=calcMean(delta,sd1,sd2,za,zb,k);
        if(!R){sge('CÃ¡lculo fallido: verifique Î´ > 0 y Ïƒ > 0.');return;}

        const d=cohD(delta,sd1,sd2);
        esV='d = '+F(d,3);esI=intES(d);

        const het=R.het;
        paramsDef=`Tabla de parÃ¡metros:

  SÃ­mbolo   DefiniciÃ³n                                    Valor
  â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€
  Î¼â‚        Media esperada grupo control                  ${m1}
  Î¼â‚‚        Media esperada grupo experimental             ${m2}
  Î´         Diferencia |Î¼â‚ âˆ’ Î¼â‚‚|                         ${F(delta,4)}
  Ïƒâ‚        DesviaciÃ³n estÃ¡ndar grupo control             ${sd1}
  Ïƒâ‚‚        DesviaciÃ³n estÃ¡ndar grupo experimental        ${sd2}
  Î±         Error tipo I (${tW})                     ${aN}
  Z${zaL}      Valor crÃ­tico normal                          ${F(za,4)}
  1âˆ’Î²       Potencia estadÃ­stica                          ${pN} (${powP}%)
  ZÎ²        Valor crÃ­tico para Î²                          ${F(zb,4)}
  k         RazÃ³n de asignaciÃ³n (nâ‚‚/nâ‚)                  ${k}`;

        if(het){
            devMath=`FÃ³rmula empleada (Welch, 1947; varianzas heterogÃ©neas):

              (Z${zaL} + ZÎ²)Â² Ã— (Ïƒâ‚Â² + Ïƒâ‚‚Â²/k)
  nâ‚  =  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                      Î´Â²

Desarrollo aritmÃ©tico:

  1) Suma de valores crÃ­ticos:
     Z${zaL} + ZÎ² = ${F(za,4)} + ${F(zb,4)} = ${F(za+zb,4)}
     (Z${zaL} + ZÎ²)Â² = (${F(za+zb,4)})Â² = ${F(R.zSumSq,6)}

  2) Componente de varianza:
     Ïƒâ‚Â² + Ïƒâ‚‚Â²/k = ${F(sd1,2)}Â² + ${F(sd2,2)}Â²/${k}
                  = ${F(sd1*sd1,4)} + ${F(sd2*sd2/k,4)}
                  = ${F(R.varTerm,4)}

  3) Numerador:
     ${F(R.zSumSq,6)} Ã— ${F(R.varTerm,4)} = ${F(R.num,4)}

  4) Denominador:
     Î´Â² = ${F(delta,4)}Â² = ${F(R.den,6)}

  5) Resultado:
     nâ‚ = ${F(R.num,4)} / ${F(R.den,6)} = ${F(R.n1exact,4)}
     nâ‚ = âŒˆ${F(R.n1exact,4)}âŒ‰ = ${R.n1} sujetos`;
            refs.push('Welch BL. The generalization of "Student\'s" problem when several different population variances are involved. Biometrika. 1947;34(1-2):28-35.');
            sw('w2','âš ï¸ <strong>Varianzas desiguales:</strong> fÃ³rmula de Welch aplicada.');
        }else{
            devMath=`FÃ³rmula empleada (Snedecor y Cochran, 1989; varianzas homogÃ©neas):

              (1 + 1/k) Ã— (Z${zaL} + ZÎ²)Â² Ã— ÏƒÂ²
  nâ‚  =  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        Î´Â²

Desarrollo aritmÃ©tico:

  1) Factor de asignaciÃ³n:
     1 + 1/k = 1 + 1/${k} = ${F(1+1/k,4)}

  2) Suma de valores crÃ­ticos:
     Z${zaL} + ZÎ² = ${F(za,4)} + ${F(zb,4)} = ${F(za+zb,4)}
     (Z${zaL} + ZÎ²)Â² = (${F(za+zb,4)})Â² = ${F(R.zSumSq,6)}

  3) Numerador:
     ${F(1+1/k,4)} Ã— ${F(R.zSumSq,6)} Ã— ${F(sd1,2)}Â²
     = ${F(1+1/k,4)} Ã— ${F(R.zSumSq,6)} Ã— ${F(sd1*sd1,4)}
     = ${F(R.num,4)}

  4) Denominador:
     Î´Â² = ${F(delta,4)}Â² = ${F(R.den,6)}

  5) Resultado:
     nâ‚ = ${F(R.num,4)} / ${F(R.den,6)} = ${F(R.n1exact,4)}
     nâ‚ = âŒˆ${F(R.n1exact,4)}âŒ‰ = ${R.n1} sujetos`;
            refs.push('Snedecor GW, Cochran WG. Statistical Methods. 8th ed. Ames: Iowa State University Press; 1989.');
        }

        if(Math.abs(k-1)<0.01)devMath+=`
     nâ‚‚ = nâ‚ = ${R.n1} sujetos
     Total teÃ³rico = ${R.total} sujetos`;
        else devMath+=`
     nâ‚‚ = âŒˆ${R.n1} Ã— ${k}âŒ‰ = ${R.n2} sujetos
     Total teÃ³rico = ${R.total} sujetos`;

        if(isNI)hypBlock=`Hâ‚€: Î¼â‚‚ âˆ’ Î¼â‚ â‰¤ âˆ’Î”    (el experimental es inferior por margen â‰¥ Î” = ${F(delta,2)})
Hâ‚: Î¼â‚‚ âˆ’ Î¼â‚ > âˆ’Î”    (el experimental no es inferior al control)`;
        else if(isBi)hypBlock=`Hâ‚€: Î¼â‚ = Î¼â‚‚    (no existe diferencia entre las medias)
Hâ‚: Î¼â‚ â‰  Î¼â‚‚    (existe diferencia estadÃ­sticamente significativa)`;
        else hypBlock=`Hâ‚€: Î¼â‚‚ â‰¤ Î¼â‚    (el experimental no es superior)
Hâ‚: Î¼â‚‚ > Î¼â‚    (el experimental es significativamente superior)`;
    }

    // â”€â”€â”€ SURVIVAL â”€â”€â”€
    else if(mode==='surv'){
        const s1=sn(document.getElementById('s1').value)/100;
        const s2=sn(document.getElementById('s2').value)/100;
        const tA=sn(document.getElementById('ta').value),tF=sn(document.getElementById('tf').value);

        R=calcSurv(s1,s2,za,zb,k,tA,tF);
        if(!R){sge('CÃ¡lculo fallido. Verifique supervivencias.');return;}

        esV='HR = '+F(R.HR,3);
        esI=R.HR<1?'beneficio experimental':(R.HR>1?'beneficio control':'sin efecto');

        paramsDef=`Tabla de parÃ¡metros:

  SÃ­mbolo   DefiniciÃ³n                                    Valor
  â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€
  Sâ‚        Supervivencia grupo control                   ${F(s1*100,1)}%
  Sâ‚‚        Supervivencia grupo experimental              ${F(s2*100,1)}%
  HR        Hazard Ratio = ln(Sâ‚‚)/ln(Sâ‚)                 ${F(R.HR,4)}
  T_a       Periodo de reclutamiento                      ${FC(tA)} meses
  T_f       Seguimiento adicional                         ${FC(tF)} meses
  Î±         Error tipo I (${tW})                     ${aN}
  Z${zaL}      Valor crÃ­tico                                  ${F(za,4)}
  1âˆ’Î²       Potencia                                      ${pN} (${powP}%)
  ZÎ²        Valor crÃ­tico para Î²                          ${F(zb,4)}
  k         RazÃ³n de asignaciÃ³n                           ${k}`;

        devMath=`FÃ³rmulas empleadas (Schoenfeld, 1983; Freedman, 1982):

  NÃºmero de eventos necesarios:
              (Z${zaL} + ZÎ²)Â² Ã— (1 + k)Â²
  E  =  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              k Ã— [ln(HR)]Â²

  TamaÃ±o muestral total:
  N  =  E / Pr(evento)

Desarrollo aritmÃ©tico:

  1) Hazard Ratio:
     HR = ln(Sâ‚‚) / ln(Sâ‚) = ln(${F(s2,4)}) / ln(${F(s1,4)})
        = ${F(Math.log(s2),6)} / ${F(Math.log(s1),6)}
        = ${F(R.HR,6)}
     ln(HR) = ${F(R.lnHR,6)}

  2) Eventos necesarios:
     (Z${zaL} + ZÎ²)Â² = (${F(za,4)} + ${F(zb,4)})Â² = (${F(za+zb,4)})Â² = ${F(R.zSumSq,4)}
     (1 + k)Â² = (1 + ${k})Â² = ${F(Math.pow(1+k,2),2)}
     k Ã— [ln(HR)]Â² = ${k} Ã— (${F(R.lnHR,6)})Â² = ${k} Ã— ${F(R.lnHR*R.lnHR,6)} = ${F(k*R.lnHR*R.lnHR,6)}

     E = ${F(R.zSumSq,4)} Ã— ${F(Math.pow(1+k,2),2)} / ${F(k*R.lnHR*R.lnHR,6)}
       = ${F(R.Eraw,2)}
       = âŒˆ${F(R.Eraw,2)}âŒ‰ = ${R.E} eventos

  3) Probabilidad de evento (modelo exponencial, reclutamiento uniforme):
     Î»â‚ = âˆ’ln(Sâ‚)/T = âˆ’ln(${F(s1,4)})/${FC(R.tT)} = ${F(R.l1,6)}/mes
     Î»â‚‚ = âˆ’ln(Sâ‚‚)/T = âˆ’ln(${F(s2,4)})/${FC(R.tT)} = ${F(R.l2,6)}/mes
     Prâ‚(evento) = ${F(R.pe1,4)}
     Prâ‚‚(evento) = ${F(R.pe2,4)}
     Pr_promedio ponderado = (Prâ‚ + kÃ—Prâ‚‚)/(1+k) = ${F(R.pAvg,4)}

  4) TamaÃ±o muestral total:
     N = E / Pr = ${R.E} / ${F(R.pAvg,4)} = ${F(R.E/R.pAvg,2)}
     nâ‚ = âŒˆN/(1+k)âŒ‰ = âŒˆ${F(R.E/R.pAvg,2)}/${F(1+k,1)}âŒ‰ = ${R.n1}
     nâ‚‚ = âŒˆnâ‚ Ã— kâŒ‰ = ${R.n2}
     Total teÃ³rico = ${R.total} sujetos (se requieren â‰¥ ${R.E} eventos)`;

        refs.push('Schoenfeld DA. Sample-size formula for the proportional-hazards regression model. Biometrics. 1983;39(2):499-503.');
        refs.push('Freedman LS. Tables of the number of patients required in clinical trials using the logrank test. Statistics in Medicine. 1982;1(2):121-129.');

        if(isNI){const hrt=sn(document.getElementById('ni-m').value);
            hypBlock=`Hâ‚€: HR â‰¥ Î”    (el experimental es inferior; Î” = ${F(hrt,2)})
Hâ‚: HR < Î”    (el experimental no es inferior al control)`;}
        else if(isBi)hypBlock=`Hâ‚€: HR = 1    (no existe diferencia en supervivencia)
Hâ‚: HR â‰  1    (existe diferencia significativa)`;
        else hypBlock=`Hâ‚€: HR â‰¥ 1    (el experimental no mejora la supervivencia)
Hâ‚: HR < 1    (el experimental mejora significativamente la supervivencia)`;
    }

    // â”€â”€â”€ ORDINAL â”€â”€â”€
    else if(mode==='ordinal'){
        const parsed=parseOrd();if(!parsed.ok){sge(parsed.msg);return;}
        const probs=parsed.probs;
        const OR=sn(document.getElementById('oor').value);

        R=calcOrd(probs,OR,za,zb,k);
        if(!R){sge('CÃ¡lculo ordinal fallido.');return;}

        esV='OR = '+F(OR,2);
        esI=OR>1.5?'moderado-grande':(OR>1.2?'pequeÃ±o-moderado':'pequeÃ±o');

        const catStr=probs.map(p=>F(p*100,1)+'%').join(', ');
        const cumStr=R.cumProbs.map(c=>F(c,4)).join(', ');

        paramsDef=`Tabla de parÃ¡metros:

  SÃ­mbolo   DefiniciÃ³n                                    Valor
  â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€
  pâ±¼        Proporciones por categorÃ­a (control)          [${catStr}]
  OR        Odds ratio proporcional                       ${F(OR,2)}
  Câ±¼        Probabilidades acumuladas                     [${cumStr}]
  Î±         Error tipo I (${tW})                     ${aN}
  Z${zaL}      Valor crÃ­tico                                  ${F(za,4)}
  1âˆ’Î²       Potencia                                      ${pN} (${powP}%)
  ZÎ²        Valor crÃ­tico para Î²                          ${F(zb,4)}
  k         RazÃ³n de asignaciÃ³n                           ${k}`;

        let infoCalc='';
        let cumS2=0;
        for(let j=0;j<probs.length-1;j++){
            cumS2+=probs[j];
            const contrib=probs[j]*cumS2*(1-cumS2);
            infoCalc+=`     j=${j+1}: p${j+1}=${F(probs[j],4)}, C${j+1}=${F(cumS2,4)}, contribuciÃ³n = ${F(probs[j],4)} Ã— ${F(cumS2,4)} Ã— ${F(1-cumS2,4)} = ${F(contrib,6)}\n`;
        }

        devMath=`FÃ³rmula empleada (Whitehead, 1993):

              (Z${zaL} + ZÎ²)Â² Ã— (1+k)Â²
  nâ‚  =  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           k Ã— [ln(OR)]Â² Ã— Î£ pâ±¼Câ±¼(1âˆ’Câ±¼)

  donde Câ±¼ = Î£áµ¢â‚Œâ‚Ê² páµ¢ (probabilidad acumulada hasta categorÃ­a j)

Desarrollo aritmÃ©tico:

  1) InformaciÃ³n por sujeto bajo Hâ‚€:
     Î£ pâ±¼ Ã— Câ±¼ Ã— (1âˆ’Câ±¼)  para j = 1, ..., Jâˆ’1:
${infoCalc}     Î£ = ${F(R.info,6)}

  2) ln(OR) = ln(${F(OR,2)}) = ${F(R.lnOR,6)}
     [ln(OR)]Â² = ${F(R.lnOR*R.lnOR,6)}

  3) (Z${zaL} + ZÎ²)Â² = (${F(za,4)} + ${F(zb,4)})Â² = ${F(Math.pow(za+zb,2),4)}
     (1+k)Â² / k = (1+${k})Â² / ${k} = ${F(Math.pow(1+k,2)/k,4)}

  4) nâ‚ = ${F(Math.pow(za+zb,2),4)} Ã— ${F(Math.pow(1+k,2)/k,4)} / (${F(R.lnOR*R.lnOR,6)} Ã— ${F(R.info,6)})
        = ${F(Math.pow(za+zb,2)*Math.pow(1+k,2)/k,4)} / ${F(R.lnOR*R.lnOR*R.info,6)}
        = ${R.n1} sujetos`;

        if(Math.abs(k-1)<0.01)devMath+=`
     nâ‚‚ = nâ‚ = ${R.n1}
     Total teÃ³rico = ${R.total} sujetos`;
        else devMath+=`
     nâ‚‚ = âŒˆ${R.n1} Ã— ${k}âŒ‰ = ${R.n2}
     Total teÃ³rico = ${R.total} sujetos`;

        refs.push('Whitehead J. Sample size calculations for ordered categorical data. Statistics in Medicine. 1993;12(24):2257-2271.');

        if(isNI)hypBlock=`Hâ‚€: OR â‰¤ 1/Î”    (el experimental es inferior)
Hâ‚: OR > 1/Î”    (el experimental no es inferior)`;
        else if(isBi)hypBlock=`Hâ‚€: OR = 1    (distribuciones iguales)
Hâ‚: OR â‰  1    (las distribuciones difieren)`;
        else hypBlock=`Hâ‚€: OR â‰¤ 1    (sin beneficio)
Hâ‚: OR > 1    (desplazamiento favorable)`;
    }

    // â•â•â•â•â•â•â• SAFETY CHECK â•â•â•â•â•â•â•
    if(!R||!isFinite(R.n1)||!isFinite(R.n2)||R.n1<=0){
        sge('Error interno: resultado no vÃ¡lido.');return;
    }

    // â”€â”€â”€ ADJUSTMENTS â”€â”€â”€
    let n1a=R.n1,n2a=R.n2;
    let adjMath='';

    if(fp>0&&fp>=R.total){
        const n1fc=finC(R.n1,fp),n2fc=finC(R.n2,fp);
        adjMath+=`
CorrecciÃ³n de poblaciÃ³n finita (Cochran, 1977):
  n_adj = n / [1 + (nâˆ’1)/N]
  nâ‚_adj = ${R.n1} / [1 + (${R.n1}âˆ’1)/${fp}] = ${R.n1} / ${F(1+(R.n1-1)/fp,4)} = ${n1fc}`;
        if(Math.abs(k-1)>=0.01)adjMath+=`
  nâ‚‚_adj = ${R.n2} / [1 + (${R.n2}âˆ’1)/${fp}] = ${n2fc}`;
        n1a=n1fc;n2a=n2fc;
        refs.push('Cochran WG. Sampling Techniques. 3rd ed. New York: Wiley; 1977.');
        sw('w4','â„¹ï¸ <strong>CorrecciÃ³n de poblaciÃ³n finita</strong> (N = '+fp+').');
        A.push('CorrecciÃ³n finita: N='+fp);
    }

    if(lP>0){
        const n1f=lAdj(n1a,lP),n2f=lAdj(n2a,lP);
        adjMath+=`

Ajuste por pÃ©rdidas de seguimiento (Lachin, 1981):
  n_adj = n / (1 âˆ’ R),  donde R = ${F(lP,2)} (${F(lP*100,0)}%)
  nâ‚_adj = ${n1a} / (1 âˆ’ ${F(lP,2)}) = ${n1a} / ${F(1-lP,2)} = ${F(n1a/(1-lP),2)} â‰ˆ ${n1f}`;
        if(Math.abs(k-1)>=0.01)adjMath+=`
  nâ‚‚_adj = ${n2a} / ${F(1-lP,2)} = ${n2f}`;
        adjMath+=`

  Total a reclutar = ${n1f} + ${n2f} = ${n1f+n2f} sujetos`;
        n1a=n1f;n2a=n2f;
        refs.push('Lachin JM. Introduction to sample size determination and power analysis for clinical trials. Controlled Clinical Trials. 1981;2(2):93-113.');
    }

    const totalF=n1a+n2a;

    // Warnings
    if(R.n1<30||R.n2<30)sw('w1','âš ï¸ <strong>Muestra pequeÃ±a (n < 30).</strong> Considere mÃ©todos exactos o simulaciÃ³n Monte Carlo.');
    if(totalF>10000)sw('w6','âš ï¸ <strong>Muestra muy grande (N = '+totalF+').</strong> Revise si el efecto esperado es clÃ­nicamente realista.');
    if(isNI)sw('w5','âš ï¸ <strong>No inferioridad:</strong> Margen Î” debe justificarse segÃºn ICH E10 y directrices EMA/CPMP/EWP/2158/99.');

    // â”€â”€â”€ UPDATE CARDS â”€â”€â”€
    const split=(Math.abs(k-1)>=0.01);
    document.getElementById('rv1').textContent=split?R.n1+' / '+R.n2:FC(R.n1);
    document.getElementById('rv2').textContent=split?n1a+' / '+n2a:FC(n1a);
    document.getElementById('rv3').textContent=FC(totalF);
    document.getElementById('ev').textContent=esV;
    document.getElementById('ei').textContent=esI;

    // â”€â”€â”€ FULL PROTOCOL TEXT â”€â”€â”€
    refs.push('Cohen J. Statistical Power Analysis for the Behavioral Sciences. 2nd ed. Hillsdale, NJ: Lawrence Erlbaum; 1988.');
    refs.push('Chow SC, Shao J, Wang H, Lokhnygina Y. Sample Size Calculations in Clinical Research. 3rd ed. Boca Raton: Chapman & Hall/CRC; 2018.');

    const rPhrase=(Math.abs(k-1)<0.01)?'con asignaciÃ³n aleatoria 1:1 (grupos de igual tamaÃ±o)':'con razÃ³n de asignaciÃ³n '+k+':1';
    const modeD={'prop':'dos proporciones independientes','mean':'dos medias independientes','surv':'curvas de supervivencia mediante el test log-rank','ordinal':'desenlaces ordinales bajo el modelo de odds proporcionales'};

    let protocol=`CÃ¡lculo del tamaÃ±o muestral

El tamaÃ±o de la muestra se calculÃ³ para la comparaciÃ³n de ${modeD[mode]}, ${rPhrase}, con el objetivo de evaluar ${isNI?'la no inferioridad':'la '+(isBi?'diferencia':'superioridad')} del tratamiento experimental frente al control.

HipÃ³tesis estadÃ­sticas:
${hypBlock}

${paramsDef}

${devMath}`;

    if(adjMath)protocol+=`
${adjMath}`;

    protocol+=`

ConclusiÃ³n: Se requiere reclutar un total de ${FC(totalF)} sujetos${split?' ('+n1a+' en el grupo control y '+n2a+' en el grupo experimental)':' ('+n1a+' por grupo)'} para detectar ${isNI?'no inferioridad con margen Î”':'un tamaÃ±o del efecto '+esV+', clasificado como '+esI+' segÃºn Cohen (1988),'} con una potencia del ${powP}% y un nivel de significaciÃ³n ${tW} Î± = ${aN} (Z${zaL} = ${F(za,4)}).`;

    // â”€â”€ SAFETY REGEX â”€â”€
    const safe=protocol.replace(/NaN|undefined|\[ERROR\]|Infinity/g,'[VERIFICAR]');
    document.getElementById('pt').textContent=safe;

    if(safe.includes('[VERIFICAR]')){
        sge('Se detectaron valores no vÃ¡lidos en el texto. Revise los campos marcados [VERIFICAR].');
    }

    // References
    const uRefs=[...new Set(refs)];
    document.getElementById('rf').innerHTML='<h4>Referencias</h4>'+uRefs.map((r,i)=>'<p>'+(i+1)+'. '+r+'</p>').join('');

    // Audit
    A.push('nâ‚_raw='+R.n1+' nâ‚‚_raw='+R.n2+' total_raw='+R.total);
    A.push('nâ‚_final='+n1a+' nâ‚‚_final='+n2a+' TOTAL='+totalF);
    document.getElementById('al2').textContent=A.join('\n');

    document.getElementById('res').style.display='block';
    document.getElementById('res').scrollIntoView({behavior:'smooth',block:'start'});
}

function copyP(){
    const t=document.getElementById('pt').textContent;
    const r=document.getElementById('rf').innerText||'';
    const full=t+'\n\n'+r;
    if(full.includes('[VERIFICAR]')&&!confirm('âš ï¸ El texto contiene valores por verificar. Â¿Copiar de todos modos?'))return;
    navigator.clipboard.writeText(full).then(()=>{
        const b=document.querySelector('.bs');const o=b.innerHTML;
        b.innerHTML='âœ“ Copiado';b.style.background='#c6f6d5';b.style.color='#276749';
        setTimeout(()=>{b.innerHTML=o;b.style.background='';b.style.color='';},2200);
    }).catch(()=>{
        const ta=document.createElement('textarea');ta.value=full;
        document.body.appendChild(ta);ta.select();
        try{document.execCommand('copy');}catch(e){alert('Copie manualmente.');}
        document.body.removeChild(ta);
    });
}
</script>
</body>
</html>