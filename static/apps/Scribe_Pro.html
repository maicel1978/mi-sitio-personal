<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Scribe Pro | Bioestad√≠stica Edu</title>
    <!-- Usamos una fuente m√°s profesional -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
        }

        * { box-sizing: border-box; font-family: 'Lexend', sans-serif; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Evita rebotes en m√≥vil */
        }

        /* Overlay de Error de Permisos */
        #permissionDenied {
            display: none;
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 10000;
            padding: 2rem;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .alert-card {
            background: var(--card);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid var(--danger);
            max-width: 400px;
        }

        header {
            padding: 1.5rem;
            text-align: center;
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            gap: 1rem;
        }

        .editor-area {
            flex: 1;
            background: var(--card);
            border-radius: 24px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            padding: 1.5rem;
            font-size: 1.2rem;
            line-height: 1.6;
            outline: none;
            resize: none;
        }

        .bottom-controls {
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        .btn {
            border: none;
            border-radius: 14px;
            padding: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }

        .btn-mic {
            grid-column: span 3;
            background: var(--primary);
            font-size: 1.1rem;
            padding: 1.2rem;
        }

        .btn-mic.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        .btn-secondary { background: #334155; }
        .btn-secondary:active { background: #475569; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        select {
            grid-column: span 3;
            background: #0f172a;
            color: white;
            border: 1px solid #334155;
            padding: 0.5rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div id="permissionDenied">
    <div class="alert-card">
        <h2 style="color:var(--danger)">Microfono Bloqueado</h2>
        <p>Chrome no tiene permiso para escuchar. Haz clic en el icono del candado üîí junto a la URL y activa el <b>Micr√≥fono</b>.</p>
        <button class="btn btn-secondary" style="width:100%" onclick="location.reload()">Ya lo hice, reintentar</button>
    </div>
</div>

<header>
    <h1 style="margin:0; font-size: 1.4rem;">BIO-SCRIBE <span style="color:var(--primary)">PRO</span></h1>
</header>

<div class="main-container">
    <div class="editor-area">
        <textarea id="editor" placeholder="Pulsa el bot√≥n azul y dicta tus hallazgos bioestad√≠sticos..."></textarea>
        
        <div class="status-bar">
            <span id="wordCount">0 palabras</span>
            <span id="status">‚óè Sistema Listo</span>
        </div>

        <div class="bottom-controls">
            <button class="btn btn-mic" id="micBtn">
                <span id="micIcon">üé§</span> <span id="micText">Iniciar Dictado</span>
            </button>
            
            <button class="btn btn-secondary" onclick="speakText()">üîä Leer</button>
            <button class="btn btn-secondary" onclick="copyText()">üìã Copiar</button>
            <button class="btn btn-secondary" onclick="clearText()">üóëÔ∏è Limpiar</button>
            
            <select id="voiceSelect"></select>
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor');
    const micBtn = document.getElementById('micBtn');
    const micText = document.getElementById('micText');
    const status = document.getElementById('status');
    const wordCount = document.getElementById('wordCount');
    const permissionOverlay = document.getElementById('permissionDenied');

    let recognition;
    let isRecording = false;

    // --- CONFIGURACI√ìN DE VOZ (LECTURA) ---
    const synth = window.speechSynthesis;
    function loadVoices() {
        const voices = synth.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = voices
            .filter(v => v.lang.includes('es'))
            .map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;
    loadVoices();

    // --- CONFIGURACI√ìN DE DICTADO ---
    function initSpeech() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            alert("Este navegador no soporta dictado.");
            return;
        }

        recognition = new Speech();
        recognition.lang = 'es-ES';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
            micText.innerText = "Detener";
            status.innerText = "‚óè Escuchando activamente...";
            status.style.color = "var(--danger)";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            const cleanText = transcript.charAt(0).toUpperCase() + transcript.slice(1);
            editor.value += (editor.value ? " " : "") + cleanText + ". ";
            updateStats();
        };

        recognition.onerror = (event) => {
            console.error(event.error);
            if(event.error === 'not-allowed') {
                permissionOverlay.style.display = 'flex';
            }
            stopRecording();
        };

        recognition.onend = () => {
            if (isRecording) {
                recognition.start(); // Auto-reinicio para que no se corte en m√≥viles
            }
        };
    }

    function stopRecording() {
        isRecording = false;
        recognition.stop();
        micBtn.classList.remove('recording');
        micText.innerText = "Iniciar Dictado";
        status.innerText = "‚óè Sistema Listo";
        status.style.color = "var(--success)";
    }

    micBtn.onclick = () => {
        if (!recognition) initSpeech();
        if (!isRecording) {
            recognition.start();
        } else {
            stopRecording();
        }
    };

    // --- UTILIDADES ---
    function updateStats() {
        const text = editor.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        wordCount.innerText = `${words} palabras`;
        localStorage.setItem('scribe_back', editor.value);
    }

    function copyText() {
        navigator.clipboard.writeText(editor.value);
        status.innerText = "¬°Copiado con √©xito!";
        setTimeout(() => status.innerText = "‚óè Sistema Listo", 2000);
    }

    function clearText() {
        if(confirm("¬øBorrar todo?")) {
            editor.value = "";
            updateStats();
        }
    }

    function speakText() {
        if (synth.speaking) { synth.cancel(); return; }
        const utter = new SpeechSynthesisUtterance(editor.value);
        const voices = synth.getVoices();
        utter.voice = voices.find(v => v.name === document.getElementById('voiceSelect').value);
        synth.speak(utter);
    }

    // Cargar respaldo
    window.onload = () => {
        editor.value = localStorage.getItem('scribe_back') || '';
        updateStats();
    };
</script>

</body>
</html>