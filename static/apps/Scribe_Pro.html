<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Scribe Pro | Professional Dictation</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #020617;
                --surface: #0f172a;
                --text: #f1f5f9;
                --border: #1e293b;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .brand span { color: var(--primary); }

        /* Main Layout */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        textarea {
            flex: 1;
            width: 100%;
            padding: 1.5rem;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* Toolbar */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        
        .recording {
            animation: pulse 1.5s infinite;
            background: var(--danger) !important;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: #64748b;
            background: var(--bg);
        }

        .indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dot { height: 8px; width: 8px; border-radius: 50%; background: #94a3b8; }
        .dot.active { background: #22c55e; }

        /* Mobile specific */
        @media (max-width: 600px) {
            .controls { grid-template-columns: 1fr 1fr; }
            .btn-main { grid-column: span 2; padding: 1.2rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">BIO-SCRIBE <span>PRO</span></div>
    <div class="indicator">
        <div id="onlineDot" class="dot active"></div>
        <span id="statusText">Sistema Listo</span>
    </div>
</header>

<main>
    <div class="editor-wrapper">
        <textarea id="editor" placeholder="El dictado profesional comienza aqu√≠..."></textarea>
        
        <div class="status-bar">
            <span id="wordCount">0 palabras</span>
            <span id="saveStatus">Guardado autom√°ticamente</span>
        </div>

        <div class="controls">
            <button class="btn btn-primary btn-main" id="micBtn">
                <span id="micIcon">üé§</span> <span id="micText">Iniciar Dictado</span>
            </button>
            
            <button class="btn" id="playBtn">üîä Escuchar</button>
            
            <select class="btn" id="voiceSelect" style="text-align: left;">
                <option value="">Cargando voces...</option>
            </select>

            <button class="btn" onclick="copyText()">üìã Copiar</button>
            <button class="btn" onclick="downloadDoc()">üíæ Exportar</button>
            <button class="btn" onclick="clearText()">üóëÔ∏è Limpiar</button>
        </div>
    </div>
</main>

<script>
    const editor = document.getElementById('editor');
    const micBtn = document.getElementById('micBtn');
    const micText = document.getElementById('micText');
    const statusText = document.getElementById('statusText');
    const wordCount = document.getElementById('wordCount');
    const voiceSelect = document.getElementById('voiceSelect');
    const saveStatus = document.getElementById('saveStatus');

    let recognition;
    let isRecording = false;
    let wakeLock = null;

    // --- INICIALIZACI√ìN ---
    window.onload = () => {
        editor.value = localStorage.getItem('bioScribe_content') || '';
        updateStats();
        initSpeechRecognition();
        initSpeechSynthesis();
    };

    // --- PERSISTENCIA ---
    editor.addEventListener('input', () => {
        localStorage.setItem('bioScribe_content', editor.value);
        updateStats();
        saveStatus.innerText = "Guardando...";
        setTimeout(() => saveStatus.innerText = "Cambios guardados", 1000);
    });

    // --- RECONOCIMIENTO DE VOZ ROBUSTO ---
    function initSpeechRecognition() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            statusText.innerText = "Navegador no compatible";
            micBtn.disabled = true;
            return;
        }

        recognition = new Speech();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'es-ES';

        recognition.onstart = async () => {
            isRecording = true;
            micBtn.classList.add('recording');
            micText.innerText = "Escuchando...";
            statusText.innerText = "Micr√≥fono Activo";
            await requestWakeLock();
        };

        recognition.onresult = (event) => {
            let result = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
            
            // Comandos de voz inteligentes
            if (result === "punto") { editor.value = editor.value.trim() + ". "; }
            else if (result === "coma") { editor.value = editor.value.trim() + ", "; }
            else if (result === "nuevo p√°rrafo") { editor.value += "\n\n"; }
            else if (result === "borrar todo") { if(confirm("¬øBorrar?")) clearText(); }
            else {
                const formattedResult = result.charAt(0).toUpperCase() + result.slice(1);
                editor.value += (editor.value ? " " : "") + formattedResult + ". ";
            }
            
            editor.dispatchEvent(new Event('input'));
            // Scroll autom√°tico al final
            editor.scrollTop = editor.scrollHeight;
        };

        recognition.onerror = (event) => {
            console.error("Error de reconocimiento:", event.error);
            stopRecording();
            if(event.error === 'not-allowed') alert("Acceso al micr√≥fono denegado.");
        };

        recognition.onend = () => {
            if (isRecording) recognition.start(); // Auto-restart para evitar cortes en m√≥vil
        };
    }

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.error(`${err.name}, ${err.message}`); }
    }

    function stopRecording() {
        isRecording = false;
        recognition.stop();
        micBtn.classList.remove('recording');
        micText.innerText = "Iniciar Dictado";
        statusText.innerText = "Dictado Pausado";
        if (wakeLock) wakeLock.release().then(() => wakeLock = null);
    }

    micBtn.onclick = () => {
        if (!isRecording) recognition.start();
        else stopRecording();
    };

    // --- S√çNTESIS DE VOZ ---
    const synth = window.speechSynthesis;
    function initSpeechSynthesis() {
        const loadVoices = () => {
            const voices = synth.getVoices();
            voiceSelect.innerHTML = voices
                .filter(v => v.lang.includes('es') || v.lang.includes('en'))
                .map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`)
                .join('');
        };
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;
        loadVoices();
    }

    document.getElementById('playBtn').onclick = () => {
        if (synth.speaking) return synth.cancel();
        const utter = new SpeechSynthesisUtterance(editor.value);
        utter.voice = synth.getVoices().find(v => v.name === voiceSelect.value);
        synth.speak(utter);
    };

    // --- UTILIDADES ---
    function updateStats() {
        const text = editor.value.trim();
        const words = text ? text.split(/\s+/).length : 0;
        wordCount.innerText = `${words} palabras`;
    }

    function copyText() {
        navigator.clipboard.writeText(editor.value);
        const originalText = statusText.innerText;
        statusText.innerText = "¬°Copiado!";
        setTimeout(() => statusText.innerText = originalText, 2000);
    }

    function clearText() {
        if (confirm("Se borrar√° todo el contenido. ¬øContinuar?")) {
            editor.value = "";
            editor.dispatchEvent(new Event('input'));
        }
    }

    function downloadDoc() {
        const blob = new Blob([editor.value], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bio-scribe-${new Date().getTime()}.txt`;
        a.click();
    }
</script>

</body>
</html>