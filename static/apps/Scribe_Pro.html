<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Scribe Pro | Clinical Dictation</title>
    <style>
        :root {
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #020617;
                --surface: #0f172a;
                --text: #f1f5f9;
                --border: #1e293b;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Capa de Instrucciones para el Micr√≥fono */
        #permissionOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            color: white;
            padding: 2rem;
            text-align: center;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        header {
            padding: 1rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand { font-weight: 800; font-size: 1.1rem; }
        .brand span { color: var(--primary); }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            gap: 0.75rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .editor-wrapper {
            flex: 1;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        textarea {
            flex: 1;
            width: 100%;
            padding: 1.2rem;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 1.1rem;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 0.8rem 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .btn-mic {
            grid-column: span 3;
            background: var(--primary);
            color: white;
            border: none;
            padding: 1.2rem;
            font-size: 1.1rem;
            flex-direction: row;
            justify-content: center;
        }

        .btn-mic.active {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); opacity: 0.8; }
            100% { transform: scale(1); }
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            background: var(--border);
            color: var(--text);
        }

        /* Alerta de No HTTPS */
        #httpsWarning {
            display: none;
            background: var(--danger);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="httpsWarning">‚ö†Ô∏è Error: El dictado requiere una conexi√≥n segura (HTTPS)</div>

<div id="permissionOverlay">
    <h2>üéôÔ∏è Acceso al Micr√≥fono Bloqueado</h2>
    <p>Para usar el dictado, debes permitir el acceso al micr√≥fono.</p>
    <div style="background: #333; padding: 1rem; border-radius: 10px; text-align: left; margin: 1rem 0;">
        1. Toca el icono del <b>candado</b> o <b>configuraci√≥n</b> en la barra de direcciones.<br><br>
        2. Activa el interruptor de <b>Micr√≥fono</b>.<br><br>
        3. Recarga la p√°gina.
    </div>
    <button class="btn" onclick="location.reload()" style="width: 200px;">Entendido, recargar</button>
</div>

<header>
    <div class="brand">BIO-SCRIBE <span>PRO</span></div>
    <div id="statusIndicator" style="font-size: 0.8rem; color: var(--success);">‚óè Sistema Listo</div>
</header>

<main>
    <div class="editor-wrapper">
        <textarea id="editor" placeholder="Toca el bot√≥n azul para empezar a hablar..."></textarea>
        
        <div class="status-bar">
            <span id="wordCount">0 palabras</span>
            <span id="saveStatus">Auto-guardado activo</span>
        </div>

        <div class="controls">
            <button class="btn btn-mic" id="micBtn">
                <span id="micIcon">üé§</span> <span id="micText">Iniciar Dictado</span>
            </button>
            
            <button class="btn" id="playBtn"><span>üîä</span>O√≠r</button>
            <button class="btn" onclick="copyText()"><span>üìã</span>Copiar</button>
            <button class="btn" onclick="clearText()"><span>üóëÔ∏è</span>Borrar</button>

            <select id="voiceSelect" class="btn" style="grid-column: span 3; width: 100%; display: block;">
                <!-- Voces -->
            </select>
        </div>
    </div>
</main>

<script>
    const editor = document.getElementById('editor');
    const micBtn = document.getElementById('micBtn');
    const micText = document.getElementById('micText');
    const statusIndicator = document.getElementById('statusIndicator');
    const permissionOverlay = document.getElementById('permissionOverlay');
    const voiceSelect = document.getElementById('voiceSelect');

    let recognition;
    let isRecording = false;

    // 1. VERIFICAR HTTPS (Crucial para m√≥viles)
    if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
        document.getElementById('httpsWarning').style.display = 'block';
    }

    // 2. INICIALIZAR RECONOCIMIENTO
    function initRecognition() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) {
            alert("Tu navegador no soporta dictado de voz. Usa Chrome o Safari actualizado.");
            return;
        }

        recognition = new Speech();
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'es-ES';

        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('active');
            micText.innerText = "Detener Dictado";
            statusIndicator.innerText = "‚óè Escuchando...";
            statusIndicator.style.color = "var(--danger)";
        };

        recognition.onresult = (event) => {
            const result = event.results[event.results.length - 1][0].transcript;
            const formatted = result.charAt(0).toUpperCase() + result.slice(1);
            editor.value += (editor.value ? " " : "") + formatted + ". ";
            saveData();
        };

        recognition.onerror = (event) => {
            console.error("Error Speech:", event.error);
            if (event.error === 'not-allowed') {
                permissionOverlay.style.display = 'flex';
            }
            stopRecording();
        };

        recognition.onend = () => {
            if (isRecording) recognition.start(); // Forzar reconexi√≥n si se corta
        };
    }

    function stopRecording() {
        isRecording = false;
        recognition.stop();
        micBtn.classList.remove('active');
        micText.innerText = "Iniciar Dictado";
        statusIndicator.innerText = "‚óè Sistema Listo";
        statusIndicator.style.color = "var(--success)";
    }

    // 3. EVENTO DEL BOT√ìN (Debe ser por click directo del usuario)
    micBtn.onclick = () => {
        // En m√≥viles, la primera vez DEBE haber un gesto de usuario
        if (!recognition) initRecognition();
        
        if (!isRecording) {
            try {
                recognition.start();
            } catch (e) {
                console.log("Error al arrancar:", e);
            }
        } else {
            stopRecording();
        }
    };

    // 4. PERSISTENCIA Y UTILIDADES
    function saveData() {
        localStorage.setItem('bioScribe_doc', editor.value);
        const words = editor.value.trim().split(/\s+/).length;
        document.getElementById('wordCount').innerText = `${editor.value ? words : 0} palabras`;
    }

    window.onload = () => {
        editor.value = localStorage.getItem('bioScribe_doc') || '';
        saveData();
        loadVoices();
    };

    function loadVoices() {
        const synth = window.speechSynthesis;
        const updateVoices = () => {
            const voices = synth.getVoices().filter(v => v.lang.includes('es'));
            voiceSelect.innerHTML = voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
        };
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = updateVoices;
        updateVoices();
    }

    document.getElementById('playBtn').onclick = () => {
        const synth = window.speechSynthesis;
        if (synth.speaking) return synth.cancel();
        const utter = new SpeechSynthesisUtterance(editor.value);
        utter.voice = synth.getVoices().find(v => v.name === voiceSelect.value);
        synth.speak(utter);
    };

    function copyText() {
        navigator.clipboard.writeText(editor.value);
        alert("Texto copiado");
    }

    function clearText() {
        if(confirm("¬øBorrar todo?")) {
            editor.value = '';
            saveData();
        }
    }

    editor.oninput = saveData;
</script>

</body>
</html>