<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scribe Pro - TranscripciÃ³n de Voz</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Pulse en botÃ³n de grabar */
        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        .recording-btn.active {
            animation: pulse-dot 1.5s ease-in-out infinite;
        }
        .recording-btn.active::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 3px solid #ef4444;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .audio-bar { transition: height 0.1s ease; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-strong {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
        }
        .status-dot.ready { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dot.recording { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.error { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .status-dot.blocked { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.unsupported { background: #6b7280; }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 92vw;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-glow:hover { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }

        /* Modal overlay */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            padding: 16px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-overlay .modal-box {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 20px;
            max-width: 420px; width: 100%;
            max-height: 85vh; overflow-y: auto;
            padding: 24px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-box { transform: scale(1); }

        /* NÃºmero de paso */
        .step-num {
            width: 28px; height: 28px; min-width: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 13px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .blink { animation: blink 1s ease-in-out infinite; }
    </style>
</head>
<body class="text-white">

    <!-- Toast -->
    <div id="toast" class="toast">
        <div class="glass-strong rounded-xl px-5 py-3 flex items-center gap-3 shadow-2xl">
            <i id="toast-icon" class="fas fa-info-circle text-blue-400"></i>
            <span id="toast-msg" class="text-sm text-white/90"></span>
        </div>
    </div>

    <!-- Modal: MicrÃ³fono Bloqueado -->
    <div id="micBlockedModal" class="modal-overlay">
        <div class="modal-box custom-scroll">
            <div class="text-center mb-5">
                <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-microphone-slash text-red-400 text-2xl"></i>
                </div>
                <h2 class="text-lg font-bold text-white">MicrÃ³fono Bloqueado</h2>
                <p class="text-sm text-white/50 mt-1">Tu navegador tiene el micrÃ³fono denegado para este sitio. Hay que desbloquearlo manualmente.</p>
            </div>

            <!-- Instrucciones Chrome Android -->
            <div id="instrChrome" class="space-y-3">
                <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Instrucciones para Chrome (Android)</h3>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">1</div>
                    <p class="text-sm text-white/70">Toca el <strong class="text-white">icono de candado ðŸ”’</strong> o el icono de ajustes a la izquierda de la barra de direcciÃ³n (arriba).</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">2</div>
                    <p class="text-sm text-white/70">Toca <strong class="text-white">"Permisos"</strong> o <strong class="text-white">"ConfiguraciÃ³n del sitio"</strong>.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">3</div>
                    <p class="text-sm text-white/70">Busca <strong class="text-white">"MicrÃ³fono"</strong> y cÃ¡mbialo a <strong class="text-green-400">"Permitir"</strong>.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">4</div>
                    <p class="text-sm text-white/70"><strong class="text-white">Recarga la pÃ¡gina</strong> (desliza hacia abajo o toca el botÃ³n de recargar).</p>
                </div>
            </div>

            <!-- Instrucciones Safari iOS -->
            <div id="instrSafari" class="space-y-3 hidden">
                <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Instrucciones para Safari (iPhone/iPad)</h3>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">1</div>
                    <p class="text-sm text-white/70">Ve a <strong class="text-white">ConfiguraciÃ³n del iPhone</strong> (el icono de engranaje).</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">2</div>
                    <p class="text-sm text-white/70">Baja y toca <strong class="text-white">"Safari"</strong>.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">3</div>
                    <p class="text-sm text-white/70">Toca <strong class="text-white">"MicrÃ³fono"</strong> y selecciona <strong class="text-green-400">"Permitir"</strong> o <strong class="text-green-400">"Preguntar"</strong>.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">4</div>
                    <p class="text-sm text-white/70">Vuelve aquÃ­ y <strong class="text-white">recarga la pÃ¡gina</strong>.</p>
                </div>
                <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-3 mt-2">
                    <p class="text-xs text-amber-300"><i class="fas fa-triangle-exclamation mr-1"></i> Si usas Chrome en iPhone: Chrome en iOS usa el motor de Safari por dentro. Las mismas limitaciones aplican.</p>
                </div>
            </div>

            <!-- Instrucciones genÃ©ricas -->
            <div id="instrGeneric" class="space-y-3 hidden">
                <h3 class="text-xs font-bold text-indigo-400 uppercase tracking-wider">Instrucciones generales</h3>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">1</div>
                    <p class="text-sm text-white/70">Busca el <strong class="text-white">icono de candado</strong> en la barra de direcciÃ³n.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">2</div>
                    <p class="text-sm text-white/70">Cambia el permiso del <strong class="text-white">MicrÃ³fono</strong> a <strong class="text-green-400">Permitir</strong>.</p>
                </div>
                <div class="flex gap-3 items-start">
                    <div class="step-num bg-indigo-500/30 text-indigo-300">3</div>
                    <p class="text-sm text-white/70"><strong class="text-white">Recarga esta pÃ¡gina.</strong></p>
                </div>
            </div>

            <div class="mt-6 space-y-2">
                <button onclick="location.reload()" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-xl transition text-sm">
                    <i class="fas fa-arrows-rotate mr-2"></i>Ya lo hice, recargar pÃ¡gina
                </button>
                <button onclick="closeModal('micBlockedModal')" class="w-full py-3 bg-white/5 hover:bg-white/10 text-white/60 font-medium rounded-xl transition text-sm">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-microphone-lines text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Scribe Pro</h1>
                    <p class="text-[10px] text-white/40 -mt-0.5">TranscripciÃ³n de voz</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-2 glass rounded-lg px-3 py-1.5">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="text-xs text-white/60" id="statusText">Iniciando...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-4xl mx-auto px-4 py-6 space-y-5">

        <!-- ALERTA: MicrÃ³fono bloqueado (se muestra si estÃ¡ denegado) -->
        <div id="alertBlocked" class="hidden">
            <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-5">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 min-w-[48px] rounded-full bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-microphone-slash text-red-400 text-xl blink"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-red-300 text-sm">MicrÃ³fono bloqueado por el navegador</h3>
                        <p class="text-xs text-white/50 mt-1">En algÃºn momento se denegÃ³ el permiso. Esto NO se puede cambiar desde la app â€” hay que hacerlo desde la configuraciÃ³n del navegador.</p>
                        <button onclick="showModal('micBlockedModal')" class="mt-3 bg-red-500/20 hover:bg-red-500/30 text-red-300 text-sm font-semibold px-4 py-2 rounded-xl transition">
                            <i class="fas fa-wrench mr-2"></i>Ver cÃ³mo desbloquearlo
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PASO 1: Probar micrÃ³fono (se muestra al inicio si no hay permiso) -->
        <div id="micTestSection" class="hidden">
            <div class="glass-strong rounded-2xl p-6 text-center">
                <div class="w-16 h-16 rounded-full bg-green-500/15 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-microphone text-green-400 text-2xl"></i>
                </div>
                <h2 class="text-base font-bold text-white mb-1">Primero, activa el micrÃ³fono</h2>
                <p class="text-sm text-white/50 mb-5">Tu navegador necesita permiso para usar el micrÃ³fono.<br>Toca el botÃ³n y <strong class="text-white/70">acepta "Permitir"</strong> cuando aparezca el mensaje.</p>
                <button onclick="requestMicPermission()" id="micTestBtn" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold px-8 py-4 rounded-2xl text-base transition active:scale-95 shadow-lg shadow-green-500/20">
                    <i class="fas fa-shield-check mr-2"></i>Permitir micrÃ³fono
                </button>
                <p class="text-xs text-white/30 mt-3">Si no aparece ningÃºn mensaje, probablemente ya estÃ¡ bloqueado â€” mira las instrucciones abajo.</p>
            </div>
        </div>

        <!-- ConfiguraciÃ³n (idioma + modo) -->
        <div id="configSection" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="glass rounded-2xl p-4">
                <label class="text-xs text-white/50 mb-2 block font-medium">
                    <i class="fas fa-language mr-1"></i>Idioma
                </label>
                <select id="langSelect" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500/50 transition appearance-none cursor-pointer">
                    <option value="es-ES">ðŸ‡ªðŸ‡¸ EspaÃ±ol (EspaÃ±a)</option>
                    <option value="es-MX" selected>ðŸ‡²ðŸ‡½ EspaÃ±ol (MÃ©xico)</option>
                    <option value="es-AR">ðŸ‡¦ðŸ‡· EspaÃ±ol (Argentina)</option>
                    <option value="es-CO">ðŸ‡¨ðŸ‡´ EspaÃ±ol (Colombia)</option>
                    <option value="en-US">ðŸ‡ºðŸ‡¸ English (US)</option>
                    <option value="en-GB">ðŸ‡¬ðŸ‡§ English (UK)</option>
                    <option value="pt-BR">ðŸ‡§ðŸ‡· PortuguÃªs (Brasil)</option>
                    <option value="fr-FR">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                    <option value="de-DE">ðŸ‡©ðŸ‡ª Deutsch</option>
                    <option value="it-IT">ðŸ‡®ðŸ‡¹ Italiano</option>
                </select>
            </div>
            <div class="glass rounded-2xl p-4">
                <label class="text-xs text-white/50 mb-2 block font-medium">
                    <i class="fas fa-sliders mr-1"></i>Modo
                </label>
                <div class="flex gap-2">
                    <button onclick="setMode('continuous')" id="modeContinuous" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30">
                        <i class="fas fa-infinity mr-1"></i>Continuo
                    </button>
                    <button onclick="setMode('single')" id="modeSingle" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10">
                        <i class="fas fa-comment mr-1"></i>Frase
                    </button>
                </div>
            </div>
        </div>

        <!-- Ãrea de grabaciÃ³n -->
        <div id="recordSection" class="glass-strong rounded-3xl p-6 sm:p-8">
            <!-- Visualizador -->
            <div class="flex items-end justify-center gap-[3px] h-16 mb-6" id="visualizer"></div>

            <!-- BotÃ³n principal -->
            <div class="flex flex-col items-center gap-4">
                <button id="recordBtn" onclick="toggleRecording()" class="recording-btn relative w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-2xl hover:shadow-indigo-500/25 transition-all duration-300 active:scale-95 btn-glow disabled:opacity-40 disabled:cursor-not-allowed" disabled>
                    <i id="recordIcon" class="fas fa-microphone text-3xl text-white"></i>
                </button>
                <p id="recordLabel" class="text-sm text-white/50">Primero permite el micrÃ³fono â†‘</p>
                <p id="recordTime" class="text-xs text-white/30 hidden font-mono">00:00</p>
            </div>

            <!-- Interim -->
            <div id="interimBox" class="mt-6 hidden">
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-xs text-indigo-400 mb-1"><i class="fas fa-ear-listen mr-1"></i>Escuchando...</p>
                    <p id="interimText" class="text-white/70 text-sm italic"></p>
                </div>
            </div>
        </div>

        <!-- TranscripciÃ³n -->
        <div class="glass rounded-2xl p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-semibold text-white/70">
                    <i class="fas fa-file-lines mr-2 text-indigo-400"></i>TranscripciÃ³n
                </h2>
                <div class="flex items-center gap-2">
                    <span id="charCount" class="text-xs text-white/30">0 caracteres</span>
                    <button onclick="copyText()" class="text-xs bg-white/5 hover:bg-white/10 text-white/50 hover:text-white/80 px-3 py-1.5 rounded-lg transition">
                        <i class="fas fa-copy mr-1"></i>Copiar
                    </button>
                    <button onclick="downloadText()" class="text-xs bg-white/5 hover:bg-white/10 text-white/50 hover:text-white/80 px-3 py-1.5 rounded-lg transition" title="Descargar">
                        <i class="fas fa-download mr-1"></i>
                    </button>
                    <button onclick="clearText()" class="text-xs bg-white/5 hover:bg-red-500/20 text-white/50 hover:text-red-400 px-3 py-1.5 rounded-lg transition">
                        <i class="fas fa-trash mr-1"></i>
                    </button>
                </div>
            </div>
            <textarea id="transcription" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white/90 text-sm leading-relaxed resize-none custom-scroll transition min-h-[150px]" placeholder="La transcripciÃ³n aparecerÃ¡ aquÃ­..." rows="8"></textarea>
        </div>

        <!-- FAQ -->
        <div class="glass rounded-2xl p-4 sm:p-6">
            <details class="group">
                <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-white/70 list-none">
                    <span><i class="fas fa-circle-question mr-2 text-amber-400"></i>Â¿Problemas? Soluciones rÃ¡pidas</span>
                    <i class="fas fa-chevron-down text-white/30 group-open:rotate-180 transition-transform"></i>
                </summary>
                <div class="mt-4 space-y-3 text-xs text-white/50 leading-relaxed">
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-lock text-green-400 mt-0.5 min-w-[16px]"></i>
                        <div>
                            <p class="text-white/70 font-medium">Dice "denegado" pero ya di permiso</p>
                            <p>Una vez que se niega, el navegador lo recuerda. Toca el <strong>candado ðŸ”’</strong> en la barra de direcciÃ³n â†’ Permisos â†’ MicrÃ³fono â†’ Permitir â†’ <strong>Recarga la pÃ¡gina</strong>.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-mobile-screen text-purple-400 mt-0.5 min-w-[16px]"></i>
                        <div>
                            <p class="text-white/70 font-medium">iPhone / iPad (Safari)</p>
                            <p>Ve a <strong>ConfiguraciÃ³n del iPhone â†’ Safari â†’ MicrÃ³fono â†’ Permitir</strong>. Safari en iOS tiene soporte limitado para esta tecnologÃ­a.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-ban text-red-400 mt-0.5 min-w-[16px]"></i>
                        <div>
                            <p class="text-white/70 font-medium">Otra app usa el micrÃ³fono</p>
                            <p>Cierra apps que usen micrÃ³fono: llamadas, WhatsApp, Zoom, Teams, etc.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-wifi text-cyan-400 mt-0.5 min-w-[16px]"></i>
                        <div>
                            <p class="text-white/70 font-medium">Necesita internet</p>
                            <p>El reconocimiento de voz de Chrome procesa en la nube. Sin internet, no funciona.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-chrome text-blue-400 mt-0.5 min-w-[16px]"></i>
                        <div>
                            <p class="text-white/70 font-medium">Â¿QuÃ© navegador funciona mejor?</p>
                            <p><strong>Chrome en Android</strong> es el que mejor soporte tiene. En iPhone, prueba Safari. Firefox y otros no soportan esta tecnologÃ­a.</p>
                        </div>
                    </div>
                </div>
            </details>
        </div>

    </main>

    <footer class="text-center py-6 text-xs text-white/20">
        Scribe Pro Â· TranscripciÃ³n de voz a texto
    </footer>

    <script>
        // ========================================
        // VARIABLES
        // ========================================
        let recognition = null;
        let isRecording = false;
        let currentMode = 'continuous';
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let animationId = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let micPermissionGranted = false;
        let recognitionRestarting = false;

        // ========================================
        // ELEMENTOS DOM
        // ========================================
        const $ = id => document.getElementById(id);
        const recordBtn = $('recordBtn');
        const recordIcon = $('recordIcon');
        const recordLabel = $('recordLabel');
        const recordTime = $('recordTime');
        const statusDot = $('statusDot');
        const statusText = $('statusText');
        const transcription = $('transcription');
        const interimBox = $('interimBox');
        const interimText = $('interimText');
        const charCount = $('charCount');
        const visualizer = $('visualizer');

        // Crear barras del visualizador
        function createBars() {
            visualizer.innerHTML = '';
            const count = 30;
            for (let i = 0; i < count; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar w-1.5 bg-indigo-500/30 rounded-full';
                bar.style.height = '8px';
                visualizer.appendChild(bar);
            }
        }
        createBars();

        // ========================================
        // INICIO: Detectar estado del micrÃ³fono
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            transcription.addEventListener('input', updateCharCount);
            detectPlatformForModal();
            await checkInitialState();
        });

        function detectPlatformForModal() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isAndroidChrome = /Android/.test(ua) && /Chrome/.test(ua);

            // Mostrar instrucciones correctas en el modal
            $('instrChrome').classList.add('hidden');
            $('instrSafari').classList.add('hidden');
            $('instrGeneric').classList.add('hidden');

            if (isIOS) {
                $('instrSafari').classList.remove('hidden');
            } else if (isAndroidChrome) {
                $('instrChrome').classList.remove('hidden');
            } else {
                $('instrGeneric').classList.remove('hidden');
            }
        }

        async function checkInitialState() {
            // 1. Â¿Soporta SpeechRecognition?
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                setStatus('unsupported', 'No soportado');
                recordLabel.textContent = 'Tu navegador no soporta esta funciÃ³n. Usa Chrome.';
                recordBtn.disabled = true;
                $('micTestSection').classList.add('hidden');
                showToast('Navegador no compatible. Usa Google Chrome.', 'error');
                return;
            }

            // 2. Â¿Ya tiene permiso de micrÃ³fono?
            let permState = 'unknown';
            if (navigator.permissions && navigator.permissions.query) {
                try {
                    const perm = await navigator.permissions.query({ name: 'microphone' });
                    permState = perm.state; // 'granted', 'denied', 'prompt'
                    console.log('[ScribePro] Permiso micrÃ³fono:', permState);

                    // Escuchar cambios de permiso en tiempo real
                    perm.onchange = () => {
                        console.log('[ScribePro] Permiso cambiÃ³ a:', perm.state);
                        if (perm.state === 'granted') {
                            onMicPermissionGranted();
                        } else if (perm.state === 'denied') {
                            onMicPermissionDenied();
                        }
                    };
                } catch(e) {
                    console.log('[ScribePro] No se pudo consultar permiso:', e);
                }
            }

            if (permState === 'granted') {
                // Ya tenemos permiso, activar todo
                onMicPermissionGranted();
            } else if (permState === 'denied') {
                // EstÃ¡ bloqueado
                onMicPermissionDenied();
            } else {
                // 'prompt' o 'unknown' â€” mostrar botÃ³n de pedir permiso
                showMicTestUI();
            }
        }

        // ========================================
        // FLUJO DE PERMISOS
        // ========================================
        function showMicTestUI() {
            $('micTestSection').classList.remove('hidden');
            $('alertBlocked').classList.add('hidden');
            recordBtn.disabled = true;
            recordLabel.textContent = 'Primero permite el micrÃ³fono â†‘';
            setStatus('error', 'Sin permiso');
        }

        async function requestMicPermission() {
            const btn = $('micTestBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Solicitando...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                // Ã‰xito â€” liberar stream de prueba
                stream.getTracks().forEach(t => t.stop());
                onMicPermissionGranted();
                showToast('Â¡MicrÃ³fono activado! Ya puedes grabar.', 'success');
            } catch(err) {
                console.error('[ScribePro] getUserMedia error:', err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    onMicPermissionDenied();
                } else if (err.name === 'NotFoundError') {
                    showToast('No se encontrÃ³ micrÃ³fono en este dispositivo.', 'error');
                    setStatus('error', 'Sin micrÃ³fono');
                } else if (err.name === 'NotReadableError') {
                    showToast('El micrÃ³fono estÃ¡ siendo usado por otra app. CiÃ©rrala y vuelve a intentar.', 'error');
                } else {
                    showToast('Error al acceder al micrÃ³fono: ' + err.message, 'error');
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shield-check mr-2"></i>Permitir micrÃ³fono';
            }
        }

        function onMicPermissionGranted() {
            micPermissionGranted = true;
            $('micTestSection').classList.add('hidden');
            $('alertBlocked').classList.add('hidden');
            recordBtn.disabled = false;
            recordLabel.textContent = 'Toca para grabar';
            setStatus('ready', 'Listo');
            initRecognition();
        }

        function onMicPermissionDenied() {
            micPermissionGranted = false;
            $('micTestSection').classList.add('hidden');
            $('alertBlocked').classList.remove('hidden');
            recordBtn.disabled = true;
            recordLabel.textContent = 'MicrÃ³fono bloqueado';
            setStatus('blocked', 'Bloqueado');

            // Mostrar modal automÃ¡ticamente
            setTimeout(() => showModal('micBlockedModal'), 500);
        }

        // ========================================
        // RECONOCIMIENTO DE VOZ
        // ========================================
        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;

            recognition = new SpeechRecognition();
            recognition.lang = $('langSelect').value;
            recognition.continuous = (currentMode === 'continuous');
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                console.log('[ScribePro] recognition.onstart');
                recognitionRestarting = false;
                isRecording = true;
                setStatus('recording', 'Grabando...');
                recordBtn.classList.add('active');
                recordBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                recordIcon.className = 'fas fa-stop text-3xl text-white';
                recordLabel.textContent = 'Toca para detener';
                recordTime.classList.remove('hidden');
                startTimer();
            };

            recognition.onresult = (event) => {
                let interim = '';
                let finalText = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const t = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalText += t;
                    } else {
                        interim += t;
                    }
                }

                if (interim) {
                    interimBox.classList.remove('hidden');
                    interimText.textContent = interim;
                } else {
                    interimBox.classList.add('hidden');
                }

                if (finalText) {
                    const cur = transcription.value;
                    const sep = cur && !cur.endsWith('\n') && !cur.endsWith(' ') ? ' ' : '';
                    transcription.value = cur + sep + finalText;
                    updateCharCount();
                    transcription.scrollTop = transcription.scrollHeight;
                }
            };

            recognition.onerror = (event) => {
                console.warn('[ScribePro] recognition.onerror:', event.error, event.message);

                switch (event.error) {
                    case 'not-allowed':
                        onMicPermissionDenied();
                        return;

                    case 'no-speech':
                        // Silencio â€” reiniciar en modo continuo
                        if (currentMode === 'continuous' && isRecording) {
                            console.log('[ScribePro] No speech, restarting...');
                            safeRestart();
                            return;
                        }
                        showToast('No se detectÃ³ voz. Intenta de nuevo.', 'warn');
                        break;

                    case 'audio-capture':
                        showToast('No se pudo capturar audio. Â¿Hay micrÃ³fono?', 'error');
                        break;

                    case 'network':
                        showToast('Sin conexiÃ³n a internet. Se necesita para el reconocimiento.', 'error');
                        break;

                    case 'aborted':
                        // Normal al detener, no mostrar error
                        if (!isRecording) return;
                        break;

                    default:
                        showToast('Error: ' + event.error, 'error');
                }

                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    stopRecordingUI();
                }
            };

            recognition.onend = () => {
                console.log('[ScribePro] recognition.onend, isRecording:', isRecording);
                interimBox.classList.add('hidden');

                if (isRecording && currentMode === 'continuous') {
                    safeRestart();
                } else {
                    stopRecordingUI();
                }
            };

            // Cambio de idioma
            $('langSelect').onchange = () => {
                const wasRec = isRecording;
                if (wasRec) stopRecording();
                initRecognition();
                if (wasRec) setTimeout(() => startRecording(), 400);
            };
        }

        function safeRestart() {
            if (recognitionRestarting || !isRecording) return;
            recognitionRestarting = true;

            try { recognition.stop(); } catch(e) {}

            setTimeout(() => {
                if (!isRecording) { recognitionRestarting = false; return; }
                try {
                    recognition.lang = $('langSelect').value;
                    recognition.continuous = (currentMode === 'continuous');
                    recognition.start();
                    console.log('[ScribePro] Restarted OK');
                } catch(e) {
                    console.error('[ScribePro] Restart failed:', e);
                    recognitionRestarting = false;
                    stopRecordingUI();
                }
            }, 300);
        }

        // ========================================
        // CONTROL DE GRABACIÃ“N
        // ========================================
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            if (!recognition) {
                showToast('Reconocimiento no disponible', 'error');
                return;
            }

            // Obtener stream (para visualizador y confirmar permiso)
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                setupAudioVisualizer(mediaStream);
            } catch(err) {
                console.error('[ScribePro] getUserMedia failed:', err);
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    onMicPermissionDenied();
                } else {
                    showToast('Error al acceder al micrÃ³fono: ' + err.message, 'error');
                }
                return;
            }

            // Iniciar reconocimiento
            try {
                recognition.lang = $('langSelect').value;
                recognition.continuous = (currentMode === 'continuous');
                recognition.interimResults = true;
                isRecording = true;
                recognition.start();
            } catch(err) {
                console.error('[ScribePro] recognition.start failed:', err);
                isRecording = false;
                // Si dice "already started", intentar detener y reiniciar
                if (err.message && err.message.includes('already started')) {
                    try { recognition.stop(); } catch(e) {}
                    setTimeout(() => startRecording(), 500);
                    return;
                }
                showToast('Error al iniciar: ' + err.message, 'error');
                cleanupAudio();
            }
        }

        function stopRecording() {
            console.log('[ScribePro] Stopping...');
            isRecording = false;
            recognitionRestarting = false;
            try { recognition.stop(); } catch(e) {}
            cleanupAudio();
            stopRecordingUI();
        }

        function stopRecordingUI() {
            isRecording = false;
            recognitionRestarting = false;
            setStatus('ready', 'Listo');
            recordBtn.classList.remove('active');
            recordBtn.style.background = 'linear-gradient(135deg, #6366f1, #9333ea)';
            recordIcon.className = 'fas fa-microphone text-3xl text-white';
            recordLabel.textContent = 'Toca para grabar';
            interimBox.classList.add('hidden');
            stopTimer();
            resetVisualizer();
        }

        // ========================================
        // VISUALIZADOR DE AUDIO
        // ========================================
        function setupAudioVisualizer(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 64;
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const bars = visualizer.querySelectorAll('.audio-bar');

                function animate() {
                    if (!isRecording) return;
                    analyser.getByteFrequencyData(dataArray);
                    bars.forEach((bar, i) => {
                        const v = dataArray[i % dataArray.length] || 0;
                        const h = Math.max(4, (v / 255) * 60);
                        bar.style.height = h + 'px';
                        bar.style.background = v > 128
                            ? `rgba(239, 68, 68, ${0.5 + v/510})`
                            : `rgba(99, 102, 241, ${0.3 + v/510})`;
                    });
                    animationId = requestAnimationFrame(animate);
                }
                animate();
            } catch(e) {
                console.warn('[ScribePro] Visualizer error:', e);
            }
        }

        function resetVisualizer() {
            const bars = visualizer.querySelectorAll('.audio-bar');
            bars.forEach(bar => {
                bar.style.height = '8px';
                bar.style.background = 'rgba(99, 102, 241, 0.3)';
            });
        }

        function cleanupAudio() {
            if (animationId) { cancelAnimationFrame(animationId); animationId = null; }
            if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
            if (audioContext && audioContext.state !== 'closed') { audioContext.close().catch(() => {}); audioContext = null; }
        }

        // ========================================
        // TIMER
        // ========================================
        function startTimer() {
            recordingSeconds = 0;
            updateTimerDisplay();
            recordTime.classList.remove('hidden');
            recordingTimer = setInterval(() => { recordingSeconds++; updateTimerDisplay(); }, 1000);
        }
        function stopTimer() {
            clearInterval(recordingTimer); recordingTimer = null;
            recordTime.classList.add('hidden'); recordingSeconds = 0;
        }
        function updateTimerDisplay() {
            const m = String(Math.floor(recordingSeconds / 60)).padStart(2, '0');
            const s = String(recordingSeconds % 60).padStart(2, '0');
            recordTime.textContent = `${m}:${s}`;
        }

        // ========================================
        // MODO
        // ========================================
        function setMode(mode) {
            currentMode = mode;
            const wasRec = isRecording;
            $('modeContinuous').className = mode === 'continuous'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30'
                : 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10';
            $('modeSingle').className = mode === 'single'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30'
                : 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10';
            if (wasRec) {
                stopRecording();
                setTimeout(() => { initRecognition(); startRecording(); }, 500);
            } else if (recognition) {
                initRecognition();
            }
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function setStatus(type, text) {
            statusDot.className = 'status-dot ' + type;
            statusText.textContent = text;
        }

        function updateCharCount() {
            const n = transcription.value.length;
            charCount.textContent = n + ' caracter' + (n !== 1 ? 'es' : '');
        }

        function copyText() {
            const t = transcription.value;
            if (!t) { showToast('No hay texto para copiar', 'warn'); return; }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(t).then(() => {
                    showToast('Texto copiado al portapapeles', 'success');
                }).catch(() => fallbackCopy());
            } else {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            transcription.select();
            transcription.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showToast('Texto copiado', 'success');
            } catch(e) {
                showToast('No se pudo copiar. Selecciona el texto manualmente.', 'error');
            }
        }

        function clearText() {
            if (transcription.value && !confirm('Â¿Borrar toda la transcripciÃ³n?')) return;
            transcription.value = '';
            updateCharCount();
        }

        function downloadText() {
            const t = transcription.value;
            if (!t) { showToast('No hay texto para descargar', 'warn'); return; }
            const blob = new Blob([t], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            a.download = `transcripcion_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Archivo descargado', 'success');
        }

        // ========================================
        // MODALES
        // ========================================
        function showModal(id) { $(id).classList.add('show'); }
        function closeModal(id) { $(id).classList.remove('show'); }

        // Cerrar modal al hacer click fuera
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.addEventListener('click', (e) => {
                if (e.target === m) closeModal(m.id);
            });
        });

        // ========================================
        // TOAST
        // ========================================
        let toastTimeout = null;
        function showToast(msg, type = 'info') {
            const toast = $('toast');
            const icon = $('toast-icon');
            const msgEl = $('toast-msg');
            const icons = {
                info: 'fas fa-info-circle text-blue-400',
                success: 'fas fa-check-circle text-green-400',
                error: 'fas fa-exclamation-circle text-red-400',
                warn: 'fas fa-triangle-exclamation text-amber-400'
            };
            icon.className = icons[type] || icons.info;
            msgEl.textContent = msg;
            clearTimeout(toastTimeout);
            toast.classList.add('show');
            toastTimeout = setTimeout(() => toast.classList.remove('show'), 4500);
        }
    </script>

</body>
</html>
