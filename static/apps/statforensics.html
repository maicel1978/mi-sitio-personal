<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatForensics v4.1 ‚Äî Auditor√≠a Estad√≠stica</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
:root{--bg:#f0f4f8;--card:#fff;--primary:#1a365d;--primary-l:#2b4c7e;--accent:#3182ce;--accent-l:#ebf8ff;--border:#e2e8f0;--border-d:#cbd5e0;--text:#1a202c;--text-m:#4a5568;--text-l:#718096;--green:#38a169;--green-bg:#f0fff4;--yellow:#d69e2e;--yellow-bg:#fffff0;--red:#e53e3e;--red-bg:#fff5f5;--orange:#dd6b20;--orange-bg:#fffaf0;--radius:10px;--shadow:0 1px 3px rgba(0,0,0,.08);--shadow-md:0 4px 6px rgba(0,0,0,.07)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding:12px;-webkit-font-smoothing:antialiased}
.app{max-width:720px;margin:0 auto}
.header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-l) 100%);color:#fff;padding:20px;border-radius:var(--radius);margin-bottom:12px;text-align:center;position:relative}
.header-top{display:flex;align-items:center;justify-content:center;gap:12px}
.header h1{font-size:1.4rem;font-weight:700}
.header p{font-size:.78rem;opacity:.8;margin-top:3px}
.badge{display:inline-block;background:rgba(255,255,255,.15);padding:2px 10px;border-radius:20px;font-size:.65rem;margin-top:6px}
.header-actions{position:absolute;right:14px;top:14px;display:flex;gap:6px}
.btn-header{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:.85rem;font-family:inherit;display:flex;align-items:center;gap:4px;transition:all .2s}
.btn-header:hover{background:rgba(255,255,255,.3)}
.btn-header:active{transform:scale(.95)}
.report-count{background:var(--red);color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700}
.quick-mode{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.quick-title{font-size:.85rem;font-weight:700;color:var(--primary);text-align:center;margin-bottom:12px}
.quick-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.quick-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;transition:all .2s;font-family:inherit}
.quick-btn:hover{border-color:var(--accent);background:var(--accent-l)}
.quick-btn:active{transform:scale(.97)}
.quick-icon{font-size:1.4rem}
.quick-label{font-size:.65rem;font-weight:600;color:var(--text-m);text-align:center;line-height:1.3}
.tabs-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:12px;scrollbar-width:none}
.tabs-wrap::-webkit-scrollbar{height:0}
.tabs{display:inline-flex;gap:2px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:3px;min-width:100%;box-shadow:var(--shadow)}
.tab{flex-shrink:0;padding:8px 11px;border:none;background:0 0;cursor:pointer;border-radius:7px;font-family:inherit;font-size:.68rem;font-weight:600;color:var(--text-l);transition:all .2s;white-space:nowrap;text-align:center}
.tab:hover{background:var(--bg);color:var(--text-m)}
.tab.active{background:var(--primary);color:#fff}
.tab.error{background:var(--red-bg);color:var(--red)}
.tab-icon{font-size:.85rem;margin-right:3px}
.panel{display:none;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:12px}
.panel.active{display:block}
.panel-head{padding:18px 20px;border-bottom:1px solid var(--border)}
.panel-head h3{font-size:.95rem;color:var(--primary);margin-bottom:4px}
.panel-head .desc{font-size:.74rem;color:var(--text-l);line-height:1.5}
.panel-head .ref{display:inline-block;margin-top:8px;font-size:.66rem;color:var(--accent);background:var(--accent-l);padding:2px 8px;border-radius:4px}
.panel-body{padding:18px 20px}
.form-row{display:grid;gap:10px;margin-bottom:12px}
.cols-2{grid-template-columns:1fr 1fr}
.cols-3{grid-template-columns:1fr 1fr 1fr}
.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
.fg{display:flex;flex-direction:column}
.fg label{font-size:.7rem;font-weight:600;color:var(--text);margin-bottom:2px}
.fg .hint{font-size:.64rem;color:var(--text-l);margin-bottom:2px;font-style:italic}
.fg input,.fg select,.fg textarea{padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:.82rem;background:#fafbfc;transition:border-color .2s;width:100%}
.fg textarea{resize:vertical;min-height:60px}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--accent);background:#fff}
.section-label{font-size:.68rem;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.5px;margin:14px 0 6px;padding-bottom:4px;border-bottom:2px solid var(--accent-l)}
.section-label:first-child{margin-top:0}
.btn{width:100%;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;margin-top:4px}
.btn:hover{background:var(--primary-l)}
.btn:active{transform:scale(.99)}
.btn-secondary{background:var(--bg);color:var(--text-m);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--border)}
.btn-sm{display:inline-flex;align-items:center;gap:4px;width:auto;padding:7px 14px;font-size:.74rem;margin-top:0;background:var(--accent);border-radius:6px;border:none;color:#fff;cursor:pointer;font-family:inherit;font-weight:600}
.btn-sm:hover{opacity:.9}
.entry-card{background:#f7fafc;border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;position:relative}
.entry-card .entry-title{font-size:.7rem;font-weight:700;color:var(--primary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.btn-remove{background:0 0;border:1px solid var(--red);color:var(--red);border-radius:5px;width:22px;height:22px;cursor:pointer;font-size:.7rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.btn-remove:hover{background:var(--red);color:#fff}
.results{margin-top:16px}
.rc{padding:11px 14px;border-radius:8px;margin-bottom:7px;border-left:4px solid;font-size:.82rem}
.rc.pass{background:var(--green-bg);border-color:var(--green)}
.rc.warn{background:var(--yellow-bg);border-color:var(--yellow)}
.rc.fail{background:var(--red-bg);border-color:var(--red)}
.rc.info{background:var(--accent-l);border-color:var(--accent)}
.rc-h{display:flex;align-items:center;gap:6px;font-weight:600;margin-bottom:3px;font-size:.8rem}
.rc-d{font-size:.74rem;color:var(--text-m);line-height:1.55}
.rc-d code{background:rgba(0,0,0,.05);padding:1px 5px;border-radius:3px;font-size:.72rem;font-family:'Courier New',monospace}
.question-card{margin-top:10px;padding:12px 14px;background:#faf5ff;border:1px solid #e9d8fd;border-left:4px solid #805ad5;border-radius:8px}
.question-card .q-title{font-size:.72rem;font-weight:700;color:#553c9a;margin-bottom:4px}
.question-card .q-text{font-size:.78rem;color:#4a5568;line-height:1.5;font-style:italic}
.question-card .q-copy{margin-top:6px;font-size:.66rem;color:#805ad5;cursor:pointer;text-decoration:underline}
.summary{display:flex;gap:12px;padding:10px 12px;background:var(--bg);border-radius:8px;margin-bottom:10px;flex-wrap:wrap}
.summary-i{display:flex;align-items:center;gap:5px;font-size:.76rem;font-weight:500}
.sdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sdot.g{background:var(--green)}.sdot.y{background:var(--yellow)}.sdot.r{background:var(--red)}
.big-display{text-align:center;padding:16px}
.big-number{font-size:3rem;font-weight:700;line-height:1}
.big-label{font-size:.82rem;font-weight:600;color:var(--text-m);margin-top:4px}
.note{margin-top:12px;padding:10px 12px;background:var(--bg);border-radius:8px;font-size:.68rem;color:var(--text-l);line-height:1.5}
.note strong{color:var(--text-m)}
.text-muted{color:var(--text-l);font-size:.8rem;font-style:italic}
.divider{border:none;border-top:1px solid var(--border);margin:12px 0}
.footer{text-align:center;font-size:.64rem;color:var(--text-l);margin-top:16px;padding:12px;line-height:1.6}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:10px 20px;border-radius:8px;font-size:.8rem;font-weight:500;box-shadow:var(--shadow-md);z-index:1000;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}
.capture-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:500;justify-content:center;align-items:flex-end}
.capture-modal.open{display:flex}
.capture-modal-content{background:var(--card);border-radius:16px 16px 0 0;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.capture-modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);font-size:.88rem;font-weight:700;color:var(--primary);position:sticky;top:0;background:var(--card);z-index:2}
.capture-modal-close{background:0 0;border:1px solid var(--border);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--text-m)}
.capture-modal-close:hover{background:var(--red-bg);border-color:var(--red);color:var(--red)}
.capture-modal-body{padding:16px 18px}
.capture-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:30px 20px;text-align:center;cursor:pointer;transition:all .2s;background:#fafbfc;position:relative;overflow:hidden}
.capture-zone:hover{border-color:var(--accent);background:var(--accent-l)}
.capture-zone:active{transform:scale(.99)}
.capture-zone.has-image{padding:0;border-style:solid;border-color:var(--accent)}
.capture-icon{font-size:2.4rem;margin-bottom:6px}
.capture-text{font-size:.82rem;color:var(--text-m);font-weight:600}
.capture-hint{font-size:.68rem;color:var(--text-l);margin-top:4px}
#capture-preview-img{width:100%;max-height:280px;object-fit:contain;display:block;transition:transform .2s}
.capture-controls{display:flex;gap:5px;padding:10px 0;flex-wrap:wrap;justify-content:center}
.cap-btn{padding:7px 12px;border:1px solid var(--border);background:#fff;border-radius:6px;font-size:.72rem;font-family:inherit;font-weight:500;cursor:pointer;color:var(--text-m);transition:all .2s}
.cap-btn:hover{background:var(--bg);border-color:var(--accent)}
.cap-btn:active{transform:scale(.96)}
.cap-btn.danger{border-color:var(--red);color:var(--red)}
.cap-btn.danger:hover{background:var(--red-bg)}
.capture-history{margin-top:12px;border-top:1px solid var(--border);padding-top:10px}
.cap-hist-title{font-size:.7rem;font-weight:700;color:var(--text-l);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.cap-hist-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg);border-radius:6px;margin-bottom:4px;cursor:pointer;transition:all .15s}
.cap-hist-item:hover{background:var(--accent-l)}
.cap-hist-item img{width:44px;height:44px;object-fit:cover;border-radius:4px;flex-shrink:0}
.cap-hist-item .cap-hist-info{flex:1;font-size:.72rem;color:var(--text-m)}
.cap-hist-item .cap-hist-time{font-size:.64rem;color:var(--text-l)}
.cap-hist-item .cap-hist-del{background:0 0;border:none;color:var(--text-l);cursor:pointer;font-size:.9rem;padding:4px}
.cap-hist-item .cap-hist-del:hover{color:var(--red)}
.float-ref-btn{position:fixed;bottom:16px;right:16px;z-index:300;width:50px;height:50px;border-radius:50%;background:var(--primary);color:#fff;border:3px solid #fff;font-size:1.3rem;cursor:pointer;box-shadow:0 3px 14px rgba(0,0,0,.3);display:none;align-items:center;justify-content:center;transition:all .2s}
.float-ref-btn.visible{display:flex}
.float-ref-btn:hover{transform:scale(1.08)}
.float-ref-btn:active{transform:scale(.95)}
.float-ref-btn.active{background:var(--accent);border-color:var(--accent-l)}
.float-ref-panel{position:fixed;z-index:299;background:#fff;border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.22);border:1px solid var(--border);overflow:hidden;display:none;bottom:76px;right:12px;width:min(92vw,380px)}
.float-ref-panel.open{display:block}
.float-ref-panel.size-small{max-height:35vh}
.float-ref-panel.size-large{max-height:60vh}
.float-ref-panel.size-full{top:0;left:0;right:0;bottom:0;width:100%;max-height:100vh;border-radius:0}
.float-ref-header{padding:6px 10px;background:var(--primary);color:#fff;font-size:.72rem;font-weight:600;display:flex;justify-content:space-between;align-items:center;user-select:none}
.float-ref-actions{display:flex;gap:2px}
.float-ref-action{background:rgba(255,255,255,.2);border:none;color:#fff;width:26px;height:26px;border-radius:4px;cursor:pointer;font-size:.82rem;display:flex;align-items:center;justify-content:center;transition:background .15s}
.float-ref-action:hover{background:rgba(255,255,255,.35)}
.float-ref-body{overflow:auto;-webkit-overflow-scrolling:touch;max-height:calc(100% - 38px);background:#f8f8f8;display:flex;align-items:center;justify-content:center}
#float-ref-img{width:100%;display:block;transition:transform .15s;transform-origin:center center;cursor:grab;user-select:none;-webkit-user-drag:none}
#float-ref-img:active{cursor:grabbing}
.float-ref-body.panning{cursor:grabbing}
@media(max-width:520px){body{padding:8px}.header h1{font-size:1.2rem}.cols-3{grid-template-columns:1fr 1fr}.cols-4{grid-template-columns:1fr 1fr}.quick-grid{grid-template-columns:repeat(3,1fr)}.quick-btn{padding:10px 4px}.quick-icon{font-size:1.2rem}.header-actions{right:10px;top:12px}.btn-header{padding:5px 8px;font-size:.8rem}.float-ref-panel{width:calc(100vw - 20px)}}
@media(max-width:380px){.quick-grid{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
<div class="app" id="app">
    <div class="header">
        <div class="header-top">
            <h1>‚öñÔ∏è StatForensics</h1>
            <div class="header-actions">
                <button class="btn-header" onclick="SF.capture.open()" title="Capturar tabla">üì∑</button>
                <button class="btn-header" onclick="SF.ui.showGlobalReport()" title="Ver resumen">üìã <span class="report-count" id="report-count">0</span></button>
            </div>
        </div>
        <p>Auditor√≠a de Integridad Estad√≠stica ¬∑ Ensayos Cl√≠nicos</p>
        <div class="badge">v4.1 ¬∑ Revisi√≥n regulatoria</div>
    </div>
    <div class="quick-mode">
        <div class="quick-title">üéØ ¬øQu√© est√°s mirando?</div>
        <div class="quick-grid">
            <button class="quick-btn" onclick="SF.ui.showTab('grim')"><span class="quick-icon">üî¢</span><span class="quick-label">Tabla con %<br>o medias</span></button>
            <button class="quick-btn" onclick="SF.ui.showTab('consistency')"><span class="quick-icon">üìä</span><span class="quick-label">Resultado<br>principal</span></button>
            <button class="quick-btn" onclick="SF.ui.showTab('baseline')"><span class="quick-icon">‚öñÔ∏è</span><span class="quick-label">Tabla<br>basal</span></button>
            <button class="quick-btn" onclick="SF.ui.showTab('fragility')"><span class="quick-icon">üíî</span><span class="quick-label">¬øResultado<br>fr√°gil?</span></button>
            <button class="quick-btn" onclick="SF.ui.showTab('subgroups')"><span class="quick-icon">üîÄ</span><span class="quick-label">An√°lisis de<br>subgrupos</span></button>
            <button class="quick-btn" onclick="SF.ui.showTab('consort')"><span class="quick-icon">üìâ</span><span class="quick-label">Flujo de<br>pacientes</span></button>
        </div>
    </div>
    <div class="tabs-wrap"><div class="tabs" id="main-tabs">
        <button class="tab" data-tab="grim"><span class="tab-icon">üî¢</span>GRIM</button>
        <button class="tab" data-tab="consistency"><span class="tab-icon">üîó</span>Consist.</button>
        <button class="tab" data-tab="pval"><span class="tab-icon">üìê</span>P-valor</button>
        <button class="tab" data-tab="ci"><span class="tab-icon">üìä</span>IC 95%</button>
        <button class="tab" data-tab="fragility"><span class="tab-icon">üíî</span>Fragil.</button>
        <button class="tab" data-tab="power"><span class="tab-icon">‚ö°</span>Potencia</button>
        <button class="tab" data-tab="nnt"><span class="tab-icon">üéØ</span>NNT</button>
        <button class="tab" data-tab="baseline"><span class="tab-icon">‚öñÔ∏è</span>Basal</button>
        <button class="tab" data-tab="consort"><span class="tab-icon">üìâ</span>CONSORT</button>
        <button class="tab" data-tab="subgroups"><span class="tab-icon">üîÄ</span>Subgrupos</button>
    </div></div>
    <div id="panels-container"></div>
    <div class="panel" id="panel-report" style="display:none">
        <div class="panel-head"><h3>üìã Resumen de Hallazgos</h3><div class="desc">Todos los resultados de esta sesi√≥n</div></div>
        <div class="panel-body">
            <div id="global-report-content"><p class="text-muted">A√∫n no hay an√°lisis realizados.</p></div>
            <button class="btn btn-secondary" onclick="SF.ui.copyReport()" style="margin-top:12px">üìã Copiar resumen</button>
            <button class="btn btn-secondary" onclick="SF.ui.clearReport()" style="margin-top:8px">üóëÔ∏è Limpiar sesi√≥n</button>
        </div>
    </div>
    <div class="footer">StatForensics v4.1 ¬∑ Herramienta de apoyo para revisi√≥n regulatoria<br>No sustituye inspecci√≥n de datos fuente ni juicio del evaluador<br><span id="modules-status"></span></div>
</div>

<!-- CAPTURA -->
<div class="capture-modal" id="capture-modal">
    <div class="capture-modal-content">
        <div class="capture-modal-header"><span>üì∑ Captura de Referencia</span><button class="capture-modal-close" onclick="SF.capture.close()">‚úï</button></div>
        <div class="capture-modal-body">
            <div class="capture-zone" id="capture-zone" onclick="document.getElementById('file-input').click()">
                <div id="capture-placeholder"><div class="capture-icon">üì∑</div><div class="capture-text">Toque para capturar tabla</div><div class="capture-hint">La imagen queda solo en su dispositivo</div></div>
                <div id="capture-preview-wrap" style="display:none"><img id="capture-preview-img" alt="Vista previa"></div>
            </div>
            <input type="file" id="file-input" accept="image/*" capture="environment" style="display:none" onchange="SF.capture.handleFile(event)">
            <div class="capture-controls" id="capture-controls" style="display:none">
                <button class="cap-btn" onclick="SF.capture.zoom(1)">üîç+</button>
                <button class="cap-btn" onclick="SF.capture.zoom(-1)">üîç‚àí</button>
                <button class="cap-btn" onclick="SF.capture.rotate()">üîÑ</button>
                <button class="cap-btn" onclick="SF.capture.pinToFloat()">üìå Usar como referencia</button>
                <button class="cap-btn danger" onclick="SF.capture.clear()">üóëÔ∏è</button>
            </div>
            <div class="capture-history" id="capture-history"></div>
        </div>
    </div>
</div>
<button class="float-ref-btn" id="float-ref-btn" onclick="SF.capture.toggleFloat()">üì∑</button>
<div class="float-ref-panel" id="float-ref-panel">
    <div class="float-ref-header"><span>üì∏ Referencia</span><div class="float-ref-actions">
        <button class="float-ref-action" onclick="SF.capture.floatZoom(1)">+</button>
        <button class="float-ref-action" onclick="SF.capture.floatZoom(-1)">‚àí</button>
        <button class="float-ref-action" onclick="SF.capture.floatResize()" id="float-resize-btn">‚¨Ü</button>
        <button class="float-ref-action" onclick="SF.capture.toggleFloat()">‚úï</button>
    </div></div>
    <div class="float-ref-body" id="float-ref-body"><img id="float-ref-img" src="" alt="Referencia" draggable="false"></div>
</div>
<div class="toast" id="toast"></div>

<script>
// ============================================================
// CORE.JS ‚Äî Utilidades matem√°ticas
// ============================================================
'use strict';
window.SF=window.SF||{};
SF.math=(function(){
function normalCDF(x){if(x===0)return .5;if(x<0)return 1-normalCDF(-x);var t=1/(1+.2316419*x),d=.3989422804014327;return 1-d*Math.exp(-x*x/2)*(t*(.31938153+t*(-.356563782+t*(1.781477937+t*(-1.821255978+t*1.330274429)))))}
function normalInv(p){if(p<=0)return-Infinity;if(p>=1)return Infinity;if(p===.5)return 0;if(p<.5)return-normalInv(1-p);var t=Math.sqrt(-2*Math.log(1-p)),c0=2.515517,c1=.802853,c2=.010328,d1=1.432788,d2=.189269,d3=.001308;return t-(c0+c1*t+c2*t*t)/(1+d1*t+d2*t*t+d3*t*t*t)}
function zPValue(z){return 2*(1-normalCDF(Math.abs(z)))}
function lnGamma(x){var c=[.99999999999980993,676.5203681218851,-1259.1392167224028,771.32342877765313,-176.61502916214059,12.507343278686905,-.13857109526572012,9.9843695780195716e-6,1.5056327351493116e-7];if(x<.5)return Math.log(Math.PI/Math.sin(Math.PI*x))-lnGamma(1-x);x-=1;var a=c[0],t=x+7.5;for(var i=1;i<9;i++)a+=c[i]/(x+i);return .5*Math.log(2*Math.PI)+(x+.5)*Math.log(t)-t+Math.log(a)}
function lnFactorial(n){return n<=1?0:lnGamma(n+1)}
function regBetaI(x,a,b){if(x===0)return 0;if(x===1)return 1;if(x<0||x>1)return NaN;if(x>(a+1)/(a+b+2))return 1-regBetaI(1-x,b,a);var front=Math.exp(a*Math.log(x)+b*Math.log(1-x)-lnGamma(a)-lnGamma(b)+lnGamma(a+b)),f=1,c2=1,d=1;for(var m=1;m<=300;m++){var num;if(m%2===1){var i2=(m-1)/2;num=-(a+i2)*(a+b+i2)*x/((a+2*i2)*(a+2*i2+1))}else{var i2=m/2;num=i2*(b-i2)*x/((a+2*i2-1)*(a+2*i2))}d=1+num*d;if(Math.abs(d)<1e-30)d=1e-30;d=1/d;c2=1+num/c2;if(Math.abs(c2)<1e-30)c2=1e-30;f*=c2*d;if(Math.abs(c2*d-1)<1e-10)break}return front*f/a}
function lowGammaReg(a,x){if(x===0)return 0;if(x<0)return NaN;if(x<a+1){var sum=0,term=1/a;for(var n=1;n<300;n++){sum+=term;term*=x/(a+n);if(Math.abs(term)<1e-12)break}return Math.exp(-x+a*Math.log(x)-lnGamma(a))*sum}return 1-upperGammaCF(a,x)}
function upperGammaCF(a,x){var f=x+1-a,c2=1/1e-30,d=1/f,h=d;for(var i=1;i<200;i++){var an=-i*(i-a),bn=x+2*i+1-a;d=bn+an*d;if(Math.abs(d)<1e-30)d=1e-30;c2=bn+an/c2;if(Math.abs(c2)<1e-30)c2=1e-30;d=1/d;var del=d*c2;h*=del;if(Math.abs(del-1)<1e-10)break}return Math.exp(-x+a*Math.log(x)-lnGamma(a))*h}
function tCDF(t,df){if(df<=0)return NaN;if(!isFinite(t))return t>0?1:0;if(df>200)return normalCDF(t);var x=df/(df+t*t);return t>=0?1-.5*regBetaI(x,df/2,.5):.5*regBetaI(x,df/2,.5)}
function tPValue(t,df){return 2*(1-tCDF(Math.abs(t),df))}
function chi2PValue(x,df){return x<=0||df<=0?1:1-lowGammaReg(df/2,x/2)}
function fPValue(f,df1,df2){return f<=0||df1<=0||df2<=0?1:regBetaI(df2/(df2+df1*f),df2/2,df1/2)}
function fisherExact(a,b,c,d){var n=a+b+c+d;function cp(a,b,c,d){return Math.exp(lnFactorial(a+b)+lnFactorial(c+d)+lnFactorial(a+c)+lnFactorial(b+d)-lnFactorial(a)-lnFactorial(b)-lnFactorial(c)-lnFactorial(d)-lnFactorial(n))}var pC=cp(a,b,c,d),pT=0;for(var i=Math.max(0,(a+c)-(c+d));i<=Math.min(a+c,a+b);i++){var j=(a+b)-i,k=(a+c)-i,l=n-i-j-k;if(j<0||k<0||l<0)continue;var p2=cp(i,j,k,l);if(p2<=pC+1e-12)pT+=p2}return Math.min(pT,1)}
function riskRatio(e1,n1,e2,n2){var r1=e1/n1,r2=e2/n2;if(r2===0)return{rr:Infinity,lo:NaN,hi:NaN};var rr=r1/r2,se=Math.sqrt(1/e1-1/n1+1/e2-1/n2);return{rr:rr,lo:Math.exp(Math.log(rr)-1.96*se),hi:Math.exp(Math.log(rr)+1.96*se),seLn:se}}
function oddsRatio(e1,n1,e2,n2){var a=e1,b=n1-e1,c=e2,d=n2-e2;if(b===0||c===0)return{or:Infinity,lo:NaN,hi:NaN};var or2=(a*d)/(b*c),se=Math.sqrt(1/a+1/b+1/c+1/d);return{or:or2,lo:Math.exp(Math.log(or2)-1.96*se),hi:Math.exp(Math.log(or2)+1.96*se),seLn:se}}
function nnt(e1,n1,e2,n2){var r1=e1/n1,r2=e2/n2,ard=r2-r1,se=Math.sqrt(r1*(1-r1)/n1+r2*(1-r2)/n2);return{nnt:ard===0?Infinity:1/Math.abs(ard),ard:ard,ardLo:ard-1.96*se,ardHi:ard+1.96*se,nntLo:1/Math.abs(ard+1.96*se),nntHi:1/Math.abs(ard-1.96*se),se:se,beneficial:ard>0}}
function round(v,d){d=d||4;return parseFloat(v.toFixed(d))}
function countDecimals(s){s=String(s);var p=s.indexOf('.');return p>=0?s.length-p-1:0}
return{normalCDF:normalCDF,normalInv:normalInv,zPValue:zPValue,tCDF:tCDF,tPValue:tPValue,chi2PValue:chi2PValue,fPValue:fPValue,lnGamma:lnGamma,lnFactorial:lnFactorial,regBetaI:regBetaI,fisherExact:fisherExact,riskRatio:riskRatio,oddsRatio:oddsRatio,nnt:nnt,round:round,countDecimals:countDecimals}
})();

// ============================================================
// UI.JS ‚Äî Sistema de UI + Captura
// ============================================================
SF.ui=(function(){
var state={activeTab:null,modules:{},findings:[],moduleErrors:[]};
function init(){
    document.querySelectorAll('.tab[data-tab]').forEach(function(tab){tab.addEventListener('click',function(){showTab(this.getAttribute('data-tab'))})});
    var count=0;for(var key in state.modules){if(state.modules[key]&&typeof state.modules[key].init==='function'){try{state.modules[key].init();count++}catch(e){console.error('Error init '+key+':',e);moduleError(key)}}}
    var st=document.getElementById('modules-status');if(st){var er=state.moduleErrors.length;st.textContent=count+'/10 m√≥dulos cargados'+(er>0?' ¬∑ '+er+' con error':'')}
    try{var sv=sessionStorage.getItem('sf-findings');if(sv){state.findings=JSON.parse(sv);updateReportCount()}}catch(e){}
}
function registerModule(id,mod){state.modules[id]=mod;var c=document.getElementById('panels-container');if(c&&typeof mod.getHTML==='function'){var p=document.createElement('div');p.className='panel';p.id='panel-'+id;p.innerHTML=mod.getHTML();c.appendChild(p)}}
function moduleError(id){state.moduleErrors.push(id);var t=document.querySelector('.tab[data-tab="'+id+'"]');if(t){t.classList.add('error');t.title='M√≥dulo no cargado'}var c=document.getElementById('panels-container');if(c){var p=document.createElement('div');p.className='panel';p.id='panel-'+id;p.innerHTML='<div class="panel-body"><div class="rc fail"><div class="rc-h">‚ö†Ô∏è M√≥dulo no disponible</div><div class="rc-d">mod-'+id+'.js no cargado.</div></div></div>';c.appendChild(p)}}
function showTab(id){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});var tab=document.querySelector('.tab[data-tab="'+id+'"]');if(tab)tab.classList.add('active');var panel=document.getElementById('panel-'+id);if(panel)panel.classList.add('active');var rp=document.getElementById('panel-report');if(rp)rp.style.display='none';state.activeTab=id;if(tab)tab.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'})}
var ICONS={pass:'üü¢',warn:'üü°',fail:'üî¥',info:'‚ÑπÔ∏è'};
function rc(l,t,d){return'<div class="rc '+l+'"><div class="rc-h">'+(ICONS[l]||'')+' '+t+'</div><div class="rc-d">'+d+'</div></div>'}
function summaryBar(c){return'<div class="summary"><div class="summary-i"><div class="sdot g"></div>'+(c.pass||0)+' OK</div><div class="summary-i"><div class="sdot y"></div>'+(c.warn||0)+' Advertencias</div><div class="summary-i"><div class="sdot r"></div>'+(c.fail||0)+' Inconsistencias</div></div>'}
function questionCard(q){var id='q-'+Date.now()+'-'+Math.random().toString(36).substr(2,5);return'<div class="question-card"><div class="q-title">üí¨ Pregunta sugerida:</div><div class="q-text" id="'+id+'">"'+q+'"</div><div class="q-copy" onclick="SF.ui.copyText(\''+id+'\')">üìã Copiar pregunta</div></div>'}
function bigNumber(v,l,c){return'<div class="big-display"><div class="big-number" style="color:'+(c||'var(--primary)')+'">'+v+'</div><div class="big-label">'+l+'</div></div>'}
function addFinding(m,l,t,d){state.findings.push({module:m,level:l,title:t,detail:d,time:new Date().toLocaleTimeString()});updateReportCount();try{sessionStorage.setItem('sf-findings',JSON.stringify(state.findings))}catch(e){}}
function updateReportCount(){var el=document.getElementById('report-count');if(el){var f=state.findings.filter(function(x){return x.level==='fail'}).length;el.textContent=f;el.style.background=f>0?'var(--red)':'var(--green)'}}
function showGlobalReport(){document.querySelectorAll('.panel').forEach(function(p){p.classList.remove('active')});document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});var panel=document.getElementById('panel-report'),content=document.getElementById('global-report-content');if(state.findings.length===0){content.innerHTML='<p class="text-muted">A√∫n no hay an√°lisis realizados.</p>'}else{var html='',counts={pass:0,warn:0,fail:0};state.findings.forEach(function(f){if(counts[f.level]!==undefined)counts[f.level]++});html+=summaryBar(counts)+'<div class="divider"></div>';var byM={};state.findings.forEach(function(f){if(!byM[f.module])byM[f.module]=[];byM[f.module].push(f)});for(var mod in byM){html+='<div class="section-label">'+mod+'</div>';byM[mod].forEach(function(f){html+=rc(f.level,f.title,f.detail+' <small>('+f.time+')</small>')})}content.innerHTML=html}panel.style.display='block'}
function copyReport(){var text='=== STATFORENSICS ‚Äî RESUMEN ===\nFecha: '+new Date().toLocaleString()+'\n\n';var c={pass:0,warn:0,fail:0};state.findings.forEach(function(f){if(c[f.level]!==undefined)c[f.level]++});text+='RESUMEN: '+c.pass+' OK, '+c.warn+' Advert., '+c.fail+' Inconsist.\n\n';state.findings.forEach(function(f){var i=f.level==='pass'?'‚úì':f.level==='warn'?'‚ö†':'‚úó';text+='['+i+'] ['+f.module+'] '+f.title+'\n';var tmp=document.createElement('div');tmp.innerHTML=f.detail;text+='    '+tmp.textContent+'\n\n'});text+='=== FIN ===';copyToClipboard(text)}
function clearReport(){state.findings=[];updateReportCount();try{sessionStorage.removeItem('sf-findings')}catch(e){}showGlobalReport();showToast('Sesi√≥n limpiada')}
function copyText(id){var el=document.getElementById(id);if(el)copyToClipboard(el.textContent)}
function copyToClipboard(t){if(navigator.clipboard){navigator.clipboard.writeText(t).then(function(){showToast('Copiado ‚úì')})}else{var ta=document.createElement('textarea');ta.value=t;ta.style.position='fixed';ta.style.left='-9999px';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('Copiado ‚úì')}}
function showToast(m){var t=document.getElementById('toast');if(t){t.textContent=m;t.classList.add('show');setTimeout(function(){t.classList.remove('show')},2000)}}
function getNum(id){var el=document.getElementById(id);return el?parseFloat(el.value):NaN}
function getInt(id){var el=document.getElementById(id);return el?parseInt(el.value):NaN}
function getStr(id){var el=document.getElementById(id);return el?el.value:''}
return{init:init,registerModule:registerModule,moduleError:moduleError,showTab:showTab,rc:rc,summaryBar:summaryBar,questionCard:questionCard,bigNumber:bigNumber,addFinding:addFinding,showGlobalReport:showGlobalReport,copyReport:copyReport,clearReport:clearReport,copyText:copyText,copyToClipboard:copyToClipboard,showToast:showToast,getNum:getNum,getInt:getInt,getStr:getStr}
})();

// ============================================================
// CAPTURE SYSTEM
// ============================================================
SF.capture=(function(){
var cs={images:[],activeImage:null,rotation:0,zoom:1,floatOpen:false,floatSize:'small',floatZoomLevel:1,panStartX:0,panStartY:0,panOffsetX:0,panOffsetY:0,isPanning:false};
var SIZES=['small','large','full'];
function init(){
    var body=document.getElementById('float-ref-body');
    if(body){body.addEventListener('touchstart',panStart,{passive:false});body.addEventListener('touchmove',panMove,{passive:false});body.addEventListener('touchend',panEnd);body.addEventListener('mousedown',panStart);body.addEventListener('mousemove',panMove);body.addEventListener('mouseup',panEnd);body.addEventListener('mouseleave',panEnd);
    var lastDist=0;body.addEventListener('touchstart',function(e){if(e.touches.length===2){lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY)}},{passive:false});body.addEventListener('touchmove',function(e){if(e.touches.length===2){e.preventDefault();var dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(lastDist>0){cs.floatZoomLevel=Math.max(.5,Math.min(5,cs.floatZoomLevel*(dist/lastDist)));applyFloatTransform()}lastDist=dist}},{passive:false})}
    try{var si=sessionStorage.getItem('sf-capture-active');if(si){cs.activeImage=si;document.getElementById('float-ref-btn').classList.add('visible')}}catch(e){}
}
function open(){document.getElementById('capture-modal').classList.add('open');renderHistory();if(cs.activeImage)showPreview(cs.activeImage)}
function close(){document.getElementById('capture-modal').classList.remove('open')}
function handleFile(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){var data=ev.target.result;cs.images.push({data:data,time:new Date().toLocaleTimeString()});showPreview(data);setActive(data);renderHistory();SF.ui.showToast('Imagen capturada ‚úì')};reader.readAsDataURL(file);e.target.value=''}
function showPreview(data){var img=document.getElementById('capture-preview-img');img.src=data;cs.rotation=0;cs.zoom=1;img.style.transform='';document.getElementById('capture-placeholder').style.display='none';document.getElementById('capture-preview-wrap').style.display='block';document.getElementById('capture-zone').classList.add('has-image');document.getElementById('capture-controls').style.display='flex'}
function setActive(data){cs.activeImage=data;cs.floatZoomLevel=1;cs.panOffsetX=0;cs.panOffsetY=0;document.getElementById('float-ref-img').src=data;document.getElementById('float-ref-img').style.transform='';document.getElementById('float-ref-btn').classList.add('visible');try{sessionStorage.setItem('sf-capture-active',data)}catch(e){}}
function zoom(dir){cs.zoom=Math.max(.5,Math.min(4,cs.zoom+dir*.3));document.getElementById('capture-preview-img').style.transform='scale('+cs.zoom+') rotate('+cs.rotation+'deg)'}
function rotate(){cs.rotation=(cs.rotation+90)%360;document.getElementById('capture-preview-img').style.transform='scale('+cs.zoom+') rotate('+cs.rotation+'deg)'}
function pinToFloat(){if(!cs.activeImage)return;close();cs.floatOpen=true;cs.floatZoomLevel=1;cs.panOffsetX=0;cs.panOffsetY=0;updateFloatPanel();SF.ui.showToast('Referencia fijada üìå')}
function clear(){cs.activeImage=null;cs.rotation=0;cs.zoom=1;document.getElementById('capture-preview-img').src='';document.getElementById('capture-placeholder').style.display='';document.getElementById('capture-preview-wrap').style.display='none';document.getElementById('capture-zone').classList.remove('has-image');document.getElementById('capture-controls').style.display='none';document.getElementById('float-ref-btn').classList.remove('visible');document.getElementById('float-ref-panel').classList.remove('open');cs.floatOpen=false;try{sessionStorage.removeItem('sf-capture-active')}catch(e){};SF.ui.showToast('Imagen eliminada')}
function toggleFloat(){if(!cs.activeImage){open();return}cs.floatOpen=!cs.floatOpen;updateFloatPanel()}
function updateFloatPanel(){var p=document.getElementById('float-ref-panel'),b=document.getElementById('float-ref-btn');p.classList.toggle('open',cs.floatOpen);b.classList.toggle('active',cs.floatOpen);if(cs.floatOpen&&cs.activeImage){document.getElementById('float-ref-img').src=cs.activeImage;applyFloatTransform()}SIZES.forEach(function(s){p.classList.remove('size-'+s)});p.classList.add('size-'+cs.floatSize)}
function floatZoom(dir){cs.floatZoomLevel=Math.max(.5,Math.min(5,cs.floatZoomLevel+dir*.4));applyFloatTransform()}
function floatResize(){var idx=SIZES.indexOf(cs.floatSize);cs.floatSize=SIZES[(idx+1)%SIZES.length];var p=document.getElementById('float-ref-panel');SIZES.forEach(function(s){p.classList.remove('size-'+s)});p.classList.add('size-'+cs.floatSize);var icons={small:'‚¨Ü',large:'‚¨Ü‚¨Ü',full:'‚¨á'};document.getElementById('float-resize-btn').textContent=icons[cs.floatSize]||'‚¨Ü'}
function applyFloatTransform(){document.getElementById('float-ref-img').style.transform='scale('+cs.floatZoomLevel+') translate('+cs.panOffsetX+'px,'+cs.panOffsetY+'px)'}
function panStart(e){if(cs.floatZoomLevel<=1)return;cs.isPanning=true;var pt=e.touches?e.touches[0]:e;cs.panStartX=pt.clientX-cs.panOffsetX;cs.panStartY=pt.clientY-cs.panOffsetY;document.getElementById('float-ref-body').classList.add('panning')}
function panMove(e){if(!cs.isPanning)return;var pt=e.touches?e.touches[0]:e;cs.panOffsetX=pt.clientX-cs.panStartX;cs.panOffsetY=pt.clientY-cs.panStartY;applyFloatTransform();if(e.type==='touchmove')e.preventDefault()}
function panEnd(){cs.isPanning=false;document.getElementById('float-ref-body').classList.remove('panning')}
function renderHistory(){var c=document.getElementById('capture-history');if(!c)return;if(cs.images.length===0){c.innerHTML='';return}var html='<div class="cap-hist-title">Capturas ('+cs.images.length+')</div>';cs.images.forEach(function(img,idx){var isA=img.data===cs.activeImage;html+='<div class="cap-hist-item"'+(isA?' style="border-left:3px solid var(--accent)"':'')+'><img src="'+img.data+'" onclick="SF.capture.useFromHistory('+idx+')"><div class="cap-hist-info">Captura '+(idx+1)+(isA?' <strong>(activa)</strong>':'')+'<div class="cap-hist-time">'+img.time+'</div></div><button class="cap-hist-del" onclick="SF.capture.deleteFromHistory('+idx+')">üóëÔ∏è</button></div>'});c.innerHTML=html}
function useFromHistory(idx){if(cs.images[idx]){showPreview(cs.images[idx].data);setActive(cs.images[idx].data);renderHistory()}}
function deleteFromHistory(idx){var wasA=cs.images[idx]&&cs.images[idx].data===cs.activeImage;cs.images.splice(idx,1);renderHistory();if(wasA){if(cs.images.length>0){var last=cs.images[cs.images.length-1];showPreview(last.data);setActive(last.data)}else clear()}}
return{init:init,open:open,close:close,handleFile:handleFile,zoom:zoom,rotate:rotate,pinToFloat:pinToFloat,clear:clear,toggleFloat:toggleFloat,floatZoom:floatZoom,floatResize:floatResize,useFromHistory:useFromHistory,deleteFromHistory:deleteFromHistory}
})();

// ============================================================
// M√ìDULOS ‚Äî PARTE 2 y 3 van a continuaci√≥n
// ============================================================

// ============================================================
// M√ìDULO 1: GRIM
// ============================================================
(function(){
var MID='grim',MNAME='GRIM Test',rowCount=0;
function getHTML(){return'<div class="panel-head"><h3>üî¢ GRIM Test ‚Äî Verificaci√≥n de Proporciones y Medias</h3><div class="desc">Verifica si cada valor reportado (% o media) es matem√°ticamente posible dado el N del grupo. Solo aplica a conteos enteros, proporciones o escalas Likert.</div><span class="ref">üìÑ Brown & Heathers (2017). Soc Psychol Personal Sci, 8(4), 363-369.</span></div><div class="panel-body"><div class="note" style="margin-top:0;margin-bottom:14px"><strong>‚ö†Ô∏è Limitaci√≥n:</strong> NO aplica a variables continuas (peso, presi√≥n arterial, biomarcadores).</div><div id="grim-rows"></div><div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn-sm" onclick="SF.modules.grim.addRow()">+ Agregar grupo</button><button class="btn-sm" style="background:var(--text-l)" onclick="SF.modules.grim.addCommonPreset()">üìã Ejemplo</button></div><button class="btn" onclick="SF.modules.grim.run()">Verificar Todos los Grupos</button><div class="results" id="grim-results"></div></div>'}
function addRow(name,n,val,type){rowCount++;var id=rowCount,c=document.getElementById('grim-rows');if(!c)return;var div=document.createElement('div');div.className='entry-card';div.id='grim-r-'+id;div.innerHTML='<div class="entry-title"><span>Grupo '+id+'</span><button class="btn-remove" onclick="SF.modules.grim.removeRow('+id+')">√ó</button></div><div class="form-row cols-2"><div class="fg"><label>Nombre</label><input type="text" id="gr-name-'+id+'" value="'+(name||'Grupo '+id)+'"></div><div class="fg"><label>Tipo</label><select id="gr-type-'+id+'"><option value="pct"'+(type==='pct'||!type?' selected':'')+'>Porcentaje (%)</option><option value="mean"'+(type==='mean'?' selected':'')+'>Media discreta</option></select></div></div><div class="form-row cols-2"><div class="fg"><label>N del grupo</label><input type="number" id="gr-n-'+id+'" value="'+(n||'')+'" min="1"></div><div class="fg"><label>Valor reportado</label><input type="number" id="gr-val-'+id+'" step="0.01" value="'+(val||'')+'"></div></div>';c.appendChild(div)}
function removeRow(id){var el=document.getElementById('grim-r-'+id);if(el)el.remove()}
function addCommonPreset(){var c=document.getElementById('grim-rows');if(c)c.innerHTML='';rowCount=0;addRow('Tratamiento',101,22.8,'pct');addRow('Control',99,31.3,'pct');addRow('Total',200,27.0,'pct');SF.ui.showToast('Ejemplo cargado')}
function grimTest(n,val,type){if(isNaN(n)||isNaN(val)||n<=0)return{valid:false,error:'Datos incompletos'};var valStr=String(val),decPos=valStr.indexOf('.'),rDec=decPos>=0?valStr.length-decPos-1:0;var product=type==='pct'?(val/100)*n:val*n;var matchK=Math.round(product),consistent=false,bestK=matchK,range=Math.max(3,Math.ceil(n*0.01));for(var k=Math.max(0,matchK-range);k<=matchK+range;k++){var recon=type==='pct'?parseFloat(((k/n)*100).toFixed(rDec)):parseFloat((k/n).toFixed(rDec));if(recon===val){consistent=true;bestK=k;break}}var below=Math.floor(product),above=Math.ceil(product);var vB=type==='pct'?parseFloat(((below/n)*100).toFixed(rDec)):parseFloat((below/n).toFixed(rDec));var vA=type==='pct'?parseFloat(((above/n)*100).toFixed(rDec)):parseFloat((above/n).toFixed(rDec));return{valid:true,consistent:consistent,reportedValue:val,reportedDecimals:rDec,n:n,type:type,matchK:bestK,nearestBelow:{k:below,value:vB},nearestAbove:{k:above,value:vA}}}
function run(){var html='',counts={pass:0,warn:0,fail:0},anyData=false;for(var i=1;i<=rowCount;i++){if(!document.getElementById('grim-r-'+i))continue;anyData=true;var name=SF.ui.getStr('gr-name-'+i)||'Grupo '+i,n=SF.ui.getInt('gr-n-'+i),val=SF.ui.getNum('gr-val-'+i),type=SF.ui.getStr('gr-type-'+i);var r=grimTest(n,val,type);if(!r.valid){html+=SF.ui.rc('warn',name+': Datos incompletos',r.error);counts.warn++;continue}var unit=type==='pct'?'%':'';if(r.consistent){var d=type==='pct'?'<code>'+r.matchK+'/'+n+' = '+((r.matchK/n)*100).toFixed(r.reportedDecimals)+'%</code> ‚úì':'Suma=<code>'+r.matchK+'</code>, media=<code>'+(r.matchK/n).toFixed(r.reportedDecimals)+'</code> ‚úì';html+=SF.ui.rc('pass',name+': Consistente',d);counts.pass++;SF.ui.addFinding(MNAME,'pass',name+': consistente',val+unit+' con N='+n+' es posible')}else{var d='<code>'+val+unit+'</code> no es posible con N='+n+'.<br>Cercanos: <code>'+r.nearestBelow.value+unit+'</code> (k='+r.nearestBelow.k+') y <code>'+r.nearestAbove.value+unit+'</code> (k='+r.nearestAbove.k+').';var minDiff=Math.min(Math.abs(val-r.nearestBelow.value),Math.abs(val-r.nearestAbove.value));if(minDiff<=0.1&&type==='pct')d+='<br><em>Discrepancia peque√±a ('+minDiff.toFixed(2)+'pp). Posible redondeo.</em>';html+=SF.ui.rc('fail',name+': INCONSISTENTE',d);counts.fail++;SF.ui.addFinding(MNAME,'fail',name+': INCONSISTENTE',val+unit+' imposible con N='+n)}}if(!anyData){html=SF.ui.rc('warn','Sin datos','Agregue al menos un grupo.')}else{if(counts.fail>0){var q=counts.fail===1?'He verificado los porcentajes de su tabla y uno de los valores no es matem√°ticamente posible dado el N. ¬øPodr√≠an revisar el c√°lculo?':'He encontrado '+counts.fail+' valores imposibles dados los N reportados. ¬øPodr√≠an facilitar la tabla con numeradores exactos?';html+=SF.ui.questionCard(q)}html=SF.ui.summaryBar(counts)+html}document.getElementById('grim-results').innerHTML=html}
function init(){addRow('Tratamiento','','','pct');addRow('Control','','','pct')}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.grim={addRow:addRow,removeRow:removeRow,addCommonPreset:addCommonPreset,run:run}
})();

// ============================================================
// M√ìDULO 2: CONSISTENCIA
// ============================================================
(function(){
var MID='consistency',MNAME='Consistencia Interna';
function getHTML(){return'<div class="panel-head"><h3>üîó Consistencia Interna de Tablas</h3><div class="desc">Verifica N, porcentajes, medida de efecto, simetr√≠a del IC y coherencia p-valor vs IC.</div><span class="ref">üìÑ ICH E9 ¬∑ Principios DEBIT (Heathers, 2015)</span></div><div class="panel-body"><div class="section-label">Tama√±os de muestra</div><div class="form-row cols-3"><div class="fg"><label>N total</label><input type="number" id="c-ntotal" placeholder="200"></div><div class="fg"><label>N tratamiento</label><input type="number" id="c-n1" placeholder="101"></div><div class="fg"><label>N control</label><input type="number" id="c-n2" placeholder="99"></div></div><div class="section-label">Desenlace principal</div><div class="form-row cols-2"><div class="fg"><label>Eventos tto</label><input type="number" id="c-e1" placeholder="23"></div><div class="fg"><label>% reportado tto</label><input type="number" id="c-p1" step="0.1" placeholder="22.8"></div></div><div class="form-row cols-2"><div class="fg"><label>Eventos ctrl</label><input type="number" id="c-e2" placeholder="31"></div><div class="fg"><label>% reportado ctrl</label><input type="number" id="c-p2" step="0.1" placeholder="31.3"></div></div><div class="section-label">Medida de efecto</div><div class="form-row cols-2"><div class="fg"><label>Tipo</label><select id="c-effect-type"><option value="rr">RR</option><option value="or">OR</option><option value="rd">RD</option><option value="hr">HR</option></select></div><div class="fg"><label>Valor reportado</label><input type="number" id="c-effect-val" step="0.01" placeholder="0.73"></div></div><div class="section-label">IC y p-valor</div><div class="form-row cols-3"><div class="fg"><label>IC 95% inf</label><input type="number" id="c-ci-lo" step="0.01" placeholder="0.45"></div><div class="fg"><label>IC 95% sup</label><input type="number" id="c-ci-hi" step="0.01" placeholder="1.18"></div><div class="fg"><label>p-valor</label><input type="number" id="c-pval" step="0.001" placeholder="0.19"></div></div><button class="btn" onclick="SF.modules.consistency.run()">Verificar Consistencia</button><div class="results" id="consistency-results"></div></div>'}
function run(){var nT=SF.ui.getInt('c-ntotal'),n1=SF.ui.getInt('c-n1'),n2=SF.ui.getInt('c-n2'),e1=SF.ui.getInt('c-e1'),p1=SF.ui.getNum('c-p1'),e2=SF.ui.getInt('c-e2'),p2=SF.ui.getNum('c-p2'),eType=SF.ui.getStr('c-effect-type'),eVal=SF.ui.getNum('c-effect-val'),ciLo=SF.ui.getNum('c-ci-lo'),ciHi=SF.ui.getNum('c-ci-hi'),pval=SF.ui.getNum('c-pval');var html='',c={pass:0,warn:0,fail:0},questions=[];
function add(l,t,d){html+=SF.ui.rc(l,t,d);if(c[l]!==undefined)c[l]++;SF.ui.addFinding(MNAME,l,t,d)}
// N total
if(!isNaN(nT)&&!isNaN(n1)&&!isNaN(n2)){if(n1+n2===nT)add('pass','N total consistente','<code>'+n1+'+'+n2+'='+nT+'</code> ‚úì');else add('fail','N total INCONSISTENTE','<code>'+n1+'+'+n2+'='+(n1+n2)+' ‚â† '+nT+'</code>. Diferencia: '+Math.abs(n1+n2-nT))}
// Porcentajes
[{nm:'Tratamiento',e:e1,n:n1,rep:p1},{nm:'Control',e:e2,n:n2,rep:p2}].forEach(function(g){if(isNaN(g.e)||isNaN(g.n)||isNaN(g.rep)||g.n<=0)return;if(g.e>g.n){add('fail','% '+g.nm+': eventos>N','<code>'+g.e+'>'+g.n+'</code>');return}var calc=(g.e/g.n)*100,d=Math.abs(calc-g.rep);if(d<0.15)add('pass','% '+g.nm+' correcto','<code>'+g.e+'/'+g.n+'='+calc.toFixed(1)+'%</code> (rep:'+g.rep+'%) ‚úì');else if(d<0.6)add('warn','% '+g.nm+': discrepancia menor','<code>'+g.e+'/'+g.n+'='+calc.toFixed(2)+'%</code> vs <code>'+g.rep+'%</code>. Dif:'+d.toFixed(2)+'pp');else add('fail','% '+g.nm+': INCONSISTENTE','<code>'+g.e+'/'+g.n+'='+calc.toFixed(2)+'%</code> ‚â† <code>'+g.rep+'%</code>. Dif:'+d.toFixed(2)+'pp')});
// Medida de efecto
if(!isNaN(e1)&&!isNaN(n1)&&!isNaN(e2)&&!isNaN(n2)&&!isNaN(eVal)){var r1=e1/n1,r2=e2/n2,calcE,label;if(eType==='rr'){calcE=r2>0?r1/r2:Infinity;label='RR';var rr=SF.math.riskRatio(e1,n1,e2,n2);html+=''}else if(eType==='or'){var a=e1,b=n1-e1,cc=e2,d2=n2-e2;calcE=(b===0||cc===0)?Infinity:(a*d2)/(b*cc);label='OR'}else if(eType==='rd'){calcE=r1-r2;label='RD'}else{add('warn','HR no verificable desde tabla 2√ó2','Requiere datos de tiempo al evento.');calcE=null}if(calcE!==null){var rel=Math.abs(calcE-eVal)/Math.max(Math.abs(eVal),0.001)*100;if(rel<2)add('pass',label+' consistente','Recalc:<code>'+calcE.toFixed(4)+'</code> vs rep:<code>'+eVal+'</code> ('+rel.toFixed(1)+'%) ‚úì');else if(rel<10)add('warn',label+': discrepancia '+rel.toFixed(1)+'%','Recalc:<code>'+calcE.toFixed(4)+'</code> vs rep:<code>'+eVal+'</code>. ¬øAjuste por covariables?');else add('fail',label+': INCONSISTENTE '+rel.toFixed(1)+'%','Recalc:<code>'+calcE.toFixed(4)+'</code> ‚â† rep:<code>'+eVal+'</code>')}}
// Simetr√≠a IC log
if(eType!=='rd'&&!isNaN(eVal)&&!isNaN(ciLo)&&!isNaN(ciHi)&&eVal>0&&ciLo>0&&ciHi>0){var lE=Math.log(eVal),lL=Math.log(ciLo),lH=Math.log(ciHi),dL=lE-lL,dH=lH-lE,asym=(dL+dH>0)?Math.abs(dL-dH)/((dL+dH)/2)*100:0;if(asym<5)add('pass','IC sim√©trico (log)','Asimetr√≠a:'+asym.toFixed(1)+'% ‚úì');else if(asym<15)add('warn','IC ligeramente asim√©trico','Asimetr√≠a:'+asym.toFixed(1)+'%');else add('fail','IC MUY asim√©trico','Asimetr√≠a:'+asym.toFixed(1)+'%')}
// p vs IC
if(!isNaN(pval)&&!isNaN(ciLo)&&!isNaN(ciHi)){var nullV=eType==='rd'?0:1,ciNull=ciLo<=nullV&&ciHi>=nullV,pSig=pval<0.05;if(pSig&&ciNull){add('fail','CONTRADICCI√ìN: p<0.05 pero IC incluye nulo','p='+pval+', IC('+ciLo+','+ciHi+') incluye '+nullV);questions.push('Observo contradicci√≥n entre p='+pval+' y el IC ('+ciLo+' ‚Äì '+ciHi+'). ¬øProvienen del mismo an√°lisis?')}else if(!pSig&&!ciNull)add('fail','CONTRADICCI√ìN: p‚â•0.05 pero IC excluye nulo','p='+pval+', IC excluye '+nullV);else add('pass','p coherente con IC','p='+pval+' '+(pSig?'<':'‚â•')+'0.05, IC '+(ciNull?'incluye':'excluye')+' '+nullV+' ‚úì')}
// Rec√°lculo p
if(!isNaN(e1)&&!isNaN(n1)&&!isNaN(e2)&&!isNaN(n2)&&!isNaN(pval)&&n1>0&&n2>0){var r1b=e1/n1,r2b=e2/n2,pP=(e1+e2)/(n1+n2),se=Math.sqrt(pP*(1-pP)*(1/n1+1/n2));if(se>0){var z=Math.abs(r1b-r2b)/se,calcP=SF.math.zPValue(z);var a2=e1,b2=n1-e1,c2=e2,d3=n2-e2,n=n1+n2,chi2Y=0;if((a2+b2)>0&&(c2+d3)>0&&(a2+c2)>0&&(b2+d3)>0){var num2=n*Math.pow(Math.abs(a2*d3-b2*c2)-n/2,2);chi2Y=num2/((a2+b2)*(c2+d3)*(a2+c2)*(b2+d3))}var calcPY=SF.math.chi2PValue(chi2Y,1);var bestP=Math.abs(calcP-pval)<Math.abs(calcPY-pval)?calcP:calcPY,bestM=bestP===calcP?'Z-test':'œá¬≤(Yates)';var ratio=Math.max(bestP,pval)/Math.max(Math.min(bestP,pval),1e-10);if(ratio<1.5)add('pass','p recalculado OK','p('+bestM+')‚âà<code>'+bestP.toFixed(4)+'</code> vs rep:<code>'+pval+'</code> ‚úì');else if(ratio<3)add('warn','p: discrepancia moderada','p('+bestM+')‚âà<code>'+bestP.toFixed(4)+'</code> vs rep:<code>'+pval+'</code> ('+ratio.toFixed(1)+'x)');else add('fail','p MUY INCONSISTENTE','p recalc‚âà<code>'+bestP.toFixed(4)+'</code> ‚â† rep:<code>'+pval+'</code> ('+ratio.toFixed(1)+'x)');if((bestP<0.05)!==(pval<0.05))add('fail','‚ö†Ô∏è Cruza umbral 0.05','Recalc:'+(bestP<0.05?'sig.':'no sig.')+' vs rep:'+(pval<0.05?'sig.':'no sig.'))}}
questions.forEach(function(q){html+=SF.ui.questionCard(q)});if(eType==='hr')html+='<div class="note"><strong>Nota HR:</strong> No recalculable desde tabla 2√ó2.</div>';html=SF.ui.summaryBar(c)+html;document.getElementById('consistency-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.consistency={run:run}
})();

// ============================================================
// M√ìDULO 3: REC√ÅLCULO DE P-VALORES
// ============================================================
(function(){
var MID='pval',MNAME='Rec√°lculo P-valores',rowCount=0;
function getHTML(){return'<div class="panel-head"><h3>üìê Rec√°lculo de P-valores</h3><div class="desc">Verifica p-valores dado el estad√≠stico (t, z, œá¬≤, F) y grados de libertad.</div><span class="ref">üìÑ Nuijten et al. (2016). Behavior Research Methods (statcheck).</span></div><div class="panel-body"><div class="note" style="margin-top:0;margin-bottom:14px"><strong>Contexto:</strong> ~50% de papers tienen al menos un p inconsistente. En ~13% cambia la significaci√≥n.</div><div id="pval-rows"></div><div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn-sm" onclick="SF.modules.pval.addRow()">+ Agregar</button><button class="btn-sm" style="background:var(--text-l)" onclick="SF.modules.pval.loadPreset()">üìã Ejemplo</button></div><button class="btn" onclick="SF.modules.pval.run()">Verificar P-valores</button><div class="results" id="pval-results"></div></div>'}
function addRow(desc,stat,val,df1,df2,pRep){rowCount++;var id=rowCount,c=document.getElementById('pval-rows');if(!c)return;var div=document.createElement('div');div.className='entry-card';div.id='pval-r-'+id;div.innerHTML='<div class="entry-title"><span>Estad√≠stico '+id+'</span><button class="btn-remove" onclick="SF.modules.pval.removeRow('+id+')">√ó</button></div><div class="form-row cols-2"><div class="fg"><label>Descripci√≥n</label><input type="text" id="pv-desc-'+id+'" value="'+(desc||'')+'" placeholder="Endpoint primario"></div><div class="fg"><label>Tipo</label><select id="pv-stat-'+id+'" onchange="SF.modules.pval.updateDF('+id+')"><option value="t"'+(stat==='t'||!stat?' selected':'')+'>t Student</option><option value="z"'+(stat==='z'?' selected':'')+'>z (normal)</option><option value="chi2"'+(stat==='chi2'?' selected':'')+'>œá¬≤</option><option value="f"'+(stat==='f'?' selected':'')+'>F</option></select></div></div><div class="form-row cols-4"><div class="fg"><label>Valor</label><input type="number" id="pv-val-'+id+'" step="0.001" value="'+(val||'')+'" placeholder="2.15"></div><div class="fg"><label id="pv-df1-lab-'+id+'">GL</label><input type="number" id="pv-df1-'+id+'" value="'+(df1||'')+'"></div><div class="fg" id="pv-df2-wrap-'+id+'" style="'+(stat==='f'?'':'display:none')+'"><label>GL‚ÇÇ</label><input type="number" id="pv-df2-'+id+'" value="'+(df2||'')+'"></div><div class="fg"><label>p reportado</label><input type="number" id="pv-p-'+id+'" step="0.0001" value="'+(pRep||'')+'"></div></div>';c.appendChild(div);updateDF(id)}
function removeRow(id){var el=document.getElementById('pval-r-'+id);if(el)el.remove()}
function updateDF(id){var st=SF.ui.getStr('pv-stat-'+id),w=document.getElementById('pv-df2-wrap-'+id),l=document.getElementById('pv-df1-lab-'+id);if(w)w.style.display=st==='f'?'':'none';if(l)l.textContent=st==='z'?'GL (n/a)':st==='f'?'GL‚ÇÅ':'GL'}
function loadPreset(){var c=document.getElementById('pval-rows');if(c)c.innerHTML='';rowCount=0;addRow('Endpoint primario','t',2.15,198,'',0.033);addRow('Subgrupo edad‚â•65','chi2',4.82,1,'',0.028);addRow('ANOVA 3 grupos','f',3.45,2,147,0.034);addRow('Proporciones','z',1.88,'','',0.060);SF.ui.showToast('4 estad√≠sticos cargados')}
function calcP(type,val,df1,df2){if(type==='z')return{p:SF.math.zPValue(val),method:'z',detail:'z='+val};if(type==='t'){if(isNaN(df1)||df1<=0)return{error:'GL requeridos para t'};return{p:SF.math.tPValue(val,df1),method:'t('+df1+')',detail:'t('+df1+')='+val}}if(type==='chi2'){if(isNaN(df1)||df1<=0)return{error:'GL requeridos para œá¬≤'};if(val<0)return{error:'œá¬≤ no puede ser negativo'};return{p:SF.math.chi2PValue(val,df1),method:'œá¬≤('+df1+')',detail:'œá¬≤('+df1+')='+val}}if(type==='f'){if(isNaN(df1)||df1<=0||isNaN(df2)||df2<=0)return{error:'Se requieren df‚ÇÅ y df‚ÇÇ para F'};if(val<0)return{error:'F no puede ser negativo'};return{p:SF.math.fPValue(val,df1,df2),method:'F('+df1+','+df2+')',detail:'F('+df1+','+df2+')='+val}}return{error:'Tipo no reconocido'}}
function run(){var html='',counts={pass:0,warn:0,fail:0},questions=[],anyData=false,allResults=[];for(var i=1;i<=rowCount;i++){if(!document.getElementById('pval-r-'+i))continue;anyData=true;var desc=SF.ui.getStr('pv-desc-'+i)||'Estad√≠stico '+i,st=SF.ui.getStr('pv-stat-'+i),sv=SF.ui.getNum('pv-val-'+i),df1=SF.ui.getInt('pv-df1-'+i),df2=SF.ui.getInt('pv-df2-'+i),pR=SF.ui.getNum('pv-p-'+i);if(isNaN(sv)){html+=SF.ui.rc('warn',desc+': Sin valor','Ingrese el estad√≠stico.');counts.warn++;continue}if(isNaN(pR)){html+=SF.ui.rc('warn',desc+': Sin p','Ingrese p reportado.');counts.warn++;continue}if(pR<0||pR>1){html+=SF.ui.rc('fail',desc+': p fuera de rango','p debe ser 0-1.');counts.fail++;continue}var cr=calcP(st,sv,df1,df2);if(cr.error){html+=SF.ui.rc('warn',desc+': '+cr.error,'Verifique datos.');counts.warn++;continue}var cp=Math.min(Math.max(cr.p,0),1),ratio=Math.max(cp,pR)/Math.max(Math.min(cp,pR),1e-10),cross=(cp<0.05)!==(pR<0.05);var bd=cr.detail+'<br>Recalc: <code>p='+cp.toFixed(6)+'</code> vs rep: <code>p='+pR+'</code>';if(cross){html+=SF.ui.rc('fail',desc+': ‚ö†Ô∏è CAMBIA CONCLUSI√ìN',bd+'<br><strong>Recalc:'+(cp<0.05?'sig.':'no sig.')+', rep:'+(pR<0.05?'sig.':'no sig.')+'</strong>');counts.fail++;questions.push('Para "'+desc+'", p recalculado='+cp.toFixed(4)+' vs reportado='+pR+'. Cambia la conclusi√≥n. ¬øM√©todo utilizado?')}else if(ratio<1.3){html+=SF.ui.rc('pass',desc+': Consistente',bd+' ‚úì');counts.pass++}else if(ratio<2){html+=SF.ui.rc('pass',desc+': OK (discrepancia m√≠nima)',bd);counts.pass++}else if(ratio<5){html+=SF.ui.rc('warn',desc+': Discrepancia moderada ('+ratio.toFixed(1)+'x)',bd);counts.warn++}else{html+=SF.ui.rc('fail',desc+': INCONSISTENTE ('+ratio.toFixed(1)+'x)',bd);counts.fail++;questions.push('El p de "'+desc+'" ('+pR+') difiere del recalculado ('+cp.toFixed(4)+'). ¬øQu√© m√©todo se utiliz√≥?')}SF.ui.addFinding(MNAME,cross?'fail':ratio<2?'pass':ratio<5?'warn':'fail',desc,cr.detail+' ‚Üí p='+cp.toFixed(4)+' vs rep:'+pR);allResults.push({desc:desc,calcP:cp,repP:pR})}
// Patrones
if(allResults.length>=3){var near=0,allSig=true;allResults.forEach(function(r){if(r.repP>=0.04&&r.repP<0.05)near++;if(r.repP>=0.05)allSig=false});if(near>=2){html+=SF.ui.rc('warn','Patr√≥n: '+near+' p-valores en zona 0.04-0.05','Posible p-hacking.');counts.warn++}if(allSig&&allResults.length>=4){html+=SF.ui.rc('warn','Todos los p significativos','Posible reporte selectivo.');counts.warn++}}
if(!anyData)html=SF.ui.rc('warn','Sin datos','Agregue al menos un estad√≠stico.');else{questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Nota:</strong> Discrepancias moderadas pueden deberse a test exacto vs asint√≥tico.</div>';html=SF.ui.summaryBar(counts)+html}document.getElementById('pval-results').innerHTML=html}
function init(){addRow('','t','','','','')}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.pval={addRow:addRow,removeRow:removeRow,updateDF:updateDF,loadPreset:loadPreset,run:run}
})();

// ============================================================
// M√ìDULO 4: VERIFICACI√ìN DE IC
// ============================================================
(function(){
var MID='ci',MNAME='Verificaci√≥n de IC';
function getHTML(){return'<div class="panel-head"><h3>üìä Verificaci√≥n de Intervalos de Confianza</h3><div class="desc">Verifica coherencia del IC 95%: simetr√≠a, SE, p-valor, ancho razonable.</div><span class="ref">üìÑ Berry et al. (2017) ¬∑ Altman & Bland (2011). BMJ.</span></div><div class="panel-body"><div class="section-label">IC reportado</div><div class="form-row cols-3"><div class="fg"><label>Tipo</label><select id="ci-type" onchange="SF.modules.ci.updateLabels()"><option value="ratio">Ratio (RR,OR,HR)</option><option value="diff">Diferencia</option></select></div><div class="fg"><label id="ci-point-label">Estimador puntual</label><input type="number" id="ci-point" step="0.001" placeholder="0.73"></div><div class="fg"><label>Nivel</label><select id="ci-level"><option value="0.95" selected>95%</option><option value="0.90">90%</option><option value="0.99">99%</option></select></div></div><div class="form-row cols-2"><div class="fg"><label>IC inferior</label><input type="number" id="ci-lo" step="0.001" placeholder="0.45"></div><div class="fg"><label>IC superior</label><input type="number" id="ci-hi" step="0.001" placeholder="1.18"></div></div><div class="section-label">Informaci√≥n adicional (opcional)</div><div class="form-row cols-3"><div class="fg"><label>p-valor</label><input type="number" id="ci-pval" step="0.0001" placeholder="0.19"></div><div class="fg"><label>N total</label><input type="number" id="ci-n" placeholder="200"></div><div class="fg"><label>SE reportado</label><input type="number" id="ci-se" step="0.0001" placeholder="Opcional"></div></div><button class="btn" onclick="SF.modules.ci.run()">Verificar IC</button><div class="results" id="ci-results"></div></div>'}
function updateLabels(){var l=document.getElementById('ci-point-label');if(l)l.textContent=SF.ui.getStr('ci-type')==='ratio'?'Estimador (RR,OR,HR)':'Estimador (diferencia)'}
function getZCrit(lv){return String(lv)==='0.90'?1.645:String(lv)==='0.99'?2.576:1.96}
function run(){var type=SF.ui.getStr('ci-type'),pt=SF.ui.getNum('ci-point'),lo=SF.ui.getNum('ci-lo'),hi=SF.ui.getNum('ci-hi'),cl=SF.ui.getNum('ci-level')||0.95,pval=SF.ui.getNum('ci-pval'),nT=SF.ui.getInt('ci-n'),seR=SF.ui.getNum('ci-se'),zC=getZCrit(cl);if(isNaN(pt)||isNaN(lo)||isNaN(hi)){document.getElementById('ci-results').innerHTML=SF.ui.rc('warn','Datos incompletos','Ingrese estimador e IC.');return}var html='',c={pass:0,warn:0,fail:0},questions=[];function add(l,t,d){html+=SF.ui.rc(l,t,d);if(c[l]!==undefined)c[l]++;SF.ui.addFinding(MNAME,l,t,d)}
// Contenci√≥n
if(lo>hi)add('fail','IC invertido','Inf('+lo+') > sup('+hi+')');else if(pt<lo||pt>hi)add('fail','Estimador FUERA del IC',pt+' fuera de ('+lo+','+hi+')');else add('pass','Estimador dentro del IC','<code>'+lo+' ‚â§ '+pt+' ‚â§ '+hi+'</code> ‚úì');
// Simetr√≠a
if(lo<hi){if(type==='ratio'&&pt>0&&lo>0&&hi>0){var lP=Math.log(pt),lL=Math.log(lo),lH=Math.log(hi),dL2=lP-lL,dH2=lH-lP,avg=(dL2+dH2)/2,asym=avg>0?Math.abs(dL2-dH2)/avg*100:0,seLn=(lH-lL)/(2*zC);if(asym<5)add('pass','Simetr√≠a log OK','Asimetr√≠a:'+asym.toFixed(1)+'%. SE(ln)‚âà'+seLn.toFixed(4)+' ‚úì');else if(asym<15)add('warn','Asimetr√≠a log moderada',asym.toFixed(1)+'%');else add('fail','Asimetr√≠a log EXCESIVA',asym.toFixed(1)+'%')}else if(type==='diff'){var dL3=pt-lo,dH3=hi-pt,avg2=(dL3+dH3)/2,asym2=avg2>0?Math.abs(dL3-dH3)/avg2*100:0;if(asym2<3)add('pass','IC sim√©trico','Asimetr√≠a:'+asym2.toFixed(1)+'% ‚úì');else if(asym2<12)add('warn','Ligera asimetr√≠a',asym2.toFixed(1)+'%');else add('fail','IC MUY asim√©trico',asym2.toFixed(1)+'%')}}
// SE
if(!isNaN(seR)&&seR>0){var seCI;if(type==='ratio'&&pt>0&&lo>0&&hi>0)seCI=(Math.log(hi)-Math.log(lo))/(2*zC);else seCI=(hi-lo)/(2*zC);if(seCI>0){var r2=Math.max(seCI,seR)/Math.min(seCI,seR);if(r2<1.1)add('pass','SE consistente con IC','SE rep:'+seR+', SE IC:'+seCI.toFixed(4)+' ‚úì');else if(r2<1.25)add('warn','SE: discrepancia menor','Ratio:'+r2.toFixed(3));else add('fail','SE INCONSISTENTE','SE rep:'+seR+' vs IC:'+seCI.toFixed(4)+' ('+r2.toFixed(2)+'x)')}}
// p vs IC
if(!isNaN(pval)){var nV=type==='ratio'?1:0,ciN=lo<=nV&&hi>=nV,pS=pval<0.05;if(pS&&ciN){add('fail','p<0.05 pero IC incluye nulo','Contradicci√≥n');questions.push('p='+pval+' pero IC('+lo+','+hi+') incluye '+nV+'. ¬øMismo an√°lisis?')}else if(!pS&&!ciN)add('fail','p‚â•0.05 pero IC excluye nulo','Contradicci√≥n');else add('pass','p coherente con IC','p='+pval+', IC '+(ciN?'incluye':'excluye')+' '+nV+' ‚úì');
// Reconstruir p
var seD2,z2,pC;if(type==='ratio'&&pt>0&&lo>0&&hi>0){seD2=(Math.log(hi)-Math.log(lo))/(2*zC);z2=Math.abs(Math.log(pt))/seD2;pC=SF.math.zPValue(z2)}else{seD2=(hi-lo)/(2*zC);if(seD2>0){z2=Math.abs(pt)/seD2;pC=SF.math.zPValue(z2)}}if(!isNaN(pC)){var r3=Math.max(pC,pval)/Math.max(Math.min(pC,pval),1e-10);if((pC<0.05)!==(pval<0.05))add('fail','p reconstruido CAMBIA conclusi√≥n','p(IC)‚âà'+pC.toFixed(4)+' vs rep:'+pval);else if(r3<1.5)add('pass','p reconstruido OK','p(IC)‚âà'+pC.toFixed(4)+' vs rep:'+pval+' ‚úì');else add('warn','p reconstruido difiere','p(IC)‚âà'+pC.toFixed(4)+' vs rep:'+pval+' ('+r3.toFixed(1)+'x)')}}
// Derivados
var dSE,dZ,dP;if(type==='ratio'&&pt>0&&lo>0&&hi>0){dSE=(Math.log(hi)-Math.log(lo))/(2*zC);dZ=Math.abs(Math.log(pt))/dSE;dP=SF.math.zPValue(dZ)}else if(type==='diff'&&lo<hi){dSE=(hi-lo)/(2*zC);if(dSE>0){dZ=Math.abs(pt)/dSE;dP=SF.math.zPValue(dZ)}}if(dSE)html+=SF.ui.rc('info','Valores derivados del IC','SE'+(type==='ratio'?'(ln)':'')+'=<code>'+dSE.toFixed(4)+'</code> ¬∑ z=<code>'+dZ.toFixed(3)+'</code> ¬∑ p=<code>'+dP.toFixed(4)+'</code>');
questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Nota:</strong> Para ratios la simetr√≠a se eval√∫a en escala log.</div>';html=SF.ui.summaryBar(c)+html;document.getElementById('ci-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.ci={run:run,updateLabels:updateLabels}
})();

// ============================================================
// M√ìDULO 5: FRAGILIDAD
// ============================================================
(function(){
var MID='fragility',MNAME='√çndice de Fragilidad';
function getHTML(){return'<div class="panel-head"><h3>üíî √çndice de Fragilidad</h3><div class="desc">¬øCu√°ntos pacientes necesitar√≠an cambiar para que el resultado deje de ser significativo?</div><span class="ref">üìÑ Walsh et al. (2014). J Clin Epidemiol ¬∑ Ahmed et al. (2016). CMAJ.</span></div><div class="panel-body"><div class="note" style="margin-top:0;margin-bottom:14px"><strong>Contexto:</strong> Mediana FI en NEJM/JAMA/Lancet = 8. En 25% de ensayos FI ‚â§ 3.</div><div class="section-label">Tabla 2√ó2</div><div class="form-row cols-2"><div class="fg"><label>Eventos tto</label><input type="number" id="f-e1" placeholder="15" min="0"></div><div class="fg"><label>N tto</label><input type="number" id="f-n1" placeholder="100" min="1"></div></div><div class="form-row cols-2"><div class="fg"><label>Eventos ctrl</label><input type="number" id="f-e2" placeholder="30" min="0"></div><div class="fg"><label>N ctrl</label><input type="number" id="f-n2" placeholder="100" min="1"></div></div><div class="section-label">P√©rdidas de seguimiento (opcional)</div><div class="form-row cols-2"><div class="fg"><label>P√©rdidas tto</label><input type="number" id="f-loss1" min="0" placeholder="5"></div><div class="fg"><label>P√©rdidas ctrl</label><input type="number" id="f-loss2" min="0" placeholder="7"></div></div><button class="btn" onclick="SF.modules.fragility.run()">Calcular Fragilidad</button><div class="results" id="fragility-results"></div></div>'}
function calcFI(e1,n1,e2,n2,forward){var best={fi:Infinity,desc:'',finalE1:e1,finalE2:e2,finalP:1},maxI=Math.max(n1,n2),target=forward?0.05:0.05;
if(forward){// Agregar al grupo con menos eventos
if(e1/n1<e2/n2){var tE=e1;for(var i=0;i<maxI;i++){tE++;if(tE>n1)break;var p=SF.math.fisherExact(tE,n1-tE,e2,n2-e2);if(p>=0.05){if(i+1<best.fi)best={fi:i+1,desc:'+'+(i+1)+' evento(s) en tto: '+e1+'‚Üí'+tE+'/'+n1,finalE1:tE,finalE2:e2,finalP:p};break}}}else{var tE=e2;for(var i=0;i<maxI;i++){tE++;if(tE>n2)break;var p=SF.math.fisherExact(e1,n1-e1,tE,n2-tE);if(p>=0.05){if(i+1<best.fi)best={fi:i+1,desc:'+'+(i+1)+' evento(s) en ctrl: '+e2+'‚Üí'+tE+'/'+n2,finalE1:e1,finalE2:tE,finalP:p};break}}}
// Quitar del grupo con m√°s
if(e1/n1>e2/n2){var tE=e1;for(var i=0;i<maxI;i++){tE--;if(tE<0)break;var p=SF.math.fisherExact(tE,n1-tE,e2,n2-e2);if(p>=0.05){if(i+1<best.fi)best={fi:i+1,desc:'-'+(i+1)+' evento(s) en tto: '+e1+'‚Üí'+tE+'/'+n1,finalE1:tE,finalE2:e2,finalP:p};break}}}else{var tE=e2;for(var i=0;i<maxI;i++){tE--;if(tE<0)break;var p=SF.math.fisherExact(e1,n1-e1,tE,n2-tE);if(p>=0.05){if(i+1<best.fi)best={fi:i+1,desc:'-'+(i+1)+' evento(s) en ctrl: '+e2+'‚Üí'+tE+'/'+n2,finalE1:e1,finalE2:tE,finalP:p};break}}}
}else{// Reverso: alcanzar p<0.05
if(e1/n1<=e2/n2){var tE=e1;for(var i=0;i<maxI;i++){tE--;if(tE<0)break;var p=SF.math.fisherExact(tE,n1-tE,e2,n2-e2);if(p<0.05){if(i+1<best.fi)best={fi:i+1,desc:'-'+(i+1)+' en tto',finalE1:tE,finalE2:e2,finalP:p};break}}tE=e2;for(var i=0;i<maxI;i++){tE++;if(tE>n2)break;var p=SF.math.fisherExact(e1,n1-e1,tE,n2-tE);if(p<0.05){if(i+1<best.fi)best={fi:i+1,desc:'+'+(i+1)+' en ctrl',finalE1:e1,finalE2:tE,finalP:p};break}}}else{var tE=e1;for(var i=0;i<maxI;i++){tE++;if(tE>n1)break;var p=SF.math.fisherExact(tE,n1-tE,e2,n2-e2);if(p<0.05){if(i+1<best.fi)best={fi:i+1,desc:'+'+(i+1)+' en tto',finalE1:tE,finalE2:e2,finalP:p};break}}tE=e2;for(var i=0;i<maxI;i++){tE--;if(tE<0)break;var p=SF.math.fisherExact(e1,n1-e1,tE,n2-tE);if(p<0.05){if(i+1<best.fi)best={fi:i+1,desc:'-'+(i+1)+' en ctrl',finalE1:e1,finalE2:tE,finalP:p};break}}}}return best}
function run(){var e1=SF.ui.getInt('f-e1'),n1=SF.ui.getInt('f-n1'),e2=SF.ui.getInt('f-e2'),n2=SF.ui.getInt('f-n2'),loss1=SF.ui.getInt('f-loss1'),loss2=SF.ui.getInt('f-loss2');if(isNaN(e1)||isNaN(n1)||isNaN(e2)||isNaN(n2)){document.getElementById('fragility-results').innerHTML=SF.ui.rc('warn','Datos incompletos','Ingrese eventos y N.');return}if(e1>n1||e2>n2){document.getElementById('fragility-results').innerHTML=SF.ui.rc('fail','Eventos > N','Imposible.');return}var html='',counts={pass:0,warn:0,fail:0},questions=[],nTotal=n1+n2;var pInit=SF.math.fisherExact(e1,n1-e1,e2,n2-e2);html+=SF.ui.rc('info','Datos de entrada','Tto:<code>'+e1+'/'+n1+' ('+(e1/n1*100).toFixed(1)+'%)</code> ¬∑ Ctrl:<code>'+e2+'/'+n2+' ('+(e2/n2*100).toFixed(1)+'%)</code><br>p(Fisher)=<code>'+pInit.toFixed(6)+'</code>');
if(pInit>=0.05){html+=SF.ui.rc('warn','Estudio NO significativo','Se calcula FI Reverso.');counts.warn++;var rfi=calcFI(e1,n1,e2,n2,false);if(rfi.fi<Infinity){var col=rfi.fi<=3?'var(--red)':rfi.fi<=8?'var(--yellow)':'var(--green)';html+=SF.ui.bigNumber(rfi.fi,'Fragilidad Reversa',col);if(rfi.fi<=3){html+=SF.ui.rc('warn','Casi significativo',rfi.desc+'. p='+rfi.finalP.toFixed(4));counts.warn++;questions.push('FI reverso='+rfi.fi+'. El resultado est√° cerca de la significaci√≥n. ¬øTama√±o muestral suficiente?')}else{html+=SF.ui.rc('pass','Claramente no significativo','Se necesitar√≠an '+rfi.fi+' cambios.');counts.pass++}}else{html+=SF.ui.rc('pass','No se puede alcanzar significaci√≥n','');counts.pass++}SF.ui.addFinding(MNAME,'info','FI Reverso: '+(rfi.fi<Infinity?rfi.fi:'N/A'),'p='+pInit.toFixed(4))}
else{var fi=calcFI(e1,n1,e2,n2,true);if(fi.fi>=Infinity){html+=SF.ui.rc('pass','Extremadamente robusto','No se pudo revertir.');counts.pass++}else{var col=fi.fi<=3?'var(--red)':fi.fi<=8?'var(--yellow)':'var(--green)',fq=(fi.fi/nTotal*100).toFixed(1);html+=SF.ui.bigNumber(fi.fi,'√çndice de Fragilidad',col);if(fi.fi<=3){html+=SF.ui.rc('fail','ALTAMENTE FR√ÅGIL (FI‚â§3)',fi.desc+' ‚Üí p=<code>'+fi.finalP.toFixed(4)+'</code><br>FQ=<code>'+fq+'%</code>');counts.fail++;questions.push('FI='+fi.fi+'. El cambio de '+fi.fi+' paciente(s) revertir√≠a la significaci√≥n. ¬øAn√°lisis de sensibilidad?')}else if(fi.fi<=8){html+=SF.ui.rc('warn','Fragilidad moderada (FI='+fi.fi+')',fi.desc+' ‚Üí p=<code>'+fi.finalP.toFixed(4)+'</code><br>Mediana literatura=8. FQ=<code>'+fq+'%</code>');counts.warn++}else{html+=SF.ui.rc('pass','Resultado robusto (FI='+fi.fi+')',fi.desc+'. FQ=<code>'+fq+'%</code>');counts.pass++}
// P√©rdidas
html+='<div class="divider"></div>';var totalLoss=0,hasLoss=false;if(!isNaN(loss1)&&!isNaN(loss2)){totalLoss=loss1+loss2;hasLoss=true}else if(!isNaN(loss1)){totalLoss=loss1;hasLoss=true}else if(!isNaN(loss2)){totalLoss=loss2;hasLoss=true}
if(hasLoss){var lp=(totalLoss/nTotal*100).toFixed(1);if(fi.fi<=totalLoss){html+=SF.ui.rc('fail','FI ‚â§ p√©rdidas','FI=<code>'+fi.fi+'</code> ¬∑ P√©rdidas=<code>'+totalLoss+'</code> ('+lp+'%).<br><strong>Las p√©rdidas superan el FI.</strong>');counts.fail++;questions.push('FI='+fi.fi+' pero hay '+totalLoss+' p√©rdidas ('+lp+'%). ¬øAn√°lisis worst-case?')}else{html+=SF.ui.rc('pass','FI > p√©rdidas','FI='+fi.fi+' > p√©rdidas='+totalLoss+' ‚úì');counts.pass++}}else{var est=Math.round(nTotal*0.05);html+=SF.ui.rc(fi.fi<=est?'warn':'pass','P√©rdidas no especificadas','Si ~5% (‚âà'+est+'), FI='+fi.fi+(fi.fi<=est?' ser√≠a menor':'superar√≠a')+'.')}
SF.ui.addFinding(MNAME,fi.fi<=3?'fail':fi.fi<=8?'warn':'pass','FI='+fi.fi,fi.desc+'. FQ='+fq+'%')}}
questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Metodolog√≠a:</strong> Fisher bilateral. FQ=FI/N. Compare siempre con p√©rdidas de seguimiento.</div>';html=SF.ui.summaryBar(counts)+html;document.getElementById('fragility-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.fragility={run:run}
})();
// ============================================================
// M√ìDULO 6: POTENCIA
// ============================================================
(function(){
var MID='power',MNAME='Potencia Estad√≠stica';
function getHTML(){return'<div class="panel-head"><h3>‚ö° Potencia Estad√≠stica</h3><div class="desc">Eval√∫a si el estudio ten√≠a potencia para detectar el efecto esperado. √ötil cuando el resultado es no significativo.</div><span class="ref">üìÑ ICH E9 ¬∑ Hoenig & Heisey (2001). Am Stat.</span></div><div class="panel-body"><div class="section-label">Tipo de desenlace</div><div class="form-row cols-2"><div class="fg"><label>Variable</label><select id="pow-type" onchange="SF.modules.power.updateForm()"><option value="prop">Proporciones</option><option value="cont">Medias</option></select></div><div class="fg"><label>Test</label><select id="pow-sides"><option value="2">Bilateral</option><option value="1">Unilateral</option></select></div></div><div class="section-label">Tama√±os de muestra</div><div class="form-row cols-2"><div class="fg"><label>N control</label><input type="number" id="pow-n1" placeholder="100" min="1"></div><div class="fg"><label>N tratamiento</label><input type="number" id="pow-n2" placeholder="100" min="1"></div></div><div id="pow-prop-fields"><div class="section-label">Proporciones</div><div class="form-row cols-2"><div class="fg"><label>% esperado ctrl</label><div class="hint">Del protocolo</div><input type="number" id="pow-pc" step="0.1" placeholder="30"></div><div class="fg"><label>% esperado tto</label><div class="hint">Hip√≥tesis alternativa</div><input type="number" id="pow-pt" step="0.1" placeholder="20"></div></div><div class="form-row cols-2"><div class="fg"><label>% observado ctrl</label><div class="hint">Resultado real</div><input type="number" id="pow-pc-obs" step="0.1" placeholder="Opcional"></div><div class="fg"><label>% observado tto</label><input type="number" id="pow-pt-obs" step="0.1" placeholder="Opcional"></div></div></div><div id="pow-cont-fields" style="display:none"><div class="section-label">Medias</div><div class="form-row cols-3"><div class="fg"><label>Dif. esperada</label><div class="hint">MCID protocolo</div><input type="number" id="pow-diff-exp" step="0.1" placeholder="5.0"></div><div class="fg"><label>DE esperada</label><input type="number" id="pow-sd-exp" step="0.1" placeholder="15"></div><div class="fg"><label>Dif. observada</label><input type="number" id="pow-diff-obs" step="0.1" placeholder="Opcional"></div></div><div class="form-row cols-2"><div class="fg"><label>DE obs grupo 1</label><input type="number" id="pow-sd1-obs" step="0.1" placeholder="Opcional"></div><div class="fg"><label>DE obs grupo 2</label><input type="number" id="pow-sd2-obs" step="0.1" placeholder="Opcional"></div></div></div><div class="section-label">Alfa</div><div class="form-row cols-2"><div class="fg"><label>Alfa (Œ±)</label><select id="pow-alpha"><option value="0.05" selected>0.05</option><option value="0.025">0.025</option><option value="0.01">0.01</option></select></div><div class="fg"><label>p observado</label><input type="number" id="pow-pobs" step="0.001" placeholder="Opcional"></div></div><button class="btn" onclick="SF.modules.power.run()">Calcular Potencia</button><div class="results" id="power-results"></div></div>'}
function updateForm(){var t=SF.ui.getStr('pow-type');var pf=document.getElementById('pow-prop-fields'),cf=document.getElementById('pow-cont-fields');if(pf)pf.style.display=t==='prop'?'':'none';if(cf)cf.style.display=t==='cont'?'':'none'}
function powerProp(p1,p2,n1,n2,alpha,sides){if(p1===p2)return alpha;var zA=sides===1?SF.math.normalInv(1-alpha):SF.math.normalInv(1-alpha/2);var pB=(p1*n1+p2*n2)/(n1+n2),se0=Math.sqrt(pB*(1-pB)*(1/n1+1/n2)),se1=Math.sqrt(p1*(1-p1)/n1+p2*(1-p2)/n2);if(se0<=0||se1<=0)return NaN;return SF.math.normalCDF((Math.abs(p2-p1)-zA*se0)/se1)}
function powerMean(diff,sd,n1,n2,alpha,sides){if(diff===0)return alpha;if(sd<=0)return NaN;var zA=sides===1?SF.math.normalInv(1-alpha):SF.math.normalInv(1-alpha/2);return SF.math.normalCDF(Math.abs(diff)/(sd*Math.sqrt(1/n1+1/n2))-zA)}
function ssizeProp(p1,p2,alpha,power,sides){if(p1===p2)return Infinity;var zA=sides===1?SF.math.normalInv(1-alpha):SF.math.normalInv(1-alpha/2),zB=SF.math.normalInv(power),pB=(p1+p2)/2;return Math.ceil(Math.pow(zA*Math.sqrt(2*pB*(1-pB))+zB*Math.sqrt(p1*(1-p1)+p2*(1-p2)),2)/Math.pow(p1-p2,2))}
function ssizeMean(diff,sd,alpha,power,sides){if(diff===0||sd<=0)return Infinity;var zA=sides===1?SF.math.normalInv(1-alpha):SF.math.normalInv(1-alpha/2),zB=SF.math.normalInv(power);return Math.ceil(2*sd*sd*Math.pow(zA+zB,2)/(diff*diff))}
function interpPow(pow,ctx){var pct=(pow*100).toFixed(1);if(pow>=0.9)return{level:'pass',label:'POTENCIA ALTA',text:'Potencia:<code>'+pct+'%</code>. Capacidad sobrada para detectar '+ctx+'.'};if(pow>=0.8)return{level:'pass',label:'POTENCIA ADECUADA',text:'Potencia:<code>'+pct+'%</code>. Cumple ICH E9 (‚â•80%) para '+ctx+'.'};if(pow>=0.6)return{level:'warn',label:'POTENCIA SUB√ìPTIMA',text:'Potencia:<code>'+pct+'%</code>. Por debajo del 80% para '+ctx+'. Resultado no sig. es inconcluyente.'};if(pow>=0.3)return{level:'warn',label:'POTENCIA INSUFICIENTE',text:'Potencia:<code>'+pct+'%</code>. '+((1-pow)*100).toFixed(0)+'% prob. de no detectar '+ctx+'.'};return{level:'fail',label:'POTENCIA MUY BAJA',text:'Potencia:<code>'+pct+'%</code>. Incapaz de detectar '+ctx+'.'};}
function run(){var type=SF.ui.getStr('pow-type'),n1=SF.ui.getInt('pow-n1'),n2=SF.ui.getInt('pow-n2'),sides=SF.ui.getInt('pow-sides'),alpha=SF.ui.getNum('pow-alpha'),pObs=SF.ui.getNum('pow-pobs');if(isNaN(n1)||isNaN(n2)||n1<=0||n2<=0){document.getElementById('power-results').innerHTML=SF.ui.rc('warn','Datos incompletos','Ingrese N.');return}var html='',counts={pass:0,warn:0,fail:0},questions=[];
if(type==='prop'){var pc=SF.ui.getNum('pow-pc'),pt=SF.ui.getNum('pow-pt'),pcO=SF.ui.getNum('pow-pc-obs'),ptO=SF.ui.getNum('pow-pt-obs');var hasExp=!isNaN(pc)&&!isNaN(pt),hasObs=!isNaN(pcO)&&!isNaN(ptO);if(!hasExp&&!hasObs){html=SF.ui.rc('warn','Datos insuficientes','Ingrese % esperados u observados.')}else{
if(hasExp){var p1=pc/100,p2=pt/100,diffE=Math.abs(pc-pt),powE=powerProp(p1,p2,n1,n2,alpha,sides),ip=interpPow(powE,'diferencia de '+diffE.toFixed(1)+'pp');html+='<div class="section-label">Potencia para efecto predefinido</div>';html+=SF.ui.bigNumber((powE*100).toFixed(1)+'%','Potencia (protocolo)',powE>=0.8?'var(--green)':powE>=0.5?'var(--yellow)':'var(--red)');html+=SF.ui.rc(ip.level,ip.label,ip.text);counts[ip.level]++;var n80=ssizeProp(p1,p2,alpha,0.80,sides),n90=ssizeProp(p1,p2,alpha,0.90,sides),nMin=Math.min(n1,n2);html+=SF.ui.rc('info','N necesario por grupo','80%:<code>'+n80+'</code> ¬∑ 90%:<code>'+n90+'</code> ¬∑ Actual:<code>'+n1+'/'+n2+'</code><br>'+(nMin<n80?'<strong>‚ö†Ô∏è Infrapotenciado.</strong>':nMin<n90?'Suficiente para 80%, no 90%.':'Suficiente ‚â•90% ‚úì'));if(nMin<n80)questions.push('Necesitaban '+n80+'/grupo para 80% potencia con diferencia '+diffE.toFixed(1)+'pp, pero solo tienen '+n1+' y '+n2+'. ¬øProblemas de reclutamiento?');SF.ui.addFinding(MNAME,ip.level,'Potencia(protocolo):'+(powE*100).toFixed(1)+'%','Efecto:'+pc+'% vs '+pt+'%')}
if(hasObs){var po1=pcO/100,po2=ptO/100,diffO=Math.abs(pcO-ptO),powO=powerProp(po1,po2,n1,n2,alpha,sides),ipO=interpPow(powO,'diferencia observada '+diffO.toFixed(1)+'pp');html+='<div class="divider"></div><div class="section-label">Potencia efecto observado (referencia)</div>';html+=SF.ui.rc('warn','‚ö†Ô∏è Advertencia metodol√≥gica','Potencia post-hoc con efecto observado: Hoenig & Heisey (2001). No aporta informaci√≥n independiente.');counts.warn++;html+=SF.ui.rc(ipO.level,ipO.label+' (observado)',ipO.text);SF.ui.addFinding(MNAME,'info','Potencia(obs):'+(powO*100).toFixed(1)+'%','Referencia');if(hasExp&&diffO<Math.abs(pc-pt)*0.5){html+=SF.ui.rc('warn','Efecto observado muy inferior al esperado','Protocolo:'+Math.abs(pc-pt).toFixed(1)+'pp ¬∑ Obs:'+diffO.toFixed(1)+'pp ('+(diffO/Math.abs(pc-pt)*100).toFixed(0)+'%)');counts.warn++;questions.push('Diferencia observada ('+diffO.toFixed(1)+'pp) < mitad de la esperada ('+Math.abs(pc-pt).toFixed(1)+'pp). ¬øBase del c√°lculo de muestra?')}}}}
else{var diffExp=SF.ui.getNum('pow-diff-exp'),sdExp=SF.ui.getNum('pow-sd-exp'),diffObs=SF.ui.getNum('pow-diff-obs'),sd1O=SF.ui.getNum('pow-sd1-obs'),sd2O=SF.ui.getNum('pow-sd2-obs');var hasE2=!isNaN(diffExp)&&!isNaN(sdExp),hasO2=!isNaN(diffObs)&&!isNaN(sd1O)&&!isNaN(sd2O);if(!hasE2&&!hasO2){html=SF.ui.rc('warn','Datos insuficientes','Ingrese diferencia+DE esperadas u observadas.')}else{
if(hasE2){if(sdExp<=0){html+=SF.ui.rc('fail','DE inv√°lida','Debe ser positiva.');counts.fail++}else{var powE2=powerMean(diffExp,sdExp,n1,n2,alpha,sides),d2=Math.abs(diffExp)/sdExp,ip2=interpPow(powE2,'diferencia '+diffExp+' (d='+d2.toFixed(2)+')');html+='<div class="section-label">Potencia efecto predefinido</div>';html+=SF.ui.bigNumber((powE2*100).toFixed(1)+'%','Potencia (protocolo)',powE2>=0.8?'var(--green)':powE2>=0.5?'var(--yellow)':'var(--red)');html+=SF.ui.rc(ip2.level,ip2.label,ip2.text+'<br>d Cohen:<code>'+d2.toFixed(3)+'</code> ('+(d2<0.2?'muy peque√±o':d2<0.5?'peque√±o':d2<0.8?'mediano':'grande')+')');counts[ip2.level]++;var n80m=ssizeMean(diffExp,sdExp,alpha,0.80,sides),n90m=ssizeMean(diffExp,sdExp,alpha,0.90,sides),nMn=Math.min(n1,n2);html+=SF.ui.rc('info','N necesario','80%:<code>'+n80m+'</code> ¬∑ 90%:<code>'+n90m+'</code> ¬∑ Actual:<code>'+n1+'/'+n2+'</code>'+(nMn<n80m?'<br><strong>‚ö†Ô∏è Infrapotenciado.</strong>':''));if(nMn<n80m)questions.push('Necesitaban '+n80m+'/grupo pero tienen '+n1+'/'+n2+'. ¬øSe alcanz√≥ el tama√±o planificado?');SF.ui.addFinding(MNAME,ip2.level,'Potencia:'+(powE2*100).toFixed(1)+'%','d='+d2.toFixed(2))}}
if(hasO2){var sdP=Math.sqrt(((n1-1)*sd1O*sd1O+(n2-1)*sd2O*sd2O)/(n1+n2-2)),powO2=powerMean(diffObs,sdP,n1,n2,alpha,sides),dO=Math.abs(diffObs)/sdP;html+='<div class="divider"></div><div class="section-label">Potencia efecto observado</div>';html+=SF.ui.rc('warn','‚ö†Ô∏è Advertencia','Post-hoc: Hoenig & Heisey (2001).');counts.warn++;var ipO2=interpPow(powO2,'diferencia obs '+diffObs);html+=SF.ui.rc(ipO2.level,ipO2.label+' (obs)',ipO2.text+'<br>d obs:<code>'+dO.toFixed(3)+'</code>')}}}
questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Nota:</strong> Potencia post-hoc con efecto observado tiene relaci√≥n directa con p-valor. El an√°lisis informativo es con efecto predefinido (MCID).</div>';html=SF.ui.summaryBar(counts)+html;document.getElementById('power-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.power={run:run,updateForm:updateForm}
})();

// ============================================================
// M√ìDULO 7: NNT
// ============================================================
(function(){
var MID='nnt',MNAME='NNT';
function getHTML(){return'<div class="panel-head"><h3>üéØ NNT ‚Äî Number Needed to Treat</h3><div class="desc">Convierte medidas relativas en impacto cl√≠nico absoluto. Un RR impresionante puede esconder un NNT decepcionante.</div><span class="ref">üìÑ Cook & Sackett (1995). BMJ ¬∑ Altman (1998). BMJ.</span></div><div class="panel-body"><div class="section-label">Entrada</div><div class="form-row cols-2"><div class="fg"><label>Fuente</label><select id="nnt-mode" onchange="SF.modules.nnt.updateForm()"><option value="raw">Tabla 2√ó2</option><option value="rr">RR + basal</option><option value="or">OR + basal</option></select></div><div class="fg"><label>Desenlace</label><select id="nnt-outcome"><option value="bad">Negativo (NNT)</option><option value="good">Positivo (NNH)</option></select></div></div><div id="nnt-raw-fields"><div class="section-label">Tabla 2√ó2</div><div class="form-row cols-2"><div class="fg"><label>Eventos tto</label><input type="number" id="nnt-e1" placeholder="15" min="0"></div><div class="fg"><label>N tto</label><input type="number" id="nnt-n1" placeholder="200" min="1"></div></div><div class="form-row cols-2"><div class="fg"><label>Eventos ctrl</label><input type="number" id="nnt-e2" placeholder="30" min="0"></div><div class="fg"><label>N ctrl</label><input type="number" id="nnt-n2" placeholder="200" min="1"></div></div></div><div id="nnt-ratio-fields" style="display:none"><div class="section-label">Ratio y riesgo basal</div><div class="form-row cols-3"><div class="fg"><label id="nnt-ratio-label">RR</label><input type="number" id="nnt-ratio" step="0.01" placeholder="0.73"></div><div class="fg"><label>IC inf</label><input type="number" id="nnt-ratio-lo" step="0.01" placeholder="0.55"></div><div class="fg"><label>IC sup</label><input type="number" id="nnt-ratio-hi" step="0.01" placeholder="0.95"></div></div><div class="form-row cols-2"><div class="fg"><label>Riesgo basal ctrl (%)</label><input type="number" id="nnt-baseline" step="0.1" placeholder="15"></div><div class="fg"><label>N total (opc)</label><input type="number" id="nnt-ntotal" placeholder="400"></div></div></div><div class="section-label">Contexto (opcional)</div><div class="form-row cols-2"><div class="fg"><label>Duraci√≥n</label><input type="text" id="nnt-duration" placeholder="12 meses"></div><div class="fg"><label>Carga tratamiento</label><select id="nnt-burden"><option value="">No especificado</option><option value="low">Baja</option><option value="mod">Moderada</option><option value="high">Alta (cirug√≠a, QT)</option></select></div></div><button class="btn" onclick="SF.modules.nnt.run()">Calcular NNT</button><div class="results" id="nnt-results"></div></div>'}
function updateForm(){var m=SF.ui.getStr('nnt-mode'),rf=document.getElementById('nnt-raw-fields'),rtf=document.getElementById('nnt-ratio-fields'),rl=document.getElementById('nnt-ratio-label');if(rf)rf.style.display=m==='raw'?'':'none';if(rtf)rtf.style.display=m==='raw'?'none':'';if(rl)rl.textContent=m==='or'?'OR':'RR'}
function buildResult(ard,ardLo,ardHi,r1,r2,se){var nntV=ard===0?Infinity:1/Math.abs(ard),rrr=r2>0?(r2-r1)/r2:0,nntLo,nntHi,cross;if(ardLo>0&&ardHi>0){nntHi=1/ardLo;nntLo=1/ardHi;cross=false}else if(ardLo<0&&ardHi<0){nntHi=1/Math.abs(ardHi);nntLo=1/Math.abs(ardLo);cross=false}else{cross=true;nntLo=ardHi>0?1/ardHi:Infinity;nntHi=ardLo<0?-1/ardLo:Infinity}return{ard:ard,ardLo:ardLo,ardHi:ardHi,nnt:nntV,nntLo:nntLo,nntHi:nntHi,crossesNull:cross,riskTreatment:r1,riskControl:r2,rrr:rrr,se:se,beneficial:ard>0}}
function run(){var mode=SF.ui.getStr('nnt-mode'),outType=SF.ui.getStr('nnt-outcome'),dur=SF.ui.getStr('nnt-duration'),burden=SF.ui.getStr('nnt-burden');var html='',counts={pass:0,warn:0,fail:0},questions=[],result;
if(mode==='raw'){var e1=SF.ui.getInt('nnt-e1'),n1=SF.ui.getInt('nnt-n1'),e2=SF.ui.getInt('nnt-e2'),n2=SF.ui.getInt('nnt-n2');if(isNaN(e1)||isNaN(n1)||isNaN(e2)||isNaN(n2)){document.getElementById('nnt-results').innerHTML=SF.ui.rc('warn','Datos incompletos','Complete la tabla.');return}if(e1>n1||e2>n2){document.getElementById('nnt-results').innerHTML=SF.ui.rc('fail','Eventos>N','Verifique.');return}var r1=e1/n1,r2=e2/n2,ard=r2-r1,se=Math.sqrt(r1*(1-r1)/n1+r2*(1-r2)/n2);result=buildResult(ard,ard-1.96*se,ard+1.96*se,r1,r2,se)}else{var ratio=SF.ui.getNum('nnt-ratio'),rLo=SF.ui.getNum('nnt-ratio-lo'),rHi=SF.ui.getNum('nnt-ratio-hi'),bl=SF.ui.getNum('nnt-baseline');if(isNaN(ratio)||isNaN(bl)){document.getElementById('nnt-results').innerHTML=SF.ui.rc('warn','Incompleto','Ingrese ratio y riesgo basal.');return}var b=bl/100;if(b<=0||b>=1){document.getElementById('nnt-results').innerHTML=SF.ui.rc('fail','Riesgo basal fuera de rango','0-100%.');return}if(isNaN(rLo))rLo=ratio*0.7;if(isNaN(rHi))rHi=ratio*1.4;if(mode==='rr'){var ard2=b*(1-ratio),ardL=b*(1-rHi),ardH=b*(1-rLo),se2=(ardH-ardL)/(2*1.96);result=buildResult(ard2,ardL,ardH,b*ratio,b,se2)}else{function rFromOR(o,p0){return o*p0/(1-p0+o*p0)}var r1o=rFromOR(ratio,b),r1lo=rFromOR(rHi,b),r1hi=rFromOR(rLo,b),ard3=b-r1o,ardL2=b-r1lo,ardH2=b-r1hi;if(ardL2>ardH2){var tmp=ardL2;ardL2=ardH2;ardH2=tmp}result=buildResult(ard3,ardL2,ardH2,r1o,b,(ardH2-ardL2)/(2*1.96))}}
var label=outType==='bad'?'NNT':'NNH',nntR=Math.ceil(result.nnt),rrrP=Math.abs(result.rrr*100).toFixed(0),ardP=Math.abs(result.ard*100).toFixed(1);
html+=SF.ui.rc('info','Datos','Riesgo tto:<code>'+(result.riskTreatment*100).toFixed(1)+'%</code> ¬∑ Ctrl:<code>'+(result.riskControl*100).toFixed(1)+'%</code> ¬∑ RRR:<code>'+rrrP+'%</code>');
html+='<div class="section-label">ARD</div>';var ardSign=result.ard>=0?'a favor del tto':'a favor del ctrl (da√±o)';html+=SF.ui.rc(result.ard>0?'pass':result.ard<0?'fail':'warn','ARD='+ardP+'% ('+ardSign+')','IC95%:<code>'+(result.ardLo*100).toFixed(1)+'%</code> a <code>'+(result.ardHi*100).toFixed(1)+'%</code>'+(result.crossesNull?'<br><strong>‚ö†Ô∏è IC cruza cero.</strong>':''));
var nntCol=nntR<=15?'var(--green)':nntR<=50?'var(--yellow)':'var(--red)';if(!isFinite(result.nnt))nntCol='var(--text-l)';html+=SF.ui.bigNumber(isFinite(result.nnt)?nntR:'‚àû',label+(dur?' ('+dur+')':''),nntCol);
if(result.crossesNull){html+=SF.ui.rc('warn','IC del '+label+' cruza infinito','El efecto no es estad√≠sticamente significativo.');counts.warn++;questions.push('La ARD incluye cero. ¬øC√≥mo se concluye eficacia con '+label+' cuyo IC incluye infinito?')}else if(isFinite(result.nntLo)&&isFinite(result.nntHi)){html+=SF.ui.rc('pass','IC 95% del '+label,'<code>'+Math.ceil(result.nntLo)+'</code> a <code>'+Math.ceil(result.nntHi)+'</code>');counts.pass++}
// Interpretaci√≥n
if(isFinite(result.nnt)){var th=burden==='high'?{g:5,a:15}:burden==='low'?{g:50,a:100}:{g:15,a:40};if(nntR<=th.g){html+=SF.ui.rc('pass','Impacto cl√≠nico relevante',label+'=<code>'+nntR+'</code>'+(dur?' en '+dur:''));counts.pass++}else if(nntR<=th.a){html+=SF.ui.rc('pass','Beneficio modesto',label+'=<code>'+nntR+'</code>');counts.pass++}else{html+=SF.ui.rc('warn','Beneficio absoluto peque√±o',label+'=<code>'+nntR+'</code>. Muchos pacientes por evento prevenido.');counts.warn++}}
// RRR vs ARD
html+='<div class="divider"></div>';if(Math.abs(result.rrr)>0.20&&Math.abs(result.ard)<0.03){html+=SF.ui.rc('warn','Efecto relativo grande pero absoluto peque√±o','RRR:<code>'+rrrP+'%</code> pero ARD solo <code>'+ardP+'%</code>. '+label+'='+nntR+'.');counts.warn++;questions.push('RRR='+rrrP+'% se traduce en ARD='+ardP+'% ('+label+'='+nntR+'). ¬øCl√≠nicamente relevante?')}else if(Math.abs(result.rrr)>0.20&&Math.abs(result.ard)>0.05){html+=SF.ui.rc('pass','Efecto relativo y absoluto concordantes','RRR:<code>'+rrrP+'%</code> ¬∑ ARD:<code>'+ardP+'%</code> ‚úì');counts.pass++}
if(burden==='high'&&isFinite(result.nnt)&&nntR>40)questions.push(label+'='+nntR+' con tratamiento de alta carga. ¬øBalance beneficio-riesgo justificable?');
SF.ui.addFinding(MNAME,result.crossesNull?'warn':nntR<=50?'pass':'warn',label+'='+(isFinite(result.nnt)?nntR:'‚àû'),'ARD='+ardP+'%. RRR='+rrrP+'%');questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Ref:</strong> NNT depende del riesgo basal. Aspirina prev. secundaria: NNT‚âà50-100. Estatinas prev. primaria: NNT‚âà100-250.</div>';html=SF.ui.summaryBar(counts)+html;document.getElementById('nnt-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.nnt={run:run,updateForm:updateForm}
})();

// ============================================================
// M√ìDULO 8: TABLA BASAL (CARLISLE)
// ============================================================
(function(){
var MID='baseline',MNAME='Tabla Basal (Carlisle)',rowCount=0;
function getHTML(){return'<div class="panel-head"><h3>‚öñÔ∏è Tabla Basal ‚Äî Test de Carlisle</h3><div class="desc">Eval√∫a si el balance basal es compatible con aleatorizaci√≥n genuina. Detecta exceso de diferencias y balance sospechosamente perfecto.</div><span class="ref">üìÑ Carlisle (2017). Anaesthesia ¬∑ Bolland et al. (2021). Neurology.</span></div><div class="panel-body"><div class="note" style="margin-top:0;margin-bottom:14px"><strong>Contexto:</strong> Variables demasiado perfectamente balanceadas son tan sospechosas como las muy diferentes.</div><div class="section-label">N por grupo</div><div class="form-row cols-2"><div class="fg"><label>N Tratamiento</label><input type="number" id="bl-n1" placeholder="100" min="1"></div><div class="fg"><label>N Control</label><input type="number" id="bl-n2" placeholder="100" min="1"></div></div><div class="section-label">Variables basales</div><div id="baseline-rows"></div><div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn-sm" onclick="SF.modules.baseline.addRow()">+ Variable</button><button class="btn-sm" style="background:var(--text-l)" onclick="SF.modules.baseline.loadPreset()">üìã Ejemplo</button></div><button class="btn" onclick="SF.modules.baseline.run()">Analizar Balance Basal</button><div class="results" id="baseline-results"></div></div>'}
function addRow(name,type,m1,s1,m2,s2){rowCount++;var id=rowCount,c=document.getElementById('baseline-rows');if(!c)return;var isCont=!type||type==='cont';var div=document.createElement('div');div.className='entry-card';div.id='bl-r-'+id;div.innerHTML='<div class="entry-title"><span>Variable '+id+'</span><button class="btn-remove" onclick="SF.modules.baseline.removeRow('+id+')">√ó</button></div><div class="form-row cols-2"><div class="fg"><label>Nombre</label><input type="text" id="bl-name-'+id+'" value="'+(name||'')+'" placeholder="Edad"></div><div class="fg"><label>Tipo</label><select id="bl-type-'+id+'" onchange="SF.modules.baseline.updateLabels('+id+')"><option value="cont"'+(isCont?' selected':'')+'>Media¬±DE</option><option value="bin"'+(!isCont?' selected':'')+'>%</option></select></div></div><div class="form-row cols-4"><div class="fg"><label>'+(isCont?'Tto:Media':'Tto:%')+'</label><input type="number" step="0.01" id="bl-m1-'+id+'" value="'+(m1||'')+'"></div><div class="fg" id="bl-s1w-'+id+'"'+(isCont?'':' style="display:none"')+'><label>Tto:DE</label><input type="number" step="0.01" id="bl-s1-'+id+'" value="'+(s1||'')+'"></div><div class="fg"><label>'+(isCont?'Ctrl:Media':'Ctrl:%')+'</label><input type="number" step="0.01" id="bl-m2-'+id+'" value="'+(m2||'')+'"></div><div class="fg" id="bl-s2w-'+id+'"'+(isCont?'':' style="display:none"')+'><label>Ctrl:DE</label><input type="number" step="0.01" id="bl-s2-'+id+'" value="'+(s2||'')+'"></div></div>';c.appendChild(div)}
function removeRow(id){var el=document.getElementById('bl-r-'+id);if(el)el.remove()}
function updateLabels(id){var t=SF.ui.getStr('bl-type-'+id),s1=document.getElementById('bl-s1w-'+id),s2=document.getElementById('bl-s2w-'+id);if(s1)s1.style.display=t==='cont'?'':'none';if(s2)s2.style.display=t==='cont'?'':'none'}
function loadPreset(){var c=document.getElementById('baseline-rows');if(c)c.innerHTML='';rowCount=0;var e1=document.getElementById('bl-n1'),e2=document.getElementById('bl-n2');if(e1)e1.value='120';if(e2)e2.value='118';addRow('Edad','cont',62.3,11.2,62.5,10.8);addRow('Peso','cont',78.5,14.3,77.9,13.7);addRow('IMC','cont',27.3,4.1,27.1,4.3);addRow('PAS','cont',134.2,16.5,133.8,15.9);addRow('Sexo M','bin',62,'',58,'');addRow('Diabetes','bin',34,'',31,'');addRow('Fumador','bin',22,'',24,'');addRow('HbA1c','cont',7.8,1.2,7.9,1.3);SF.ui.showToast('8 variables cargadas')}
function run(){var n1=SF.ui.getInt('bl-n1'),n2=SF.ui.getInt('bl-n2');if(isNaN(n1)||isNaN(n2)||n1<=1||n2<=1){document.getElementById('baseline-results').innerHTML=SF.ui.rc('warn','Incompleto','Ingrese N‚â•2.');return}var html='',co={pass:0,warn:0,fail:0},questions=[],pVals=[],varRes=[];
for(var i=1;i<=rowCount;i++){if(!document.getElementById('bl-r-'+i))continue;var name=SF.ui.getStr('bl-name-'+i)||'Var '+i,type=SF.ui.getStr('bl-type-'+i),m1=SF.ui.getNum('bl-m1-'+i),m2=SF.ui.getNum('bl-m2-'+i);if(isNaN(m1)||isNaN(m2))continue;var p,detail;if(type==='cont'){var s1=SF.ui.getNum('bl-s1-'+i),s2=SF.ui.getNum('bl-s2-'+i);if(isNaN(s1)||isNaN(s2)||s1<=0||s2<=0)continue;var se=Math.sqrt(s1*s1/n1+s2*s2/n2),t=Math.abs(m1-m2)/se,v1=s1*s1/n1,v2=s2*s2/n2,df=Math.max(1,Math.floor(Math.pow(v1+v2,2)/(v1*v1/(n1-1)+v2*v2/(n2-1))));p=SF.math.tPValue(t,df);detail='Dif='+(m1-m2).toFixed(2)+', t('+df+')='+t.toFixed(3)+', p='+p.toFixed(4)}else{var p1=m1/100,p2=m2/100,pP=(p1*n1+p2*n2)/(n1+n2),se2=Math.sqrt(pP*(1-pP)*(1/n1+1/n2));if(se2<=0)continue;var z=Math.abs(p1-p2)/se2;p=SF.math.zPValue(z);detail=m1+'% vs '+m2+'%, z='+z.toFixed(3)+', p='+p.toFixed(4)}pVals.push(p);varRes.push({name:name,p:p,detail:detail});var lv=p<0.01?'fail':p<0.05?'warn':'pass';html+=SF.ui.rc(lv,name,detail+(p<0.05?' ‚Äî <strong>Significativa ‚ö†Ô∏è</strong>':' ‚úì'));if(lv==='fail')co.fail++;else if(lv==='warn')co.warn++;else co.pass++}
if(pVals.length===0){document.getElementById('baseline-results').innerHTML=SF.ui.rc('warn','Sin datos','Complete variables.');return}
html+='<div class="divider"></div><div class="section-label">An√°lisis global</div>';var nV=pVals.length,nSig=pVals.filter(function(p){return p<0.05}).length,expSig=nV*0.05,mean=pVals.reduce(function(a,b){return a+b},0)/nV,sorted=pVals.slice().sort(function(a,b){return a-b}),median=nV%2===0?(sorted[nV/2-1]+sorted[nV/2])/2:sorted[Math.floor(nV/2)];var allHigh=pVals.every(function(p){return p>0.50}),above07=pVals.filter(function(p){return p>0.7}).length;
if(nSig>=2&&nSig>expSig+1.5){html+=SF.ui.rc('fail','Exceso de diferencias: '+nSig+'/'+nV,'Esperadas ~'+expSig.toFixed(1)+'. Problemas con aleatorizaci√≥n.');co.fail++;questions.push(nSig+'/'+nV+' variables significativas (esperadas ~'+expSig.toFixed(0)+'). ¬øM√©todo de aleatorizaci√≥n?')}
if(allHigh&&nV>=5){var prob=Math.pow(0.5,nV);html+=SF.ui.rc('fail','‚ö†Ô∏è Balance SOSPECHOSAMENTE PERFECTO','Todos p>0.50 en '+nV+' variables. Media:'+mean.toFixed(3)+'. Prob:'+prob.toExponential(2)+'.<br><strong>Se√±al de fabricaci√≥n (Carlisle 2017).</strong>');co.fail++;questions.push('Todas '+nV+' variables con p>0.50 (media='+mean.toFixed(2)+'). Prob='+prob.toExponential(1)+'. ¬øDatos fuente del procedimiento de aleatorizaci√≥n?')}else if(above07>=nV*0.7&&nV>=5){html+=SF.ui.rc('warn','Balance inusualmente bueno',above07+'/'+nV+' con p>0.70. Media:'+mean.toFixed(3));co.warn++}else if(nSig<=expSig+1&&!allHigh){html+=SF.ui.rc('pass','Balance normal',nSig+'/'+nV+' sig. Media p:'+mean.toFixed(3)+' ‚úì');co.pass++}
// Fisher combinado
var fS=-2*pVals.reduce(function(s,p){return s+Math.log(Math.max(p,1e-10))},0),dfF=2*nV,pF=SF.math.chi2PValue(fS,dfF);html+=SF.ui.rc(pF<0.001?'fail':pF<0.05?'warn':'pass','Fisher: œá¬≤('+dfF+')='+fS.toFixed(2)+', p='+pF.toFixed(6),'Esperado:'+dfF+'. '+(fS>dfF*2?'Exceso diferencias.':fS<dfF*0.3?'Sospechosamente bajo.':'Normal.'));if(pF<0.05)co.warn++;else co.pass++;
// Distribuci√≥n
html+=SF.ui.rc('info','Distribuci√≥n p-valores','Variables:'+nV+' ¬∑ p<0.05:'+nSig+' (esp:'+expSig.toFixed(1)+') ¬∑ p>0.70:'+above07+' (esp:'+(nV*0.3).toFixed(1)+') ¬∑ Media:'+mean.toFixed(3)+' ¬∑ Mediana:'+median.toFixed(3));
SF.ui.addFinding(MNAME,co.fail>0?'fail':co.warn>0?'warn':'pass','Basal:'+nSig+'/'+nV+' sig, media p='+mean.toFixed(3),'Fisher œá¬≤='+fS.toFixed(1));questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Interpretaci√≥n:</strong> No prueba fraude. Puede ser aleatorizaci√≥n defectuosa, error de datos o estratificaci√≥n no descrita.</div>';html=SF.ui.summaryBar(co)+html;document.getElementById('baseline-results').innerHTML=html}
function init(){addRow('','cont','','','','')}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.baseline={addRow:addRow,removeRow:removeRow,updateLabels:updateLabels,loadPreset:loadPreset,run:run}
})();

// ============================================================
// M√ìDULO 9: CONSORT
// ============================================================
(function(){
var MID='consort',MNAME='CONSORT / P√©rdidas';
function getHTML(){return'<div class="panel-head"><h3>üìâ CONSORT ‚Äî Flujo y P√©rdidas</h3><div class="desc">Verifica coherencia del flujo, asimetr√≠a de p√©rdidas e impacto de datos faltantes.</div><span class="ref">üìÑ CONSORT 2010 ¬∑ ICH E9(R1) ¬∑ Akl et al. (2012). BMJ.</span></div><div class="panel-body"><div class="section-label">Aleatorizaci√≥n</div><div class="form-row cols-3"><div class="fg"><label>Evaluados</label><input type="number" id="co-screened" placeholder="450"></div><div class="fg"><label>Excluidos pre</label><input type="number" id="co-excluded" placeholder="150"></div><div class="fg"><label>Aleatorizados</label><input type="number" id="co-randomized" placeholder="300"></div></div><div class="section-label">Asignaci√≥n</div><div class="form-row cols-2"><div class="fg"><label>Asignados tto</label><input type="number" id="co-assigned1" placeholder="150"></div><div class="fg"><label>Asignados ctrl</label><input type="number" id="co-assigned2" placeholder="150"></div></div><div class="section-label">P√©rdidas Tratamiento</div><div class="form-row cols-2"><div class="fg"><label>P√©rdidas seguimiento</label><input type="number" id="co-lost1" placeholder="8" min="0"></div><div class="fg"><label>Discontinuaron</label><input type="number" id="co-disc1" placeholder="12" min="0"></div></div><div class="form-row cols-2"><div class="fg"><label>Excluidos an√°lisis</label><input type="number" id="co-excl1" placeholder="5" min="0"></div><div class="fg"><label>Raz√≥n</label><input type="text" id="co-reason1" placeholder="Violaci√≥n criterios"></div></div><div class="section-label">P√©rdidas Control</div><div class="form-row cols-2"><div class="fg"><label>P√©rdidas seguimiento</label><input type="number" id="co-lost2" placeholder="5" min="0"></div><div class="fg"><label>Discontinuaron</label><input type="number" id="co-disc2" placeholder="4" min="0"></div></div><div class="form-row cols-2"><div class="fg"><label>Excluidos an√°lisis</label><input type="number" id="co-excl2" placeholder="3" min="0"></div><div class="fg"><label>Raz√≥n</label><input type="text" id="co-reason2" placeholder="Retiro consentimiento"></div></div><div class="section-label">Poblaciones an√°lisis</div><div class="form-row cols-2"><div class="fg"><label>ITT tto</label><input type="number" id="co-itt1" placeholder="150"></div><div class="fg"><label>ITT ctrl</label><input type="number" id="co-itt2" placeholder="150"></div></div><div class="form-row cols-2"><div class="fg"><label>PP tto</label><input type="number" id="co-pp1" placeholder="125"></div><div class="fg"><label>PP ctrl</label><input type="number" id="co-pp2" placeholder="138"></div></div><div class="section-label">Resultado (opc., ITT vs PP)</div><div class="form-row cols-2"><div class="fg"><label>p ITT</label><input type="number" id="co-p-itt" step="0.001" placeholder="0.048"></div><div class="fg"><label>p PP</label><input type="number" id="co-p-pp" step="0.001" placeholder="0.032"></div></div><button class="btn" onclick="SF.modules.consort.run()">Verificar Flujo</button><div class="results" id="consort-results"></div></div>'}
function run(){var d={sc:SF.ui.getInt('co-screened'),ex:SF.ui.getInt('co-excluded'),rn:SF.ui.getInt('co-randomized'),a1:SF.ui.getInt('co-assigned1'),a2:SF.ui.getInt('co-assigned2'),l1:SF.ui.getInt('co-lost1'),l2:SF.ui.getInt('co-lost2'),d1:SF.ui.getInt('co-disc1'),d2:SF.ui.getInt('co-disc2'),x1:SF.ui.getInt('co-excl1'),x2:SF.ui.getInt('co-excl2'),i1:SF.ui.getInt('co-itt1'),i2:SF.ui.getInt('co-itt2'),p1:SF.ui.getInt('co-pp1'),p2:SF.ui.getInt('co-pp2'),pi:SF.ui.getNum('co-p-itt'),pp:SF.ui.getNum('co-p-pp')};if(isNaN(d.a1)||isNaN(d.a2)){document.getElementById('consort-results').innerHTML=SF.ui.rc('warn','M√≠nimo','Ingrese asignados a cada grupo.');return}var html='',c={pass:0,warn:0,fail:0},questions=[];function add(l,t,dt){html+=SF.ui.rc(l,t,dt);if(c[l]!==undefined)c[l]++;SF.ui.addFinding(MNAME,l,t,dt)}
// Flujo
html+='<div class="section-label">Flujo</div>';if(!isNaN(d.sc)&&!isNaN(d.ex)&&!isNaN(d.rn)){var exp=d.sc-d.ex;if(exp===d.rn)add('pass','Screening‚Üíaleatorizaci√≥n OK','<code>'+d.sc+'-'+d.ex+'='+d.rn+'</code> ‚úì');else add('fail','Flujo INCONSISTENTE','<code>'+d.sc+'-'+d.ex+'='+exp+' ‚â† '+d.rn+'</code>');if(d.sc>0&&d.ex/d.sc>0.7)add('warn','Exclusi√≥n alta: '+(d.ex/d.sc*100).toFixed(0)+'%','Criterios muy restrictivos.')}
if(!isNaN(d.rn)){var sum=d.a1+d.a2;if(sum===d.rn)add('pass','Asignaci√≥n OK','<code>'+d.a1+'+'+d.a2+'='+d.rn+'</code> ‚úì');else add('fail','Asignaci√≥n INCONSISTENTE','<code>'+d.a1+'+'+d.a2+'='+sum+' ‚â† '+d.rn+'</code>')}
// P√©rdidas
html+='<div class="divider"></div><div class="section-label">P√©rdidas</div>';var loss1=(d.l1||0)+(d.d1||0)+(d.x1||0),loss2=(d.l2||0)+(d.d2||0)+(d.x2||0),lr1=loss1/d.a1*100,lr2=loss2/d.a2*100,tLoss=loss1+loss2,tN=d.a1+d.a2,oLR=tLoss/tN*100;
add('info','P√©rdidas totales','Tto:<code>'+loss1+'/'+d.a1+' ('+lr1.toFixed(1)+'%)</code> ¬∑ Ctrl:<code>'+loss2+'/'+d.a2+' ('+lr2.toFixed(1)+'%)</code> ¬∑ Total:<code>'+tLoss+'/'+tN+' ('+oLR.toFixed(1)+'%)</code>');
if(oLR>20){add('fail','P√©rdidas >20%','Riesgo alto de sesgo (Akl 2012).');questions.push('P√©rdidas del '+oLR.toFixed(0)+'%. ¬øAn√°lisis de sensibilidad bajo MCAR/MAR/MNAR?')}else if(oLR>10)add('warn','P√©rdidas 10-20%','Requiere sensibilidad.');else if(tLoss>0)add('pass','P√©rdidas <10%','Aceptable ‚úì');
var diffPct=Math.abs(lr1-lr2);if(diffPct>10){add('fail','P√©rdidas MUY asim√©tricas','Tto:'+lr1.toFixed(1)+'% vs Ctrl:'+lr2.toFixed(1)+'%. Dif:'+diffPct.toFixed(1)+'pp.'+(lr1>lr2?' M√°s en tto‚Üíposible toxicidad.':' M√°s en ctrl.'));questions.push('P√©rdidas asim√©tricas: '+lr1.toFixed(0)+'% vs '+lr2.toFixed(0)+'%. '+(lr1>lr2?'¬øRelacionadas con eventos adversos?':'¬øQu√© explica m√°s p√©rdidas en control?'))}else if(diffPct>5)add('warn','P√©rdidas moderadamente asim√©tricas','Dif:'+diffPct.toFixed(1)+'pp');else if(tLoss>0)add('pass','P√©rdidas sim√©tricas','Dif:'+diffPct.toFixed(1)+'pp ‚úì');
// ITT/PP
html+='<div class="divider"></div><div class="section-label">Poblaciones</div>';if(!isNaN(d.i1)){if(d.i1===d.a1)add('pass','ITT tto=asignados','‚úì');else if(d.i1>d.a1)add('fail','ITT tto>asignados','Imposible');else{var xe=(d.a1-d.i1)/d.a1*100;add(xe>5?'warn':'pass','mITT tto excluye '+(d.a1-d.i1)+' ('+xe.toFixed(1)+'%)',xe>5?'Justificaci√≥n necesaria.':'‚úì')}}
if(!isNaN(d.i2)){if(d.i2===d.a2)add('pass','ITT ctrl=asignados','‚úì');else if(d.i2>d.a2)add('fail','ITT ctrl>asignados','Imposible');else{var xe2=(d.a2-d.i2)/d.a2*100;add(xe2>5?'warn':'pass','mITT ctrl excluye '+(d.a2-d.i2)+' ('+xe2.toFixed(1)+'%)',xe2>5?'Justificaci√≥n.':'‚úì')}}
if(!isNaN(d.p1)&&d.p1>d.a1)add('fail','PP tto>asignados','Imposible');if(!isNaN(d.p2)&&d.p2>d.a2)add('fail','PP ctrl>asignados','Imposible');if(!isNaN(d.p1)&&!isNaN(d.i1)&&d.p1>d.i1)add('fail','PP tto>ITT tto','Imposible');if(!isNaN(d.p2)&&!isNaN(d.i2)&&d.p2>d.i2)add('fail','PP ctrl>ITT ctrl','Imposible');
if(!isNaN(d.p1)&&!isNaN(d.p2)){var ppX1=d.a1-(d.p1||d.a1),ppX2=d.a2-(d.p2||d.a2),ppR1=ppX1/d.a1*100,ppR2=ppX2/d.a2*100,ppDiff=Math.abs(ppR1-ppR2);if(ppDiff>10)add('fail','Exclusiones PP asim√©tricas','Tto:'+ppR1.toFixed(1)+'% vs Ctrl:'+ppR2.toFixed(1)+'%. Sesgo selecci√≥n.');else if(ppDiff>5)add('warn','Exclusiones PP moderadamente asim√©tricas','Dif:'+ppDiff.toFixed(1)+'pp')}
// ITT vs PP
if(!isNaN(d.pi)&&!isNaN(d.pp)){html+='<div class="divider"></div><div class="section-label">ITT vs PP</div>';var iS=d.pi<0.05,pS=d.pp<0.05;if(iS&&pS)add('pass','ITT y PP significativos','Concordantes ‚úì');else if(!iS&&!pS)add('pass','ITT y PP no significativos','Concordantes ‚úì');else if(!iS&&pS){add('fail','‚ö†Ô∏è ITT no sig. pero PP sig.','ITT:p='+d.pi+', PP:p='+d.pp+'. Se√±al de alarma. ICH E9: ITT es conservador.');questions.push('ITT no significativo (p='+d.pi+') pero PP s√≠ (p='+d.pp+'). ¬øPor qu√© se da relevancia al PP con ITT negativo?')}else add('warn','ITT sig. pero PP no sig.','Patr√≥n inusual. ITT:p='+d.pi+', PP:p='+d.pp)}
questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>Marco:</strong> ICH E9(R1): p√©rdidas evaluar con estimand y sensibilidad MNAR. CONSORT requiere transparencia.</div>';html=SF.ui.summaryBar(c)+html;document.getElementById('consort-results').innerHTML=html}
function init(){}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.consort={run:run}
})();

// ============================================================
// M√ìDULO 10: SUBGRUPOS Y MULTIPLICIDAD
// ============================================================
(function(){
var MID='subgroups',MNAME='Subgrupos / Multiplicidad',rowCount=0;
function getHTML(){return'<div class="panel-head"><h3>üîÄ Subgrupos y Multiplicidad</h3><div class="desc">Eval√∫a credibilidad de subgrupos y riesgo de falsos positivos por comparaciones m√∫ltiples.</div><span class="ref">üìÑ Sun et al. (2012). JAMA ¬∑ Wallach et al. (2017). Ann Intern Med.</span></div><div class="panel-body"><div class="note" style="margin-top:0;margin-bottom:14px"><strong>Contexto:</strong> 57% de ensayos reportan subgrupos pero solo 33% el test de interacci√≥n.</div><div class="section-label">Resultado global</div><div class="form-row cols-3"><div class="fg"><label>Efecto global</label><input type="number" id="sg-global-effect" step="0.01" placeholder="0.82"></div><div class="fg"><label>IC inf</label><input type="number" id="sg-global-lo" step="0.01" placeholder="0.68"></div><div class="fg"><label>IC sup</label><input type="number" id="sg-global-hi" step="0.01" placeholder="0.99"></div></div><div class="form-row cols-2"><div class="fg"><label>p global</label><input type="number" id="sg-global-p" step="0.001" placeholder="0.04"></div><div class="fg"><label>Total endpoints</label><input type="number" id="sg-total-endpoints" placeholder="5" min="1"></div></div><div class="form-row cols-2"><div class="fg"><label>Preespecificados</label><select id="sg-prespecified"><option value="unknown">No indicado</option><option value="yes">S√≠</option><option value="some">Algunos</option><option value="no">No (post-hoc)</option></select></div><div class="fg"><label>Tipo medida</label><select id="sg-measure-type"><option value="ratio">Ratio</option><option value="diff">Diferencia</option></select></div></div><div class="section-label">Subgrupos</div><div id="subgroup-rows"></div><div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn-sm" onclick="SF.modules.subgroups.addRow()">+ Subgrupo</button><button class="btn-sm" style="background:var(--text-l)" onclick="SF.modules.subgroups.loadPreset()">üìã Ejemplo</button></div><button class="btn" onclick="SF.modules.subgroups.run()">Analizar Subgrupos</button><div class="results" id="subgroups-results"></div></div>'}
function addRow(name,effect,lo,hi,pInt,n){rowCount++;var id=rowCount,c=document.getElementById('subgroup-rows');if(!c)return;var div=document.createElement('div');div.className='entry-card';div.id='sg-r-'+id;div.innerHTML='<div class="entry-title"><span>Subgrupo '+id+'</span><button class="btn-remove" onclick="SF.modules.subgroups.removeRow('+id+')">√ó</button></div><div class="form-row cols-2"><div class="fg"><label>Nombre</label><input type="text" id="sg-name-'+id+'" value="'+(name||'')+'" placeholder="Edad‚â•65"></div><div class="fg"><label>N</label><input type="number" id="sg-n-'+id+'" value="'+(n||'')+'" placeholder="85"></div></div><div class="form-row cols-4"><div class="fg"><label>Efecto</label><input type="number" id="sg-effect-'+id+'" step="0.01" value="'+(effect||'')+'" placeholder="0.65"></div><div class="fg"><label>IC inf</label><input type="number" id="sg-lo-'+id+'" step="0.01" value="'+(lo||'')+'"></div><div class="fg"><label>IC sup</label><input type="number" id="sg-hi-'+id+'" step="0.01" value="'+(hi||'')+'"></div><div class="fg"><label>p interacc.</label><input type="number" id="sg-pint-'+id+'" step="0.001" value="'+(pInt||'')+'" placeholder="0.12"></div></div>';c.appendChild(div)}
function removeRow(id){var el=document.getElementById('sg-r-'+id);if(el)el.remove()}
function loadPreset(){var c=document.getElementById('subgroup-rows');if(c)c.innerHTML='';rowCount=0;var ids=['sg-global-effect','sg-global-lo','sg-global-hi','sg-global-p','sg-total-endpoints'],vals=['0.82','0.68','0.99','0.04','5'];ids.forEach(function(id,i){var el=document.getElementById(id);if(el)el.value=vals[i]});addRow('Edad<65',0.71,0.52,0.97,0.18,180);addRow('Edad‚â•65',0.95,0.73,1.23,0.18,120);addRow('Sexo M',0.78,0.60,1.02,0.45,165);addRow('Sexo F',0.88,0.64,1.21,0.45,135);addRow('Diabetes s√≠',0.65,0.42,1.01,0.08,95);addRow('Diabetes no',0.92,0.74,1.14,0.08,205);addRow('Europa',0.79,0.58,1.08,0.62,140);addRow('Am√©rica',0.86,0.63,1.18,0.62,160);SF.ui.showToast('8 subgrupos cargados')}
function probFP(k,a){return 1-Math.pow(1-a,k)}
function holmCorr(pvals,a){var n=pvals.length,sorted=pvals.map(function(x,i){return{p:x.p,name:x.name,i:i}}).sort(function(a,b){return a.p-b.p}),results=[],still=true;for(var i=0;i<sorted.length;i++){var adj=a/(n-i),sig=still&&sorted[i].p<adj;if(!sig)still=false;results.push({name:sorted[i].name,pOrig:sorted[i].p,adjAlpha:adj,sig:sig,rank:i+1})}return results}
function run(){var gE=SF.ui.getNum('sg-global-effect'),gLo=SF.ui.getNum('sg-global-lo'),gHi=SF.ui.getNum('sg-global-hi'),gP=SF.ui.getNum('sg-global-p'),mType=SF.ui.getStr('sg-measure-type'),prespec=SF.ui.getStr('sg-prespecified'),totEnd=SF.ui.getInt('sg-total-endpoints')||1;var html='',counts={pass:0,warn:0,fail:0},questions=[],subs=[],nullV=mType==='ratio'?1:0;
for(var i=1;i<=rowCount;i++){if(!document.getElementById('sg-r-'+i))continue;var nm=SF.ui.getStr('sg-name-'+i)||'Sub '+i,ef=SF.ui.getNum('sg-effect-'+i),lo=SF.ui.getNum('sg-lo-'+i),hi=SF.ui.getNum('sg-hi-'+i),pI=SF.ui.getNum('sg-pint-'+i),n=SF.ui.getInt('sg-n-'+i);if(isNaN(ef))continue;subs.push({name:nm,effect:ef,lo:lo,hi:hi,pInt:pI,n:n||0})}
if(subs.length===0){document.getElementById('subgroups-results').innerHTML=SF.ui.rc('warn','Sin datos','Agregue subgrupos.');return}
var totalN=0;subs.forEach(function(s){totalN+=s.n});
// Multiplicidad
html+='<div class="section-label">Multiplicidad</div>';var totComp=subs.length+Math.max(totEnd-1,0),pfp=probFP(totComp,0.05);html+=SF.ui.rc(pfp>0.5?'fail':pfp>0.2?'warn':'pass','P(‚â•1 falso positivo): '+(pfp*100).toFixed(0)+'%','<code>'+totComp+'</code> comparaciones. P=1-(0.95)^'+totComp+'=<code>'+(pfp*100).toFixed(1)+'%</code>'+(pfp>0.5?'<br><strong>>50% prob. de hallazgo espurio.</strong>':''));if(pfp>0.5)counts.fail++;else if(pfp>0.2)counts.warn++;else counts.pass++;
// Subgrupos individuales
html+='<div class="divider"></div><div class="section-label">Subgrupos</div>';var sigSubs=[],hasAnyPI=false,hasSigPI=false,allPIs=[];subs.forEach(function(sg){var sigIC=!isNaN(sg.lo)&&!isNaN(sg.hi)&&((mType==='ratio'&&(sg.hi<1||sg.lo>1))||(mType==='diff'&&(sg.hi<0||sg.lo>0)));var det='Efecto:<code>'+sg.effect+'</code>'+(!isNaN(sg.lo)&&!isNaN(sg.hi)?' ('+sg.lo+'‚Äì'+sg.hi+')':'')+(sg.n>0?' ¬∑ N='+sg.n:'');if(!isNaN(sg.pInt)){hasAnyPI=true;allPIs.push({p:sg.pInt,name:sg.name});det+=' ¬∑ p int=<code>'+sg.pInt+'</code>';if(sg.pInt<0.05){hasSigPI=true;det+=' <strong>(sig.)</strong>'}}var sameDir=true;if(!isNaN(gE)){var gBen=mType==='ratio'?gE<1:gE<0,sBen=mType==='ratio'?sg.effect<1:sg.effect<0;sameDir=gBen===sBen;if(!sameDir)det+='<br><em>‚ö†Ô∏è Direcci√≥n invertida vs global</em>'}html+=SF.ui.rc(sigIC?'pass':'warn',sg.name,det);if(sigIC)sigSubs.push(sg)});
// Interacci√≥n
html+='<div class="divider"></div><div class="section-label">Interacci√≥n</div>';if(!hasAnyPI){html+=SF.ui.rc('fail','Tests de interacci√≥n NO reportados','Sin p interacci√≥n no se puede concluir diferencia entre subgrupos.');counts.fail++;questions.push('Los subgrupos no incluyen test de interacci√≥n. ¬øPodr√≠an proporcionarlos?')}else{if(hasSigPI){html+=SF.ui.rc('warn','Interacci√≥n significativa detectada','Con '+allPIs.length+' tests, P(FP)='+(probFP(allPIs.length,0.05)*100).toFixed(0)+'%.');counts.warn++}else{html+=SF.ui.rc('pass','Ninguna interacci√≥n significativa','No hay evidencia de efecto diferente entre subgrupos ‚úì');counts.pass++}}
// Correcciones
if(allPIs.length>=2&&hasSigPI){html+='<div class="divider"></div><div class="section-label">Correcciones</div>';var hR=holmCorr(allPIs,0.05),hSig=hR.filter(function(r){return r.sig}).length;html+=SF.ui.rc('info','Holm (step-down)','<table style="width:100%;font-size:.73rem;border-collapse:collapse"><tr style="border-bottom:2px solid #ccc"><th style="padding:3px 6px;text-align:left">Subgrupo</th><th style="padding:3px 6px">p</th><th style="padding:3px 6px">Œ± adj</th><th style="padding:3px 6px">Resultado</th></tr>'+hR.map(function(r){return'<tr style="border-bottom:1px solid #eee"><td style="padding:3px 6px">'+r.name+'</td><td style="padding:3px 6px;text-align:center">'+r.pOrig.toFixed(4)+'</td><td style="padding:3px 6px;text-align:center">'+r.adjAlpha.toFixed(4)+'</td><td style="padding:3px 6px;text-align:center">'+(r.sig?'üü¢':'üî¥')+'</td></tr>'}).join('')+'</table><br>'+hSig+'/'+hR.length+' sobreviven correcci√≥n.');if(hSig===0){html+=SF.ui.rc('warn','Ninguna interacci√≥n sobrevive','Las interacciones no resisten correcci√≥n.');counts.warn++}}
// Credibilidad
if(sigSubs.length>0&&!isNaN(gE)){html+='<div class="divider"></div><div class="section-label">Credibilidad (Sun 2012)</div>';sigSubs.forEach(function(sg){var gBen2=mType==='ratio'?gE<1:gE<0,sBen2=mType==='ratio'?sg.effect<1:sg.effect<0;var score=0,details=[];if(prespec==='yes'){score++;details.push('‚úÖ Preespecificado')}else details.push('‚ùå No preespecificado');if(subs.length<=5){score++;details.push('‚úÖ Pocos subgrupos ('+subs.length+'‚â§5)')}else details.push('‚ùå Muchos subgrupos ('+subs.length+')');if(!isNaN(sg.pInt)&&sg.pInt<0.05){score++;details.push('‚úÖ Interacci√≥n significativa')}else details.push('‚ùå Interacci√≥n no sig.');if(gBen2===sBen2){score++;details.push('‚úÖ Direcci√≥n consistente')}else details.push('‚ùå Direcci√≥n invertida');if(totalN>0&&sg.n/totalN>=0.3){score++;details.push('‚úÖ N adecuado (‚â•30%)')}else details.push('‚ùå Subgrupo peque√±o');var lv=score>=4?'pass':score>=2?'warn':'fail',lb=score>=4?'ALTA':score>=2?'BAJA-MODERADA':'MUY BAJA';html+=SF.ui.rc(lv,sg.name+': Credibilidad '+lb+' ('+score+'/5)',details.join('<br>'));if(lv==='fail')counts.fail++;else if(lv==='warn')counts.warn++;else counts.pass++})}
// Cherry-picking
html+='<div class="divider"></div><div class="section-label">Reporte selectivo</div>';if(!isNaN(gP)&&gP>=0.05&&sigSubs.length>0){html+=SF.ui.rc('fail','‚ö†Ô∏è Global no sig. pero subgrupos destacados','p global='+gP+'. '+sigSubs.length+' subgrupo(s) sig. <strong>Cherry-picking.</strong>');counts.fail++;questions.push('Resultado global no significativo (p='+gP+'). ¬øSubgrupos preespecificados? Con '+subs.length+' subgrupos, P(FP)='+(probFP(subs.length,0.05)*100).toFixed(0)+'%.')}
var expSig2=subs.length*0.05;if(sigSubs.length>0&&sigSubs.length<=Math.ceil(expSig2)+1&&subs.length>=6){html+=SF.ui.rc('warn','Subgrupos sig. compatibles con azar',sigSubs.length+'/'+subs.length+' (esperados ~'+expSig2.toFixed(1)+')');counts.warn++}
if(prespec==='unknown'){html+=SF.ui.rc('warn','Preespecificaci√≥n no indicada','CONSORT lo requiere.');counts.warn++;questions.push('¬øLos subgrupos estaban preespecificados en el protocolo?')}else if(prespec==='no'){html+=SF.ui.rc('warn','An√°lisis post-hoc','Generadores de hip√≥tesis, no confirmatorios.');counts.warn++}
if(counts.fail===0&&sigSubs.length===0){html+=SF.ui.rc('pass','Sin cherry-picking','‚úì');counts.pass++}
SF.ui.addFinding(MNAME,counts.fail>0?'fail':counts.warn>0?'warn':'pass',subs.length+' subgrupos, '+sigSubs.length+' sig. P(FP)='+(pfp*100).toFixed(0)+'%','Interacciones:'+(hasAnyPI?'s√≠':'NO')+'. Prespec:'+prespec);questions.forEach(function(q){html+=SF.ui.questionCard(q)});html+='<div class="note"><strong>ICH E9:</strong> Solo subgrupos preespecificados con test de interacci√≥n son confirmatorios. Post-hoc son exploratorios.</div>';html=SF.ui.summaryBar(counts)+html;document.getElementById('subgroups-results').innerHTML=html}
function init(){addRow('','','','','','')}
SF.ui.registerModule(MID,{init:init,getHTML:getHTML,run:run});SF.modules=SF.modules||{};SF.modules.subgroups={addRow:addRow,removeRow:removeRow,loadPreset:loadPreset,run:run}
})();

// ============================================================
// INIT
// ============================================================
window.addEventListener('load',function(){SF.ui.init();SF.capture.init()});
</script>
</body>
</html>