subtitle = "Comparison: Real Data vs. Cognitive Biases",
fill = "Status",
x = "Last Digit",
y = "Relative Frequency") +
theme_academic()
# D. Forensic diagnostic table based on deviations
table_digit_diagnostics <- analysis_last_digit %>%
group_by(participant) %>%
summarise(
Avg_Deviation = mean(abs(prop - 0.10)) * 100,
Sum_0_5      = sum(prop[last_digit %in% c(0,5)]) * 100
) %>%
mutate(
Evaluation = case_when(
Sum_0_5 > 25 ~ "Suspicious: Excess Rounding",
Sum_0_5 < 15 ~ "Suspicious: Artificial Avoidance",
Avg_Deviation > 4.0 ~ "Suspicious: Irregular Pattern",
TRUE ~ "Natural Pattern"
),
Avg_Deviation    = sprintf("%.1f%%", Avg_Deviation),
Sum_0_5         = sprintf("%.1f%%", Sum_0_5)
) %>%
select(Participant = participant,
`Avg. Deviation` = Avg_Deviation,
`Frequency 0 and 5` = Sum_0_5,
Evaluation)
# For a formatted kableExtra version (not displayed unless called)
table_digit_diagnostics_kbl <- kbl(table_digit_diagnostics, caption = "Last Digit Diagnostics") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 7. Fourth test: Benford's Law (The Second Digit) ----------------------
# Note: Given the narrow hemoglobin range, we use tens frequency
# instead of full Benford to detect aversion to extremes.
# Analysis of tens digits (second digit)
analysis_tens <- data_students %>%
mutate(tens_digit = floor((value %% 100) / 10)) %>%
count(participant, tens_digit) %>%
group_by(participant) %>%
mutate(prop = n / sum(n))
# Adapted Benford plot: Bars with a smooth trend
g_benford <- ggplot(analysis_tens, aes(x = factor(tens_digit), y = prop)) +
geom_col(aes(fill = participant), color = "white", show.legend = FALSE) +
# Smooth line for trend
geom_smooth(aes(group=1), method = "loess", se = FALSE, color="black", linetype="dashed") +
facet_wrap(~ participant, scales = "free_x", labeller = as_labeller(c(
"La Entusiasta" = "The Enthusiastic",
"La Confiada" = "The Confident",
"La Prudente" = "The Prudent"
))) +
# Use fixed_colors for consistency (excluding REALITY)
scale_fill_manual(values = fixed_colors[names(fixed_colors) != "REALITY"]) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(title = "Benford's Ghost: Analysis of Tens Digits",
subtitle = "Artificial 'Mountain' (Aversion to Extremes) vs. Natural Dispersion",
x = "Second Digit (Tens: 1[3]6)",
y = "Frequency") +
theme_academic()
# 7. RUNS TEST (INDEPENDENCE) -----------------------------------------
# Runs test to detect non-randomness in the sequence of values
analysis_runs <- data_students %>%
group_by(participant) %>%
summarise(
Z_Score = {
x <- value; med <- median(x); signs <- sign(x - med); signs <- signs[signs != 0]
if(length(signs) < 10) NA else { # Avoid error with too few non-zero data points
runs <- rle(signs); n1 <- sum(signs == 1); n2 <- sum(signs == -1); n <- n1 + n2
# Ensure n1 and n2 are not zero to avoid division by zero
if(n1 == 0 || n2 == 0) NA else {
mu <- 2 * n1 * n2 / n + 1
sigma <- sqrt((mu - 1) * (mu - 2) / (n - 1))
(length(runs$lengths) - mu) / sigma
}
}
}
) %>%
mutate(
Evaluation = case_when(
is.na(Z_Score) ~ "Insufficient Data/Not Calculable",
abs(Z_Score) > 1.96 ~ "Non-Random",
TRUE ~ "Random"
)
) %>%
# Rename participant column for display
rename(Participant = participant)
# Display table for runs
table_runs_display <- analysis_runs %>%
# Select the original Z_Score and other columns
select(Participant,
Z_Score, # Select the column named 'Z_Score' (with underscore)
Evaluation) %>%
# Round Z_Score and assign it to a new column named `Z-Score` (with hyphen)
mutate(`Z-Score` = round(Z_Score, 2)) %>%
# Finally, select the columns in the desired order, including the newly named `Z-Score`
select(Participant, `Z-Score`, Evaluation)
# For a formatted kableExtra version (not displayed unless called)
table_runs_kbl <- kbl(table_runs_display, caption = "Runs Test per Participant") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 8. Fifth test: Distribution Analysis (Shape and Skewness) ----------------
# Prepare data with factors (includes REALITY)
data_plot_shape <- data_full %>% # Use data_full to include REALITY
mutate(participant = factor(participant,
levels = c("REALITY", "La Confiada", "La Entusiasta", "La Prudente")))
# Table of shape metrics (mean, SD, skewness, kurtosis)
table_shape <- data_plot_shape %>%
group_by(participant) %>%
summarise(
Mean = mean(value),
SD = sd(value),
Skewness = moments::skewness(value),
Kurtosis = moments::kurtosis(value)
) %>%
# Rename participant column for display
rename(Participant = participant)
# For a formatted kableExtra version (not displayed unless called)
table_shape_kbl <- kbl(table_shape, caption = "Distribution Shape Metrics") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
round_columns(2:5) # Round numeric columns for better visualization
¡Lo siento mucho! Parece que estamos teniendo una racha de pequeños errores de consistencia. Tienes toda la razón en señalarlo.
## ==============================================================================
# SCRIPT: FORENSIC DATA ANALYSIS
# Author: Maicel Monzon MD, PhD
# Date: 02/12/2025
#
# Overview:
# This script performs a forensic analysis of invented student data from an
# experiment on hemoglobin. It compares data generated by three participants
# ("The Enthusiast", "The Confident", "The Prudent") with real values ("REALITY")
# and a theoretical normal distribution.
#
# Descriptive statistics are calculated, and tables and graphs are generated to
# detect anomalies such as biases in means, variability, digit distribution,
# Benford's Law compliance, runs, and distribution shape.
#
# Dependencies: Requires the "experiment.csv" file with 'participant' and
# 'value' columns. Ensure it's in your working directory.
#
#
# Usage Instructions:
# - Run the complete script.
# - To visualize graphics: Call graphic objects like g_ranges, g_distribution, etc.
# - To visualize tables: Call table objects like table_mean, table_variability_kbl, etc.
# ==============================================================================
# LOAD LIBRARIES AND CONFIGURATION ----------------------------------------
# Suppress messages for clean output
suppressMessages(library(tidyverse, verbose = F))
library(conflicted)
# Resolve common conflicts: Prefer dplyr's filter and moments' skewness/kurtosis
conflicts_prefer(dplyr::filter)
conflicts_prefer(moments::skewness)
conflicts_prefer(moments::kurtosis)
library(moments) # For skewness and kurtosis calculations
library(scales) # For percentage formatting in plots
library(readr) # For CSV reading
library(kableExtra) # For formatted HTML tables
# Forensic libraries (used for Benford and other tests)
library(digitTests)
library(benford.analysis)
library(randtests)
library(scrutiny)
library(statcheck)
library(dlookr)
library(gtsummary)
library(labelled)
# DEFINE THEME AND AESTHETICS ---------------------------------------------
# Custom theme for graphics: Minimalist and academic, with soft grids
theme_academic <- function() {
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", color = "black", size = 16, margin = margin(b = 10)),
plot.subtitle = element_text(color = "grey20", size = 12, margin = margin(b = 10)),
axis.title = element_text(color = "black", size = 12),
axis.text = element_text(color = "grey10", size = 10),
strip.background = element_rect(fill = "grey95", color = NA),
strip.text = element_text(color = "black", face = "bold", size = 12),
legend.position = "bottom",
panel.grid.major = element_line(color = "grey85", linewidth = 0.3, linetype = "dashed"),
panel.grid.minor = element_blank(),
axis.line = element_line(color = "grey30", linewidth = 0.5),
panel.background = element_rect(fill = "white", color = NA),
plot.background = element_rect(fill = "white", color = NA),
plot.margin = margin(10, 10, 10, 10)
)
}
# COLOR PALETTE
# Fixed colors for visual consistency: Assigned to each participant, including REALITY as reference
fixed_colors <- c(
"La Entusiasta" = "#E41A1C", # Red
"La Confiada"   = "#377EB8", # Blue
"La Prudente"   = "#4DAF4A", # Green
"REALITY"      = "black"    # Black (Absolute reference)
)
# LOAD AND PREPARE DATA ----------------------------------------------
# Load data from CSV (assuming columns: participant, value)
# Create a dummy CSV if it doesn't exist to make the script runnable
if (!file.exists("experiment.csv")) {
set.seed(123)
experiment_data <- tibble(
# Using original Spanish participant names as internal identifiers,
# but display labels will be translated.
participant = c(rep("La Entusiasta", 100), rep("La Confiada", 100), rep("La Prudente", 100), rep("REALITY", 1000)),
value = c(
round(rnorm(100, mean = 138, sd = 3)),  # Enthusiast: positive bias, low variability
round(rnorm(100, mean = 130, sd = 10)), # Confident: negative bias, more variability
round(runif(100, min = 130, max = 140)), # Prudent: narrow range, uniform
round(rnorm(1000, mean = 136, sd = 7.5)) # Reality: normal distribution
)
)
# Ensure values are within a realistic range (e.g., 100-160)
experiment_data$value[experiment_data$value < 100] <- 100
experiment_data$value[experiment_data$value > 160] <- 160
write_csv(experiment_data, "experiment.csv")
}
data_full <- readr::read_delim(file = "experiment.csv", delim = ",", show_col_types = FALSE)
# Subset without REALITY for comparative analyses (students vs. real)
data_students <- data_full %>% dplyr::filter(participant != "REALITY")
# FIXED LITERATURE PARAMETERS (Medical Reference)
# Reference values for adult female hemoglobin
mean_real <- 136.0  # g/L (population mean)
sd_real    <- 7.5    # g/L (population standard deviation)
# 4. First test: Did they hit the center?----------------------------------
# Calculate means per participant and difference from real mean
table_mean <- data_students %>%
group_by(participant) %>%
summarise(
N = n(),
Mean = mean(value),
SD = sd(value),
.groups = 'drop'
) %>%
mutate(
Ref_Mean = mean_real,
Difference = Mean - mean_real
) %>%
# Rename participant column for display
rename(Participant = participant)
# For a formatted kableExtra version (not displayed unless called)
table_mean_kbl <- kbl(table_mean, caption = "Hemoglobin Means per Participant") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 5. Second test: Did they simulate variability well?-----------------------
# Calculate variability (SD, min, max) and evaluate difference from reference
table_variability <- data_students %>%
group_by(participant) %>%
summarise(
SD = sd(value),
Min = min(value),
Max = max(value)
) %>%
mutate(
Ref_SD = sd_real,
Dif_SD = abs(SD - sd_real),
Evaluation = case_when(
Dif_SD < 2.5 ~ "Excellent",
Dif_SD < 5.0 ~ "Acceptable",
TRUE         ~ "Deficient"
)
) %>%
# Rename participant column for display
rename(Participant = participant)
# Formatted table for display
table_variability_display <- table_variability %>%
select(Participant,
`SD (g/L)` = SD,
`Ref. SD` = Ref_SD,
Evaluation)
# For a formatted kableExtra version (not displayed unless called)
table_variability_kbl <- kbl(table_variability_display, caption = "Variability Analysis") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 5. VARIABILITY PLOTS (THE CORE OF THE ANALYSIS) ----------------------
# Summary of ranges for segment plot
summary_ranges_final <- data_full %>%
group_by(participant) %>%
summarise(
min_val = min(value),
max_val = max(value)
) %>%
# Reorder so REALITY is the base
mutate(participant = fct_relevel(participant, "REALITY"))
# Ranges plot: Horizontal segments with extreme points
g_ranges <- ggplot(summary_ranges_final, aes(y = participant)) +
# Reference lines for normal limits
geom_vline(xintercept = c(121, 151),
linetype = "dashed", color = "grey60", linewidth = 0.5) +
# Segment connecting min-max
geom_segment(aes(x = min_val, xend = max_val,
y = participant, yend = participant,
color = participant),
linewidth = 1.2, alpha = 0.8) +
# Points at extremes
geom_point(aes(x = min_val, color = participant), size = 4) +
geom_point(aes(x = max_val, color = participant), size = 4) +
# Scales and colors
scale_x_continuous(breaks = seq(100, 160, 5), limits = c(100, 160)) +
scale_color_manual(values = fixed_colors,
labels = c("REALITY" = "Real Biology (Reference)",
"La Confiada" = "The Confident",
"La Entusiasta" = "The Enthusiastic",
"La Prudente" = "The Prudent")) +
# Labels
labs(title = "Observed Ranges [Minimum — Maximum]",
subtitle = "The gray vertical lines mark the normal limits (121 and 151 g/L).",
x = "Hemoglobin (g/L)",
y = NULL,
color = "Participant") + # Legend title for colors
theme_academic() +
theme(
panel.grid.major.y = element_blank(),
panel.grid.major.x = element_line(color = "grey85", linewidth = 0.4),
axis.text.y = element_text(face = "bold", color = "black"),
axis.text.x = element_text(color = "grey20", size = 10)
)
# DENSITY PLOT (DISTRIBUTION) ------------------------------------------
# Density plot of students' data superimposed with theoretical normal
g_distribution <- ggplot(data_students, aes(x = value, color = participant, fill = participant)) +
# A. Normal limits lines
geom_vline(xintercept = c(121, 151), linetype = "dotted", color = "grey50", linewidth = 0.6) +
# B. Theoretical normal curve (reference)
stat_function(fun = dnorm, args = list(mean = mean_real, sd = sd_real),
aes(linetype = "Theoretical Normal Curve"),
color = "black", linewidth = 0.9, inherit.aes = FALSE) +
# C. Observed densities (students)
geom_density(alpha = 0.2, linewidth = 1) +
# D. Scales and colors
scale_color_manual(values = fixed_colors,
labels = c("REALITY" = "Real Biology (Reference)",
"La Confiada" = "The Confident",
"La Entusiasta" = "The Enthusiastic",
"La Prudente" = "The Prudent")) +
scale_fill_manual(values = fixed_colors,
labels = c("REALITY" = "Real Biology (Reference)",
"La Confiada" = "The Confident",
"La Entusiasta" = "The Enthusiastic",
"La Prudente" = "The Prudent")) +
scale_x_continuous(breaks = seq(100, 160, 10), limits = c(95, 160)) +
# E. Labels and theme
labs(title = "The Shape of Fraud: Distribution vs. Normality",
subtitle = "Black line: Normal reference. Dotted lines: Clinical limits (121-151).",
x = "Hemoglobin (g/L)",
y = "Density",
linetype = "", # Legend title for linetype
color = "Participant", # Legend title for color
fill = "Participant") + # Legend title for fill
theme_academic() +
theme(legend.position = "bottom")
# 6. Third test: The last digit (The trail of chaos) ------------------
# A. Calculate proportions of last digits and detect anomalies
analysis_last_digit <- data_students %>%
mutate(last_digit = factor(value %% 10, levels = 0:9)) %>%
count(participant, last_digit, .drop = FALSE) %>%
group_by(participant) %>%
mutate(
prop = n / sum(n),
is_high = abs(prop - 0.10) > 0.06
)
# B. Table with HTML format (colors for deviations)
# First prepare the table data
table_last_digit_data <- analysis_last_digit %>%
mutate(
prop_format = paste0(round(prop * 100, 1), "%"),
prop_html = ifelse(
is_high,
cell_spec(prop_format, "html", bold = TRUE, color = "red"),
prop_format
)
) %>%
select(last_digit, participant, prop_html) %>%
pivot_wider(names_from = participant, values_from = prop_html) %>%
arrange(as.numeric(as.character(last_digit))) %>%
# Rename the column for display
rename(`Last Digit` = last_digit)
# Now create the kableExtra object, without direct printing
table_last_digit_kbl <- kbl(
table_last_digit_data,
caption = "Last Digit Frequency per Participant",
escape = FALSE, # Important for HTML inside cell_spec to render
col.names = c("Last Digit", "The Enthusiastic", "The Confident", "The Prudent") # Translate column names
) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# C. Bar plot for last digit distribution
g_last_digit <- ggplot(analysis_last_digit, aes(x = last_digit, y = prop)) +
geom_hline(yintercept = 0.10, linetype = "solid", color = "black", alpha = 0.5) +
geom_col(aes(fill = is_high), width = 0.7, color = "white") +
facet_wrap(~ participant, labeller = as_labeller(c(
"La Entusiasta" = "The Enthusiastic",
"La Confiada" = "The Confident",
"La Prudente" = "The Prudent"
))) +
scale_fill_manual(values = c("FALSE" = "gray60", "TRUE" = "firebrick"),
labels = c("Expected", "High Deviation")) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(title = "Detection of Fabricated Data: Last Digit",
subtitle = "Comparison: Real Data vs. Cognitive Biases",
fill = "Status",
x = "Last Digit",
y = "Relative Frequency") +
theme_academic()
# D. Forensic diagnostic table based on deviations
table_digit_diagnostics <- analysis_last_digit %>%
group_by(participant) %>%
summarise(
Avg_Deviation = mean(abs(prop - 0.10)) * 100,
Sum_0_5      = sum(prop[last_digit %in% c(0,5)]) * 100
) %>%
mutate(
Evaluation = case_when(
Sum_0_5 > 25 ~ "Suspicious: Excess Rounding",
Sum_0_5 < 15 ~ "Suspicious: Artificial Avoidance",
Avg_Deviation > 4.0 ~ "Suspicious: Irregular Pattern",
TRUE ~ "Natural Pattern"
),
Avg_Deviation    = sprintf("%.1f%%", Avg_Deviation),
Sum_0_5         = sprintf("%.1f%%", Sum_0_5)
) %>%
select(Participant = participant,
`Avg. Deviation` = Avg_Deviation,
`Frequency 0 and 5` = Sum_0_5,
Evaluation)
# For a formatted kableExtra version (not displayed unless called)
table_digit_diagnostics_kbl <- kbl(table_digit_diagnostics, caption = "Last Digit Diagnostics") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 7. Fourth test: Benford's Law (The Second Digit) ----------------------
# Note: Given the narrow hemoglobin range, we use tens frequency
# instead of full Benford to detect aversion to extremes.
# Analysis of tens digits (second digit)
analysis_tens <- data_students %>%
mutate(tens_digit = floor((value %% 100) / 10)) %>%
count(participant, tens_digit) %>%
group_by(participant) %>%
mutate(prop = n / sum(n))
# Adapted Benford plot: Bars with a smooth trend
g_benford <- ggplot(analysis_tens, aes(x = factor(tens_digit), y = prop)) +
geom_col(aes(fill = participant), color = "white", show.legend = FALSE) +
# Smooth line for trend
geom_smooth(aes(group=1), method = "loess", se = FALSE, color="black", linetype="dashed") +
facet_wrap(~ participant, scales = "free_x", labeller = as_labeller(c(
"La Entusiasta" = "The Enthusiastic",
"La Confiada" = "The Confident",
"La Prudente" = "The Prudent"
))) +
# Use fixed_colors for consistency (excluding REALITY)
scale_fill_manual(values = fixed_colors[names(fixed_colors) != "REALITY"]) +
scale_y_continuous(labels = percent_format(accuracy = 1)) +
labs(title = "Benford's Ghost: Analysis of Tens Digits",
subtitle = "Artificial 'Mountain' (Aversion to Extremes) vs. Natural Dispersion",
x = "Second Digit (Tens: 1[3]6)",
y = "Frequency") +
theme_academic()
# 7. RUNS TEST (INDEPENDENCE) -----------------------------------------
# Runs test to detect non-randomness in the sequence of values
analysis_runs <- data_students %>%
group_by(participant) %>%
summarise(
Z_Score = {
x <- value; med <- median(x); signs <- sign(x - med); signs <- signs[signs != 0]
if(length(signs) < 10) NA else { # Avoid error with too few non-zero data points
runs <- rle(signs); n1 <- sum(signs == 1); n2 <- sum(signs == -1); n <- n1 + n2
# Ensure n1 and n2 are not zero to avoid division by zero
if(n1 == 0 || n2 == 0) NA else {
mu <- 2 * n1 * n2 / n + 1
sigma <- sqrt((mu - 1) * (mu - 2) / (n - 1))
(length(runs$lengths) - mu) / sigma
}
}
}
) %>%
mutate(
Evaluation = case_when(
is.na(Z_Score) ~ "Insufficient Data/Not Calculable",
abs(Z_Score) > 1.96 ~ "Non-Random",
TRUE ~ "Random"
)
) %>%
# Rename participant column for display
rename(Participant = participant)
# Display table for runs
table_runs_display <- analysis_runs %>%
# Select the original Z_Score and other columns
select(Participant,
Z_Score, # Select the column named 'Z_Score' (with underscore)
Evaluation) %>%
# Round Z_Score and assign it to a new column named `Z-Score` (with hyphen)
mutate(`Z-Score` = round(Z_Score, 2)) %>%
# Finally, select the columns in the desired order, including the newly named `Z-Score`
select(Participant, `Z-Score`, Evaluation)
# For a formatted kableExtra version (not displayed unless called)
table_runs_kbl <- kbl(table_runs_display, caption = "Runs Test per Participant") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)
# 8. Fifth test: Distribution Analysis (Shape and Skewness) ----------------
# Prepare data with factors (includes REALITY)
data_plot_shape <- data_full %>% # Use data_full to include REALITY
mutate(participant = factor(participant,
levels = c("REALITY", "La Confiada", "La Entusiasta", "La Prudente")))
# Table of shape metrics (mean, SD, skewness, kurtosis)
table_shape <- data_plot_shape %>%
group_by(participant) %>%
summarise(
Mean = mean(value),
SD = sd(value),
Skewness = moments::skewness(value),
Kurtosis = moments::kurtosis(value)
) %>%
# Rename participant column for display
rename(Participant = participant)
# For a formatted kableExtra version (not displayed unless called)
table_shape_kbl <- kbl(table_shape, caption = "Distribution Shape Metrics") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F) %>%
kableExtra::round_columns(2:5) # CORRECTED: Explicitly call kableExtra::round_columns()
blogdown::serve_site()
blogdown::serve_site()
blogdown:::stop_server()                              # Detiene el servidor.
unlink("public", recursive = TRUE)                    # Borrar carpeta public
blogdown::build_site(local = FALSE, build_rmd = TRUE) # Construye.
blogdown:::serve_site()                               # preview.
blogdown:::serve_site()                               # preview.
