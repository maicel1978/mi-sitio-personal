<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voz a Texto (ASR) - BioestadÃ­sticaEdu</title>
    
    <style>
        :root { --primary: #10b981; --edu: #ff9800; --bg: #f8fafc; --dark: #0f172a; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; color: var(--dark); }
        
        .card { background: white; max-width: 500px; width: 100%; padding: 25px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        
        .brand { text-align: center; margin-bottom: 20px; }
        .brand h1 { margin: 0; font-size: 1.6rem; letter-spacing: -1px; color: var(--primary); }
        .brand .edu { color: var(--edu); font-weight: 800; }
        .brand p { margin: 5px 0 0; font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }

        .tech-badge { background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .tech-badge h2 { margin: 0; font-size: 0.75rem; color: #065f46; text-transform: uppercase; letter-spacing: 0.5px; }
        .tech-badge p { margin: 4px 0 0; font-size: 0.85rem; color: #047857; line-height: 1.4; }

        .status-container { margin-bottom: 20px; padding: 12px; background: #f1f5f9; border-radius: 12px; border: 1px solid #e2e8f0; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: #475569; margin-bottom: 8px; font-weight: bold; }
        .progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s ease; }

        .upload-area { border: 2px dashed #cbd5e0; padding: 25px 15px; border-radius: 16px; text-align: center; margin-bottom: 15px; cursor: pointer; background: #fff; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #f0fdf4; }
        
        textarea { width: 100%; height: 180px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; resize: none; font-size: 0.95rem; margin-bottom: 15px; background: #fcfcfc; line-height: 1.6; outline: none; }
        textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: var(--primary); color: white; margin-bottom: 10px; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2); }
        .btn-main:disabled { background: #94a3b8; cursor: wait; box-shadow: none; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-sec { background: #fff; color: #475569; border: 1px solid #d1d5db; font-size: 0.8rem; }
        .btn-sec:hover { background: #f8fafc; }

        footer { text-align: center; margin-top: 25px; font-size: 0.7rem; color: #94a3b8; border-top: 1px solid #f1f5f9; padding-top: 15px; line-height: 1.5; }
        .author { color: #334155; font-weight: 700; }

        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <div class="brand">
        <h1>Voz a Texto</h1>
        <p>BioestadÃ­stica<span class="edu">Edu</span></p>
    </div>

    <!-- Wow Effect: ExplicaciÃ³n tecnolÃ³gica -->
    <div class="tech-badge">
        <h2>Arquitectura Neural de Vanguardia</h2>
        <p>Procesamiento AutomÃ¡tico del Habla mediante <strong>Redes Neuronales Transformer (Whisper ASR)</strong>. TranscripciÃ³n local con IA de grado cientÃ­fico.</p>
    </div>

    <!-- Monitor de Red Neuronal -->
    <div class="status-container">
        <div class="progress-info">
            <span id="status-text">Cargando Red Neuronal...</span>
            <span id="percent-text">0%</span>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div class="upload-area" onclick="document.getElementById('audio-in').click()">
        <span id="file-name">ðŸ“‚ Seleccionar archivo de voz (Audio)</span>
        <input type="file" id="audio-in" hidden accept="audio/*">
    </div>

    <textarea id="output" placeholder="El texto procesado por la IA aparecerÃ¡ aquÃ­..."></textarea>

    <button id="start-btn" class="btn btn-main" disabled>
        <div class="spinner" id="btn-spinner"></div>
        <span id="btn-text">ESPERANDO IA...</span>
    </button>
    
    <div class="btn-group" id="actions" style="display:none">
        <button id="copy-btn" class="btn btn-sec">ðŸ“‹ COPIAR TEXTO</button>
        <button id="save-btn" class="btn btn-sec">ðŸ’¾ GUARDAR .TXT</button>
    </div>

    <footer>
        ANTAGONISTA DEL PROTOCOLO "TEXTO A VOZ"<br>
        Desarrollado por: <span class="author">Maicel MonzÃ³n-PÃ©rez</span><br>
        Â© 2024 - EjecuciÃ³n Neural Local y Privada
    </footer>
</div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    const statusText = document.getElementById('status-text');
    const percentText = document.getElementById('percent-text');
    const progressFill = document.getElementById('progress-fill');
    const startBtn = document.getElementById('start-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const output = document.getElementById('output');
    const audioIn = document.getElementById('audio-in');
    const actions = document.getElementById('actions');

    let transcriber;

    // InicializaciÃ³n del Modelo Transformer
    async function initIA() {
        try {
            transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny', {
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        const p = Math.round(data.progress);
                        progressFill.style.width = p + '%';
                        percentText.innerText = p + '%';
                        statusText.innerText = 'Descargando motor neural...';
                    }
                    if (data.status === 'ready') {
                        statusText.innerText = 'âœ“ Red Neuronal lista';
                        percentText.innerText = '100%';
                        startBtn.disabled = false;
                        btnText.innerText = 'INICIAR PROCESAMIENTO';
                    }
                }
            });
        } catch (e) {
            statusText.innerText = 'Error: Revisa tu conexiÃ³n.';
            console.error(e);
        }
    }

    initIA();

    audioIn.onchange = (e) => {
        if(e.target.files[0]) {
            document.getElementById('file-name').innerText = "âœ“ Audio: " + e.target.files[0].name;
            startBtn.disabled = false;
        }
    };

    startBtn.onclick = async () => {
        if (!audioIn.files[0]) return;
        
        startBtn.disabled = true;
        btnSpinner.style.display = 'block';
        btnText.innerText = 'ANALIZANDO ONDAS...';
        output.value = "La IA estÃ¡ procesando el lenguaje natural. Este proceso es intensivo y ocurre 100% en tu dispositivo...";

        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const arrayBuffer = await audioIn.files[0].arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(arrayBuffer);
            const audioData = decoded.getChannelData(0);

            const result = await transcriber(audioData, { 
                language: 'spanish', 
                task: 'transcribe',
                chunk_length_s: 30,
                stride_length_s: 5
            });

            output.value = result.text;
            actions.style.display = "grid";
            statusText.innerText = "âœ“ Procesamiento completado";
        } catch (err) {
            output.value = "Error: El audio es muy complejo o el dispositivo no tiene suficiente memoria RAM.";
            statusText.innerText = "Fallo en la transcripciÃ³n.";
        } finally {
            startBtn.disabled = false;
            btnSpinner.style.display = 'none';
            btnText.innerText = 'NUEVA TRANSCRIPCIÃ“N';
        }
    };

    // Funcionalidad de Copiar
    document.getElementById('copy-btn').onclick = () => {
        navigator.clipboard.writeText(output.value);
        const btn = document.getElementById('copy-btn');
        btn.innerText = "âœ… COPIADO";
        setTimeout(() => btn.innerText = "ðŸ“‹ COPIAR TEXTO", 2000);
    };

    // Funcionalidad de Guardar TXT
    document.getElementById('save-btn').onclick = () => {
        const text = output.value;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Transcripcion_Voz_BioEdu_${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    };
</script>

</body>
</html>