<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Lab Dictation Pro - Maicel Monz√≥n-P√©rez</title>
    <style>
        :root { --primary: #6366f1; --edu: #ff9800; --bg: #0f172a; --card: #1e293b; --error: #ef4444; --success: #10b981; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; color: #f8fafc; }
        .card { background: var(--card); max-width: 500px; width: 100%; padding: 25px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); border: 1px solid #334155; box-sizing: border-box; }
        .brand { text-align: center; margin-bottom: 20px; }
        .brand h1 { margin: 0; font-size: 1.5rem; letter-spacing: -1px; color: var(--primary); }
        .brand .edu { color: var(--edu); font-weight: 800; }
        .brand p { margin: 5px 0 0; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }

        /* Badge Tecnol√≥gico */
        .tech-badge { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 12px; padding: 14px; margin-bottom: 20px; font-size: 0.8rem; line-height: 1.4; color: #cbd5e1; }

        /* Asistente de Micr√≥fono */
        .help-card { display: none; background: #2d2d30; border: 2px solid var(--edu); padding: 15px; border-radius: 16px; margin-bottom: 20px; font-size: 0.85rem; }
        .help-card h3 { color: var(--edu); margin: 0 0 10px 0; font-size: 1rem; }
        .browser-icon { background: #444; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        /* Monitor de IA */
        .status-box { background: #000; padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #334155; }
        .status-header { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: bold; margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        /* V√∫metro Real */
        .vu-container { display: flex; gap: 3px; height: 30px; align-items: flex-end; justify-content: center; margin-bottom: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 5px; }
        .vu-bar { width: 6px; background: var(--primary); border-radius: 2px; height: 3px; transition: height 0.1s; }

        textarea { width: 100%; height: 200px; padding: 15px; border: 1px solid #334155; border-radius: 16px; font-size: 1rem; background: #0f172a; color: #fff; line-height: 1.6; outline: none; margin-bottom: 15px; box-sizing: border-box; }
        textarea:focus { border-color: var(--primary); }

        .btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-rec { background: var(--primary); }
        .recording .btn-rec { background: var(--error); animation: pulse 1.5s infinite; }
        .btn-rec:disabled { background: #334155; cursor: wait; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-sec { background: #334155; color: #cbd5e1; font-size: 0.8rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4); } 100% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }
        footer { text-align: center; margin-top: 25px; font-size: 0.65rem; color: #64748b; border-top: 1px solid #334155; padding-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <div class="brand">
        <h1>Bio-Lab Dictation</h1>
        <p>Bioestad√≠stica<span class="edu">Edu</span></p>
    </div>

    <div class="tech-badge">
        <strong>IA Aut√≥noma:</strong> Whisper Neural Network (Tiny).<br>
        Procesamiento Transformer ejecutado 100% en local.
    </div>

    <!-- Ayuda de Micr√≥fono -->
    <div id="help-card" class="help-card">
        <h3>üéôÔ∏è Acceso Denegado</h3>
        <div id="instr-chrome" style="display:none">Toca el üîí al lado de la URL y activa el <b>Micr√≥fono</b>.</div>
        <div id="instr-safari" style="display:none">Toca <span class="browser-icon">AA</span> y entra en <b>Configuraci√≥n del sitio</b> para permitir el micro.</div>
        <button onclick="location.reload()" class="btn btn-sec" style="margin-top:10px">REINTENTAR RECARGANDO</button>
    </div>

    <div class="status-box">
        <div class="status-header">
            <span id="status-txt">Iniciando Red Neuronal...</span>
            <span id="percent-txt">0%</span>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div class="vu-container" id="vu-meter"></div>

    <textarea id="output" placeholder="Dicta tus observaciones aqu√≠..."></textarea>

    <button id="rec-btn" class="btn btn-rec" disabled>CARGANDO MODELO...</button>
    
    <div class="btn-group" style="margin-top:10px">
        <button id="copy-btn" class="btn btn-sec">üìã COPIAR</button>
        <button id="export-btn" class="btn btn-sec">üíæ TXT</button>
    </div>

    <footer>
        PROTOCOLOS DE CAPTURA NEURAL OFFLINE<br>
        Desarrollado por: <strong>Maicel Monz√≥n-P√©rez</strong>
    </footer>
</div>

<script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

    const statusTxt = document.getElementById('status-txt');
    const percentTxt = document.getElementById('percent-txt');
    const progressFill = document.getElementById('progress-fill');
    const recBtn = document.getElementById('rec-btn');
    const output = document.getElementById('output');
    const vuContainer = document.getElementById('vu-meter');
    const helpCard = document.getElementById('help-card');

    let transcriber;
    let isRecording = false;
    let audioContext;
    let stream;
    let audioChunks = [];

    // Generar V√∫metro
    for(let i=0; i<15; i++) {
        const bar = document.createElement('div');
        bar.className = 'vu-bar';
        vuContainer.appendChild(bar);
    }
    const vuBars = document.querySelectorAll('.vu-bar');

    async function initIA() {
        try {
            if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost') {
                statusTxt.innerText = "‚ùå REQUIERE HTTPS";
                return;
            }

            transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny', {
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        const p = Math.round(data.progress);
                        progressFill.style.width = p + '%';
                        percentTxt.innerText = p + '%';
                        statusTxt.innerText = 'Descargando IA...';
                    }
                    if (data.status === 'ready') {
                        statusTxt.innerText = '‚úì Motor Neural Preparado';
                        percentTxt.innerText = '100%';
                        recBtn.disabled = false;
                        recBtn.innerText = 'INICIAR DICTADO';
                    }
                }
            });
        } catch (e) {
            statusTxt.innerText = "Error cargando motor.";
        }
    }

    initIA();

    async function toggleRecording() {
        if (!isRecording) {
            try {
                // Forzar despertar AudioContext por interacci√≥n humana
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                }
                if (audioContext.state === 'suspended') await audioContext.resume();

                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });

                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 64;
                source.connect(analyser);
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                const updateVU = () => {
                    if(!isRecording) return;
                    analyser.getByteFrequencyData(dataArray);
                    vuBars.forEach((bar, i) => {
                        const val = (dataArray[i] / 255) * 40;
                        bar.style.height = Math.max(3, val) + "px";
                    });
                    requestAnimationFrame(updateVU);
                };
                updateVU();

                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (isRecording) {
                        audioChunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
                        if (audioChunks.length > 30) processAudio(); // Bloques de ~8 seg
                    }
                };

                isRecording = true;
                document.body.classList.add('recording');
                recBtn.innerText = "DETENER Y PROCESAR";
                helpCard.style.display = 'none';

            } catch (err) {
                showHelp();
            }
        } else {
            stopRecording();
        }
    }

    async function processAudio() {
        if (audioChunks.length === 0) return;
        const fullBuffer = concatBuffers(audioChunks);
        audioChunks = [];
        
        statusTxt.innerText = "‚ö° Transcribiendo...";
        const result = await transcriber(fullBuffer, { language: 'spanish', task: 'transcribe' });

        if (result.text.trim()) {
            let t = result.text.trim();
            t = t.charAt(0).toUpperCase() + t.slice(1);
            t = t.replace(/\bpunto\b/gi, ".").replace(/\bcoma\b/gi, ",").replace(/\bnueva l√≠nea\b/gi, "\n");
            output.value += (output.value ? ' ' : '') + t;
            output.scrollTop = output.scrollHeight;
        }
        statusTxt.innerText = "‚úì Motor Neural Preparado";
    }

    function stopRecording() {
        isRecording = false;
        document.body.classList.remove('recording');
        recBtn.innerText = "INICIAR DICTADO";
        processAudio();
        if (stream) stream.getTracks().forEach(t => t.stop());
        vuBars.forEach(b => b.style.height = "3px");
    }

    function showHelp() {
        helpCard.style.display = 'block';
        const ua = navigator.userAgent.toLowerCase();
        if (ua.includes('safari') && !ua.includes('chrome')) {
            document.getElementById('instr-safari').style.display = 'block';
        } else {
            document.getElementById('instr-chrome').style.display = 'block';
        }
    }

    function concatBuffers(chunks) {
        const length = chunks.reduce((acc, curr) => acc + curr.length, 0);
        const result = new Float32Array(length);
        let offset = 0;
        for (const chunk of chunks) {
            result.set(chunk, offset);
            offset += chunk.length;
        }
        return result;
    }

    recBtn.onclick = toggleRecording;

    document.getElementById('copy-btn').onclick = () => {
        navigator.clipboard.writeText(output.value);
        alert("Copiado al portapapeles");
    };

    document.getElementById('export-btn').onclick = () => {
        const blob = new Blob([output.value], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Notas_Lab_${Date.now()}.txt`;
        a.click();
    };
</script>
</body>
</html>