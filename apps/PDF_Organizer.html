<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bio-PDF Organizer - BioestadÃ­stica Edu</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --panel: #1e293b; --text: #f8fafc; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .container { max-width: 1100px; width: 100%; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: -1px; margin: 0; color: var(--primary); }
        
        .drop-zone { 
            border: 2px dashed #334155; border-radius: 16px; padding: 30px; 
            text-align: center; cursor: pointer; background: var(--panel); 
            transition: 0.3s; margin-bottom: 20px; 
        }
        .drop-zone:hover, .drop-zone.drag-over { 
            border-color: var(--primary); 
            background: rgba(59, 130, 246, 0.1); 
        }

        #pages-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 20px; padding: 20px; background: #020617; border-radius: 16px; 
            min-height: 200px; border: 1px solid #1e293b; 
        }
        
        .page-card { 
            background: #1e293b; border-radius: 8px; padding: 10px; 
            position: relative; cursor: grab; transition: transform 0.2s, box-shadow 0.2s; 
            border: 1px solid #334155; 
        }
        .page-card:active { cursor: grabbing; }
        .page-card canvas { width: 100%; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: block; }
        .page-info { 
            font-size: 10px; color: #94a3b8; margin-top: 8px; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        /* FIX: Clase visual real para SortableJS */
        .sortable-ghost { 
            opacity: 0.4; 
            border: 2px dashed var(--primary) !important; 
        }
        .sortable-chosen {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            transform: scale(1.05);
        }
        
        .btn-del { 
            position: absolute; top: -8px; right: -8px; background: var(--danger); 
            color: white; border: none; border-radius: 50%; width: 24px; height: 24px; 
            cursor: pointer; font-weight: bold; font-size: 12px; display: flex; 
            align-items: center; justify-content: center; z-index: 10; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        .btn-del:hover { background: #dc2626; transform: scale(1.1); }

        .actions { 
            position: sticky; bottom: 20px; background: var(--panel); padding: 20px; 
            border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
            display: none; gap: 15px; margin-top: 30px; 
            border: 1px solid var(--primary); z-index: 100; justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 12px 25px; border-radius: 25px; border: none; 
            font-weight: bold; cursor: pointer; transition: 0.3s; 
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-save { background: var(--primary); color: white; }
        .btn-save:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-clear { background: #334155; color: white; }

        .loader { display: none; margin-top: 10px; font-size: 0.8rem; color: var(--primary); }
        
        .error-toast {
            display: none; background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger);
            color: #fca5a5; padding: 12px 16px; border-radius: 12px; margin-bottom: 15px;
            font-size: 0.8rem; word-break: break-word;
        }

        .page-count {
            text-align: center; font-size: 0.75rem; color: #64748b; 
            margin-bottom: 10px; display: none;
        }
        
        footer { margin-top: 50px; padding: 20px; text-align: center; color: #475569; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Bio-PDF <span style="color:#fff">Organizer</span></h1>
        <p style="color:#64748b">Organiza, combina y reordena pÃ¡ginas localmente</p>
    </header>

    <div class="error-toast" id="errorToast"></div>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <span id="dropText">ğŸ“„ Haz clic o arrastra uno o mÃ¡s PDFs aquÃ­</span>
        <input type="file" id="fileInput" accept="application/pdf" multiple style="display:none">
        <div id="loader" class="loader">â³ Procesando pÃ¡ginas...</div>
    </div>

    <div class="page-count" id="pageCount"></div>

    <div id="pages-grid"></div>

    <div class="actions" id="action-bar">
        <button class="btn btn-save" id="saveBtn" onclick="exportPDF()">ğŸ“¥ DESCARGAR PDF ORGANIZADO</button>
        <button class="btn btn-clear" onclick="clearAll()">ğŸ—‘ï¸ LIMPIAR TODO</button>
    </div>
</div>

<footer>
    Autor: <strong>Maicel MonzÃ³n PÃ©rez</strong> | BioestadÃ­stica Edu<br>
    Privacidad: Tus documentos no salen de tu navegador. CombinaciÃ³n local 100% segura.
</footer>

<script>
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const grid      = document.getElementById('pages-grid');
    const fileInput  = document.getElementById('fileInput');
    const actionBar  = document.getElementById('action-bar');
    const loader     = document.getElementById('loader');
    const dropZone   = document.getElementById('dropZone');
    const errorToast = document.getElementById('errorToast');
    const pageCount  = document.getElementById('pageCount');

    // â”€â”€â”€ AlmacÃ©n de bytes (copias seguras) â”€â”€â”€
    // Cada entrada: { bytes: Uint8Array, name: string }
    let loadedFiles = [];

    // â”€â”€â”€ SortableJS con clases CSS reales â”€â”€â”€
    new Sortable(grid, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag'
    });

    // â”€â”€â”€ Utilidades â”€â”€â”€
    function showError(msg) {
        errorToast.textContent = 'âŒ ' + msg;
        errorToast.style.display = 'block';
        setTimeout(() => { errorToast.style.display = 'none'; }, 8000);
    }

    function updatePageCount() {
        const count = grid.querySelectorAll('.page-card').length;
        if (count > 0) {
            pageCount.textContent = `ğŸ“‘ ${count} pÃ¡gina${count !== 1 ? 's' : ''} en el documento`;
            pageCount.style.display = 'block';
            actionBar.style.display = 'flex';
        } else {
            pageCount.style.display = 'none';
            actionBar.style.display = 'none';
        }
    }

    function clearAll() {
        grid.innerHTML = '';
        loadedFiles = [];
        updatePageCount();
        fileInput.value = '';
    }

    // â”€â”€â”€ Drag & Drop real sobre la zona â”€â”€â”€
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('drag-over');

        const files = Array.from(e.dataTransfer.files).filter(
            f => f.type === 'application/pdf'
        );
        if (files.length === 0) {
            showError('Solo se aceptan archivos PDF.');
            return;
        }
        processFiles(files);
    });

    // â”€â”€â”€ SelecciÃ³n por input â”€â”€â”€
    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            processFiles(files);
        }
        // FIX: Resetear input para permitir re-seleccionar el mismo archivo
        fileInput.value = '';
    };

    // â”€â”€â”€ Procesamiento de archivos â”€â”€â”€
    async function processFiles(files) {
        loader.style.display = 'block';

        for (const file of files) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                // â•‘  FIX CRÃTICO: Crear copia independiente de los      â•‘
                // â•‘  bytes ANTES de pasar a pdf.js, porque el worker    â•‘
                // â•‘  puede transferir (detach) el ArrayBuffer original  â•‘
                // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                const safeBytes = new Uint8Array(arrayBuffer).slice();
                
                // Registrar el archivo en nuestro almacÃ©n
                const fileIdx = loadedFiles.length;
                loadedFiles.push({ bytes: safeBytes, name: file.name });

                // Usar pdf.js SOLO para renderizar miniaturas
                // Le pasamos otra copia para que haga lo que quiera con ella
                const renderCopy = new Uint8Array(safeBytes).buffer;
                const pdf = await pdfjsLib.getDocument({ data: renderCopy }).promise;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.3 });

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width  = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({ 
                        canvasContext: context, 
                        viewport: viewport 
                    }).promise;

                    // Crear tarjeta visual
                    const card = document.createElement('div');
                    card.className = 'page-card';
                    card.dataset.fileIdx  = fileIdx;     // Ãndice en loadedFiles[]
                    card.dataset.pageIdx  = i - 1;       // Ãndice de pÃ¡gina (0-based)

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn-del';
                    delBtn.textContent = 'âœ•';
                    delBtn.onclick = function() {
                        this.parentElement.remove();
                        updatePageCount();
                    };

                    const info = document.createElement('div');
                    info.className = 'page-info';
                    info.textContent = `PÃ¡g. ${i} â€” ${file.name}`;
                    info.title = `${file.name} - PÃ¡gina ${i}`;

                    card.appendChild(delBtn);
                    card.appendChild(canvas);
                    card.appendChild(info);
                    grid.appendChild(card);
                }

                // Liberar recursos de pdf.js
                pdf.destroy();

            } catch (err) {
                console.error(`Error procesando "${file.name}":`, err);
                showError(`No se pudo leer "${file.name}": ${err.message}`);
            }
        }

        loader.style.display = 'none';
        updatePageCount();
    }

    // â”€â”€â”€ Exportar PDF combinado â”€â”€â”€
    async function exportPDF() {
        const cards = Array.from(grid.querySelectorAll('.page-card'));

        if (cards.length === 0) {
            showError('No hay pÃ¡ginas para exportar.');
            return;
        }

        const btn = document.getElementById('saveBtn');
        btn.innerText = 'â³ GENERANDO...';
        btn.disabled = true;

        try {
            const mergedPdf = await PDFDocument.create();
            
            // Cache: evitar cargar el mismo archivo mÃºltiples veces
            const pdfCache = {};

            for (const card of cards) {
                const fileIdx = parseInt(card.dataset.fileIdx);
                const pageIdx = parseInt(card.dataset.pageIdx);

                // Validar que los datos existen
                if (!loadedFiles[fileIdx]) {
                    console.warn(`Archivo Ã­ndice ${fileIdx} no encontrado, saltando pÃ¡gina`);
                    continue;
                }

                // Cargar el PDF fuente (con cache)
                if (!pdfCache[fileIdx]) {
                    // FIX: Usar la copia segura de Uint8Array almacenada
                    pdfCache[fileIdx] = await PDFDocument.load(
                        loadedFiles[fileIdx].bytes.buffer, 
                        { ignoreEncryption: true }
                    );
                }

                const sourcePdf = pdfCache[fileIdx];
                
                // Validar Ã­ndice de pÃ¡gina
                if (pageIdx < 0 || pageIdx >= sourcePdf.getPageCount()) {
                    console.warn(`PÃ¡gina ${pageIdx} fuera de rango en archivo ${fileIdx}`);
                    continue;
                }

                const [copiedPage] = await mergedPdf.copyPages(sourcePdf, [pageIdx]);
                mergedPdf.addPage(copiedPage);
            }

            if (mergedPdf.getPageCount() === 0) {
                throw new Error('El documento resultante no tiene pÃ¡ginas.');
            }

            const pdfBytes = await mergedPdf.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            // FIX: Descarga compatible con todos los navegadores
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'PDF_Organizado_BioEstadistica.pdf';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();

            // Limpieza con retardo para permitir la descarga
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 3000);

        } catch (error) {
            console.error('Error al exportar:', error);
            showError(`Error al generar el PDF: ${error.message}`);
        } finally {
            btn.innerText = 'ğŸ“¥ DESCARGAR PDF ORGANIZADO';
            btn.disabled = false;
        }
    }
</script>

</body>
</html>