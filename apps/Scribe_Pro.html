<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scribe Pro - Transcripci√≥n de Voz Mejorada</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animaci√≥n del bot√≥n de grabaci√≥n */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.8); opacity: 0; }
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .recording-btn.active {
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        .recording-btn.active::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 3px solid #ef4444;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Visualizador de audio */
        .audio-bar {
            transition: height 0.1s ease;
        }

        /* Scrollbar personalizado */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Status indicator */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.ready { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dot.recording { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-dot.error { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        .status-dot.unsupported { background: #6b7280; }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90vw;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Textarea mejorado */
        textarea:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Bot√≥n hover effect */
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* Debug panel */
        .debug-panel {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }
    </style>
</head>
<body class="text-white">

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="glass-strong rounded-xl px-5 py-3 flex items-center gap-3 shadow-2xl">
            <i id="toast-icon" class="fas fa-info-circle text-blue-400"></i>
            <span id="toast-msg" class="text-sm text-white/90"></span>
        </div>
    </div>

    <!-- Header -->
    <header class="glass border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-microphone-lines text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">Scribe Pro</h1>
                    <p class="text-[10px] text-white/40 -mt-0.5">Transcripci√≥n de voz ¬∑ Fix Edition</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleDebug()" class="text-white/40 hover:text-white/80 transition p-2" title="Debug">
                    <i class="fas fa-bug text-sm"></i>
                </button>
                <div class="flex items-center gap-2 glass rounded-lg px-3 py-1.5">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="text-xs text-white/60" id="statusText">Iniciando...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 space-y-5">

        <!-- Diagn√≥stico / Debug Panel -->
        <div id="debugPanel" class="hidden glass rounded-2xl p-4 space-y-3">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-amber-400"><i class="fas fa-stethoscope mr-2"></i>Panel de Diagn√≥stico</h3>
                <button onclick="runDiagnostics()" class="text-xs bg-amber-500/20 text-amber-400 px-3 py-1 rounded-lg hover:bg-amber-500/30 transition">
                    <i class="fas fa-play mr-1"></i>Ejecutar diagn√≥stico
                </button>
            </div>
            <div id="debugLog" class="debug-panel bg-black/40 rounded-xl p-3 max-h-60 overflow-y-auto custom-scroll text-green-400 space-y-1">
                <p class="text-white/30">Presiona "Ejecutar diagn√≥stico" para analizar...</p>
            </div>
        </div>

        <!-- Selector de Idioma y Modo -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="glass rounded-2xl p-4">
                <label class="text-xs text-white/50 mb-2 block font-medium">
                    <i class="fas fa-language mr-1"></i>Idioma de reconocimiento
                </label>
                <select id="langSelect" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500/50 transition appearance-none cursor-pointer">
                    <option value="es-ES">üá™üá∏ Espa√±ol (Espa√±a)</option>
                    <option value="es-MX">üá≤üáΩ Espa√±ol (M√©xico)</option>
                    <option value="es-AR">üá¶üá∑ Espa√±ol (Argentina)</option>
                    <option value="es-CO">üá®üá¥ Espa√±ol (Colombia)</option>
                    <option value="en-US">üá∫üá∏ English (US)</option>
                    <option value="en-GB">üá¨üáß English (UK)</option>
                    <option value="pt-BR">üáßüá∑ Portugu√™s (Brasil)</option>
                    <option value="fr-FR">üá´üá∑ Fran√ßais</option>
                    <option value="de-DE">üá©üá™ Deutsch</option>
                    <option value="it-IT">üáÆüáπ Italiano</option>
                </select>
            </div>
            <div class="glass rounded-2xl p-4">
                <label class="text-xs text-white/50 mb-2 block font-medium">
                    <i class="fas fa-sliders mr-1"></i>Modo de transcripci√≥n
                </label>
                <div class="flex gap-2">
                    <button onclick="setMode('continuous')" id="modeContinuous" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30">
                        <i class="fas fa-infinity mr-1"></i>Continuo
                    </button>
                    <button onclick="setMode('single')" id="modeSingle" class="flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10">
                        <i class="fas fa-comment mr-1"></i>Frase √∫nica
                    </button>
                </div>
            </div>
        </div>

        <!-- √Årea de Grabaci√≥n -->
        <div class="glass-strong rounded-3xl p-6 sm:p-8">
            <!-- Visualizador de Audio -->
            <div class="flex items-end justify-center gap-[3px] h-16 mb-6" id="visualizer">
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
                <div class="audio-bar w-1.5 bg-indigo-500/30 rounded-full" style="height: 8px"></div>
            </div>

            <!-- Bot√≥n Principal -->
            <div class="flex flex-col items-center gap-4">
                <button id="recordBtn" onclick="toggleRecording()" class="recording-btn relative w-20 h-20 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-2xl hover:shadow-indigo-500/25 transition-all duration-300 active:scale-95 btn-glow">
                    <i id="recordIcon" class="fas fa-microphone text-2xl text-white"></i>
                </button>
                <p id="recordLabel" class="text-sm text-white/50">Toca para grabar</p>
                <p id="recordTime" class="text-xs text-white/30 hidden">00:00</p>
            </div>

            <!-- Texto en tiempo real (interim) -->
            <div id="interimBox" class="mt-6 hidden">
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-xs text-indigo-400 mb-1"><i class="fas fa-ear-listen mr-1"></i>Escuchando...</p>
                    <p id="interimText" class="text-white/70 text-sm italic"></p>
                </div>
            </div>
        </div>

        <!-- √Årea de Transcripci√≥n -->
        <div class="glass rounded-2xl p-4 sm:p-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm font-semibold text-white/70">
                    <i class="fas fa-file-lines mr-2 text-indigo-400"></i>Transcripci√≥n
                </h2>
                <div class="flex items-center gap-2">
                    <span id="charCount" class="text-xs text-white/30">0 caracteres</span>
                    <button onclick="copyText()" class="text-xs bg-white/5 hover:bg-white/10 text-white/50 hover:text-white/80 px-3 py-1.5 rounded-lg transition" title="Copiar">
                        <i class="fas fa-copy mr-1"></i>Copiar
                    </button>
                    <button onclick="clearText()" class="text-xs bg-white/5 hover:bg-red-500/20 text-white/50 hover:text-red-400 px-3 py-1.5 rounded-lg transition" title="Limpiar">
                        <i class="fas fa-trash mr-1"></i>
                    </button>
                </div>
            </div>
            <textarea id="transcription" class="w-full bg-black/30 border border-white/10 rounded-xl p-4 text-white/90 text-sm leading-relaxed resize-none custom-scroll transition min-h-[150px]" placeholder="La transcripci√≥n aparecer√° aqu√≠...&#10;&#10;Toca el bot√≥n del micr√≥fono para comenzar." rows="8"></textarea>
        </div>

        <!-- Informaci√≥n de Problemas Comunes -->
        <div class="glass rounded-2xl p-4 sm:p-6">
            <details class="group">
                <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-white/70 list-none">
                    <span><i class="fas fa-circle-question mr-2 text-amber-400"></i>¬øEl micr√≥fono no funciona? Soluciones comunes</span>
                    <i class="fas fa-chevron-down text-white/30 group-open:rotate-180 transition-transform"></i>
                </summary>
                <div class="mt-4 space-y-3 text-xs text-white/50 leading-relaxed">
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-lock text-green-400 mt-0.5"></i>
                        <div>
                            <p class="text-white/70 font-medium">1. HTTPS obligatorio</p>
                            <p>El micr√≥fono SOLO funciona en p√°ginas servidas por HTTPS (o localhost). Verifica que tu URL empiece con <code class="bg-white/10 px-1 rounded">https://</code></p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-shield-halved text-blue-400 mt-0.5"></i>
                        <div>
                            <p class="text-white/70 font-medium">2. Permisos del navegador</p>
                            <p>En m√≥viles: Ve a <strong>Configuraci√≥n del sitio</strong> en tu navegador y permite el acceso al micr√≥fono. En iOS Safari: Configuraci√≥n ‚Üí Safari ‚Üí Micr√≥fono ‚Üí Permitir.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-mobile-screen text-purple-400 mt-0.5"></i>
                        <div>
                            <p class="text-white/70 font-medium">3. iOS Safari (iPhone/iPad)</p>
                            <p>Safari en iOS tiene soporte LIMITADO para Web Speech API. Si no funciona, prueba con <strong>Chrome para iOS</strong> o usa el modo de escritura manual.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-ban text-red-400 mt-0.5"></i>
                        <div>
                            <p class="text-white/70 font-medium">4. Otra app usa el micr√≥fono</p>
                            <p>Cierra otras apps que puedan estar usando el micr√≥fono (llamadas, WhatsApp, Zoom, etc.)</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start bg-white/5 rounded-xl p-3">
                        <i class="fas fa-arrows-rotate text-cyan-400 mt-0.5"></i>
                        <div>
                            <p class="text-white/70 font-medium">5. Reiniciar permisos</p>
                            <p>Si denegaste el permiso antes: En Chrome ‚Üí candado en la barra de URL ‚Üí Permisos del sitio ‚Üí Micr√≥fono ‚Üí Permitir ‚Üí Recargar p√°gina.</p>
                        </div>
                    </div>
                </div>
            </details>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-xs text-white/20">
        Scribe Pro Fix Edition ¬∑ Diagn√≥stico de micr√≥fono integrado
    </footer>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let recognition = null;
        let isRecording = false;
        let currentMode = 'continuous';
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let animationId = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let fullTranscript = '';

        // ========================================
        // ELEMENTOS DOM
        // ========================================
        const $ = id => document.getElementById(id);
        const recordBtn = $('recordBtn');
        const recordIcon = $('recordIcon');
        const recordLabel = $('recordLabel');
        const recordTime = $('recordTime');
        const statusDot = $('statusDot');
        const statusText = $('statusText');
        const transcription = $('transcription');
        const interimBox = $('interimBox');
        const interimText = $('interimText');
        const charCount = $('charCount');
        const visualizer = $('visualizer');
        const bars = visualizer.querySelectorAll('.audio-bar');

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            checkSupport();
            transcription.addEventListener('input', updateCharCount);
        });

        function checkSupport() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                setStatus('unsupported', 'No soportado');
                showToast('Tu navegador no soporta reconocimiento de voz. Prueba Chrome.', 'error');
                recordBtn.disabled = true;
                recordBtn.classList.add('opacity-50');
                logDebug('‚ùå SpeechRecognition API no disponible', 'error');
                logDebug('Navigator: ' + navigator.userAgent, 'info');
                return;
            }

            // Verificar HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                logDebug('‚ö†Ô∏è No se est√° usando HTTPS. El micr√≥fono puede no funcionar.', 'warn');
            }

            setStatus('ready', 'Listo');
            logDebug('‚úÖ SpeechRecognition API disponible', 'success');
            initRecognition();
        }

        // ========================================
        // CONFIGURACI√ìN DEL RECONOCIMIENTO DE VOZ
        // ========================================
        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            const lang = $('langSelect').value;
            recognition.lang = lang;
            recognition.continuous = (currentMode === 'continuous');
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            logDebug(`üéôÔ∏è Configurado: lang=${lang}, continuous=${recognition.continuous}`, 'info');

            recognition.onstart = () => {
                logDebug('üü¢ recognition.onstart disparado', 'success');
                isRecording = true;
                setStatus('recording', 'Grabando...');
                recordBtn.classList.add('active');
                recordBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                recordIcon.className = 'fas fa-stop text-2xl text-white';
                recordLabel.textContent = 'Toca para detener';
                recordTime.classList.remove('hidden');
                startTimer();
            };

            recognition.onresult = (event) => {
                let interim = '';
                let final = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        final += transcript;
                        logDebug(`üìù Final: "${transcript}"`, 'success');
                    } else {
                        interim += transcript;
                    }
                }

                // Mostrar texto interim
                if (interim) {
                    interimBox.classList.remove('hidden');
                    interimText.textContent = interim;
                } else {
                    interimBox.classList.add('hidden');
                }

                // Agregar texto final
                if (final) {
                    const currentText = transcription.value;
                    const separator = currentText && !currentText.endsWith('\n') && !currentText.endsWith(' ') ? ' ' : '';
                    transcription.value = currentText + separator + final;
                    updateCharCount();
                    // Auto-scroll
                    transcription.scrollTop = transcription.scrollHeight;
                }
            };

            recognition.onerror = (event) => {
                logDebug(`‚ùå Error: ${event.error} - ${event.message || 'sin mensaje'}`, 'error');

                switch (event.error) {
                    case 'not-allowed':
                        showToast('Permiso de micr√≥fono denegado. Revisa la configuraci√≥n del navegador.', 'error');
                        setStatus('error', 'Sin permiso');
                        break;
                    case 'no-speech':
                        logDebug('‚ö†Ô∏è No se detect√≥ voz', 'warn');
                        // En modo continuo, reiniciar autom√°ticamente
                        if (currentMode === 'continuous' && isRecording) {
                            logDebug('üîÑ Reiniciando por no-speech...', 'info');
                            restartRecognition();
                            return;
                        }
                        break;
                    case 'audio-capture':
                        showToast('No se pudo capturar audio. ¬øHay micr√≥fono disponible?', 'error');
                        setStatus('error', 'Sin micr√≥fono');
                        break;
                    case 'network':
                        showToast('Error de red. Se necesita conexi√≥n a internet.', 'error');
                        setStatus('error', 'Sin red');
                        break;
                    case 'aborted':
                        logDebug('‚ö†Ô∏è Reconocimiento abortado', 'warn');
                        break;
                    default:
                        showToast(`Error: ${event.error}`, 'error');
                }

                if (event.error !== 'no-speech') {
                    stopRecordingUI();
                }
            };

            recognition.onend = () => {
                logDebug('üî¥ recognition.onend disparado', 'info');
                interimBox.classList.add('hidden');

                // Auto-restart en modo continuo si a√∫n queremos grabar
                if (isRecording && currentMode === 'continuous') {
                    logDebug('üîÑ Auto-reiniciando (modo continuo)...', 'info');
                    try {
                        setTimeout(() => {
                            if (isRecording) {
                                recognition.start();
                                logDebug('‚úÖ Reiniciado exitosamente', 'success');
                            }
                        }, 200);
                    } catch (e) {
                        logDebug(`‚ùå Error al reiniciar: ${e.message}`, 'error');
                        stopRecordingUI();
                    }
                } else {
                    stopRecordingUI();
                }
            };

            // Cambiar idioma cuando se seleccione otro
            $('langSelect').addEventListener('change', () => {
                const wasRecording = isRecording;
                if (wasRecording) stopRecording();
                initRecognition();
                if (wasRecording) {
                    setTimeout(() => startRecording(), 300);
                }
            });
        }

        function restartRecognition() {
            try {
                recognition.stop();
            } catch(e) {}
            setTimeout(() => {
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch(e) {
                        logDebug(`‚ùå Error reiniciando: ${e.message}`, 'error');
                        stopRecordingUI();
                    }
                }
            }, 300);
        }

        // ========================================
        // CONTROL DE GRABACI√ìN
        // ========================================
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            if (!recognition) {
                showToast('Reconocimiento de voz no disponible', 'error');
                return;
            }

            logDebug('üé¨ Intentando iniciar grabaci√≥n...', 'info');

            // PASO 1: Solicitar permiso de micr√≥fono PRIMERO con getUserMedia
            // Esto es CRUCIAL para m√≥viles - fuerza el di√°logo de permisos
            try {
                logDebug('üì± Solicitando getUserMedia para permisos...', 'info');
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                logDebug('‚úÖ getUserMedia exitoso - micr√≥fono permitido', 'success');

                // Configurar visualizador de audio
                setupAudioVisualizer(mediaStream);

            } catch (err) {
                logDebug(`‚ùå getUserMedia fall√≥: ${err.name} - ${err.message}`, 'error');

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    showToast('Permiso de micr√≥fono denegado. Permite el acceso en la configuraci√≥n del navegador.', 'error');
                    setStatus('error', 'Permiso denegado');
                } else if (err.name === 'NotFoundError') {
                    showToast('No se encontr√≥ ning√∫n micr√≥fono en este dispositivo.', 'error');
                    setStatus('error', 'Sin micr√≥fono');
                } else if (err.name === 'NotReadableError') {
                    showToast('El micr√≥fono est√° siendo usado por otra aplicaci√≥n.', 'error');
                    setStatus('error', 'Micr√≥fono ocupado');
                } else {
                    showToast(`Error al acceder al micr√≥fono: ${err.message}`, 'error');
                    setStatus('error', 'Error');
                }
                return;
            }

            // PASO 2: Iniciar reconocimiento de voz
            try {
                // Reconfigurar recognition con los ajustes actuales
                recognition.lang = $('langSelect').value;
                recognition.continuous = (currentMode === 'continuous');
                recognition.interimResults = true;

                isRecording = true; // Marcar ANTES de start() para que onend sepa qu√© hacer
                recognition.start();
                logDebug('‚úÖ recognition.start() llamado', 'success');
            } catch (err) {
                logDebug(`‚ùå recognition.start() fall√≥: ${err.message}`, 'error');
                isRecording = false;
                showToast(`Error al iniciar: ${err.message}`, 'error');
                cleanupAudio();
            }
        }

        function stopRecording() {
            logDebug('‚èπÔ∏è Deteniendo grabaci√≥n...', 'info');
            isRecording = false;

            try {
                recognition.stop();
            } catch(e) {
                logDebug(`‚ö†Ô∏è Error al detener recognition: ${e.message}`, 'warn');
            }

            cleanupAudio();
            stopRecordingUI();
        }

        function stopRecordingUI() {
            isRecording = false;
            setStatus('ready', 'Listo');
            recordBtn.classList.remove('active');
            recordBtn.style.background = 'linear-gradient(135deg, #6366f1, #9333ea)';
            recordIcon.className = 'fas fa-microphone text-2xl text-white';
            recordLabel.textContent = 'Toca para grabar';
            interimBox.classList.add('hidden');
            stopTimer();
            resetVisualizer();
        }

        // ========================================
        // VISUALIZADOR DE AUDIO
        // ========================================
        function setupAudioVisualizer(stream) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 64;

                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function animate() {
                    if (!isRecording) return;
                    analyser.getByteFrequencyData(dataArray);

                    bars.forEach((bar, i) => {
                        const value = dataArray[i % dataArray.length] || 0;
                        const height = Math.max(4, (value / 255) * 60);
                        bar.style.height = height + 'px';
                        bar.style.background = value > 128
                            ? `rgba(239, 68, 68, ${0.5 + value/510})`
                            : `rgba(99, 102, 241, ${0.3 + value/510})`;
                    });

                    animationId = requestAnimationFrame(animate);
                }
                animate();
                logDebug('‚úÖ Visualizador de audio configurado', 'success');
            } catch(e) {
                logDebug(`‚ö†Ô∏è Visualizador no disponible: ${e.message}`, 'warn');
            }
        }

        function resetVisualizer() {
            bars.forEach(bar => {
                bar.style.height = '8px';
                bar.style.background = 'rgba(99, 102, 241, 0.3)';
            });
        }

        function cleanupAudio() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                logDebug('üîá Stream de audio liberado', 'info');
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().catch(() => {});
                audioContext = null;
            }
        }

        // ========================================
        // TIMER
        // ========================================
        function startTimer() {
            recordingSeconds = 0;
            updateTimerDisplay();
            recordTime.classList.remove('hidden');
            recordingTimer = setInterval(() => {
                recordingSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() {
            clearInterval(recordingTimer);
            recordingTimer = null;
            recordTime.classList.add('hidden');
            recordingSeconds = 0;
        }

        function updateTimerDisplay() {
            const min = String(Math.floor(recordingSeconds / 60)).padStart(2, '0');
            const sec = String(recordingSeconds % 60).padStart(2, '0');
            recordTime.textContent = `${min}:${sec}`;
        }

        // ========================================
        // MODO DE TRANSCRIPCI√ìN
        // ========================================
        function setMode(mode) {
            currentMode = mode;
            const wasRecording = isRecording;

            $('modeContinuous').className = mode === 'continuous'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30'
                : 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10';
            $('modeSingle').className = mode === 'single'
                ? 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-indigo-500/30 text-indigo-300 border border-indigo-500/30'
                : 'flex-1 py-2.5 rounded-xl text-sm font-medium transition bg-white/5 text-white/50 border border-white/10';

            if (wasRecording) {
                stopRecording();
                setTimeout(() => {
                    initRecognition();
                    startRecording();
                }, 500);
            } else {
                initRecognition();
            }

            logDebug(`‚öôÔ∏è Modo cambiado a: ${mode}`, 'info');
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function setStatus(type, text) {
            statusDot.className = `status-dot ${type}`;
            statusText.textContent = text;
        }

        function updateCharCount() {
            const len = transcription.value.length;
            charCount.textContent = `${len} caracter${len !== 1 ? 'es' : ''}`;
        }

        function copyText() {
            const text = transcription.value;
            if (!text) {
                showToast('No hay texto para copiar', 'warn');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showToast('Texto copiado al portapapeles', 'success');
            }).catch(() => {
                // Fallback para navegadores que no soportan clipboard API
                transcription.select();
                document.execCommand('copy');
                showToast('Texto copiado', 'success');
            });
        }

        function clearText() {
            if (transcription.value && !confirm('¬øBorrar toda la transcripci√≥n?')) return;
            transcription.value = '';
            updateCharCount();
        }

        // ========================================
        // TOAST NOTIFICATIONS
        // ========================================
        let toastTimeout = null;
        function showToast(msg, type = 'info') {
            const toast = $('toast');
            const icon = $('toast-icon');
            const msgEl = $('toast-msg');

            const icons = {
                info: 'fas fa-info-circle text-blue-400',
                success: 'fas fa-check-circle text-green-400',
                error: 'fas fa-exclamation-circle text-red-400',
                warn: 'fas fa-triangle-exclamation text-amber-400'
            };

            icon.className = icons[type] || icons.info;
            msgEl.textContent = msg;

            clearTimeout(toastTimeout);
            toast.classList.add('show');
            toastTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // ========================================
        // PANEL DE DEBUG
        // ========================================
        function toggleDebug() {
            $('debugPanel').classList.toggle('hidden');
        }

        function logDebug(msg, type = 'info') {
            const log = $('debugLog');
            const colors = {
                info: 'text-blue-300',
                success: 'text-green-400',
                error: 'text-red-400',
                warn: 'text-amber-400'
            };
            const time = new Date().toLocaleTimeString();
            const p = document.createElement('p');
            p.className = colors[type] || 'text-white/60';
            p.textContent = `[${time}] ${msg}`;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;

            // Tambi√©n log en consola
            console.log(`[ScribePro] ${msg}`);
        }

        async function runDiagnostics() {
            const log = $('debugLog');
            log.innerHTML = '';

            logDebug('=== DIAGN√ìSTICO COMPLETO ===', 'info');
            logDebug(`üì± User Agent: ${navigator.userAgent}`, 'info');
            logDebug(`üîí Protocolo: ${location.protocol}`, location.protocol === 'https:' ? 'success' : 'warn');
            logDebug(`üåê Host: ${location.hostname}`, 'info');

            // Detectar plataforma
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);

            logDebug(`üì± Plataforma: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`, 'info');
            logDebug(`üåê Navegador: ${isSafari ? 'Safari' : isChrome ? 'Chrome' : 'Otro'}`, 'info');

            // Verificar APIs
            const hasSpeechRecognition = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
            logDebug(`üé§ SpeechRecognition: ${hasSpeechRecognition ? 'S√ç' : 'NO'}`, hasSpeechRecognition ? 'success' : 'error');

            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            logDebug(`üìπ getUserMedia: ${hasGetUserMedia ? 'S√ç' : 'NO'}`, hasGetUserMedia ? 'success' : 'error');

            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            logDebug(`üîä AudioContext: ${hasAudioContext ? 'S√ç' : 'NO'}`, hasAudioContext ? 'success' : 'error');

            // Verificar permisos
            if (navigator.permissions) {
                try {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    logDebug(`üîê Permiso micr√≥fono: ${result.state}`, result.state === 'granted' ? 'success' : result.state === 'denied' ? 'error' : 'warn');
                } catch(e) {
                    logDebug(`‚ö†Ô∏è No se pudo verificar permisos: ${e.message}`, 'warn');
                }
            } else {
                logDebug('‚ö†Ô∏è Permissions API no disponible', 'warn');
            }

            // Intentar acceder al micr√≥fono
            if (hasGetUserMedia) {
                try {
                    logDebug('üéôÔ∏è Probando acceso al micr√≥fono...', 'info');
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const tracks = stream.getAudioTracks();
                    logDebug(`‚úÖ Micr√≥fono accesible: ${tracks[0].label}`, 'success');
                    logDebug(`  Estado: ${tracks[0].readyState}, Habilitado: ${tracks[0].enabled}`, 'info');
                    // Enumerar dispositivos
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(d => d.kind === 'audioinput');
                    logDebug(`üé§ Dispositivos de audio encontrados: ${audioInputs.length}`, 'info');
                    audioInputs.forEach((d, i) => {
                        logDebug(`  ${i+1}. ${d.label || 'Sin nombre'} (${d.deviceId.slice(0,8)}...)`, 'info');
                    });
                    stream.getTracks().forEach(t => t.stop());
                } catch(e) {
                    logDebug(`‚ùå Error accediendo al micr√≥fono: ${e.name} - ${e.message}`, 'error');

                    if (e.name === 'NotAllowedError') {
                        logDebug('üëÜ SOLUCI√ìN: Permite el micr√≥fono en la configuraci√≥n del navegador', 'warn');
                    }
                }
            }

            // Advertencias espec√≠ficas por plataforma
            if (isIOS && isSafari) {
                logDebug('', 'info');
                logDebug('‚ö†Ô∏è NOTA iOS Safari:', 'warn');
                logDebug('  - Web Speech API tiene soporte limitado', 'warn');
                logDebug('  - Aseg√∫rate de que Safari tenga permiso de micr√≥fono', 'warn');
                logDebug('  - Ve a: Configuraci√≥n ‚Üí Safari ‚Üí Micr√≥fono', 'warn');
            }

            if (isIOS && isChrome) {
                logDebug('', 'info');
                logDebug('‚ÑπÔ∏è NOTA Chrome en iOS:', 'info');
                logDebug('  - Chrome en iOS usa WebKit internamente', 'info');
                logDebug('  - Las limitaciones de Safari tambi√©n aplican', 'warn');
            }

            logDebug('', 'info');
            logDebug('=== FIN DEL DIAGN√ìSTICO ===', 'info');
        }
    </script>

</body>
</html>
